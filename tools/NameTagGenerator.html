<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Compass Name Tag Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --tag-w: 93mm; --tag-h: 57mm;
            --compass: 'https://compassoffices.github.io/img/poster-compass-logo.png';
        }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background:#f0f4f8; padding:20px; }
        .container { max-width:1100px; margin:auto; background:#fff; padding:30px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.12); }
        h1 { text-align:center; color:#1a3c6d; font-size:28px; margin-bottom:8px; }
        .subtitle { text-align:center; color:#555; font-size:15px; margin-bottom:20px; }
        .info { background:#e6f7ff; padding:14px; border-radius:10px; font-family:monospace; font-size:13px; margin-bottom:20px; word-break:break-all; }
        .controls { text-align:center; margin:25px 0; }
        button { background:#1a3c6d; color:#fff; border:none; padding:14px 30px; margin:0 8px; font-size:16px; border-radius:8px; cursor:pointer; font-weight:600; transition:.3s; }
        button:hover { background:#0f2a4d; transform:translateY(-2px); box-shadow:0 4px 12px rgba(26,60,109,.3); }
        .loading { display:none; text-align:center; margin:20px; color:#1a3c6d; font-weight:600; }

        /* A4 Page */
        .a4-page {
            width:210mm; height:297mm; background:#fff; padding:12mm 10mm; page-break-after:always;
            display:grid; grid-template-columns:repeat(2,1fr); grid-template-rows:repeat(5,1fr);
            gap:6mm; box-shadow:0 6px 25px rgba(0,0,0,.15); margin:20px auto;
        }

        /* Name Tag */
        .tag {
            width:var(--tag-w); height:var(--tag-h); background:#fff; border-radius:8px;
            overflow:hidden; position:relative; box-shadow:0 3px 12px rgba(0,0,0,.1);
            display:flex; flex-direction:column;
        }
        .tag-bg {
            position:absolute; inset:0; background-size:cover; background-position:center;
            z-index:0; filter:brightness(1.05);
        }
        .tag-bg::after {
            content:''; position:absolute; inset:0;
            background:linear-gradient(135deg, rgba(255,255,255,.94) 0%, rgba(255,255,255,.80) 100%);
            z-index:1;
        }

        .tag-content { position:relative; z-index:2; flex-grow:1; display:flex; flex-direction:column; padding:10px 8px 0; }

        /* Name Area */
        .name-area { flex-grow:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; gap:3px; padding:4px 0; }
        .name-en { color:#1a3c6d; font-weight:700; font-size:18px; line-height:1.3; }
        .name-other { color:#1a3c6d; font-weight:700; font-size:26px; line-height:1.3; }

        /* White Logo Bar */
        .logo-bar {
            height:12mm; background:#fff; border-top:1px solid #e0e0e0;
            display:flex; align-items:center; justify-content:flex-start; padding:0 6mm; gap:6mm;
            z-index:3;
        }
        .logo-item { height:9mm; max-width:22mm; object-fit:contain; }
        .compass-logo { height:9mm; width:auto; object-fit:contain; }

        @media print {
            body,* { background:#fff !important; padding:0 !important; margin:0 !important; }
            .container, .controls, .info, .loading { display:none !important; }
            .a4-page { box-shadow:none; margin:0; padding:12mm 10mm; page-break-after:always; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Compass Name Tag Generator</h1>
    <p class="subtitle">9.3cm × 5.7cm • Bilingual • White Logo Bar</p>
    <div class="info" id="info">Loading...</div>
    <div class="controls">
        <button id="jpgBtn">Download 300 DPI JPG (ZIP)</button>
        <button id="pdfBtn">Download PDF</button>
        <button id="printBtn">Print</button>
    </div>
    <div class="loading" id="loading">Generating...</div>
    <div id="pages"></div>
</div>

<script>
    const COMPASS = 'https://compassoffices.github.io/img/poster-compass-logo.png';

    function getParams() {
        const p = new URLSearchParams(location.search);
        const bg = p.get('bg') || '';
        const tags = [];
        let i = 0;
        while (p.has(`name${i}`) || p.has(`logo1${i}`) || p.has(`logo2${i}`)) {
            const name = p.get(`name${i}`) || '';
            tags.push({
                name, logo1: p.get(`logo1${i}`)||'', logo2: p.get(`logo2${i}`)||''
            });
            i++;
        }
        return { bg, tags };
    }

    function splitName(name) {
        const parts = name.split('/').map(s => s.trim()).filter(Boolean);
        if (parts.length < 2) return { en: '', other: name };
        const en = parts.find(p => /[a-zA-Z]/.test(p)) || parts[1];
        const other = parts.find(p => !/[a-zA-Z]/.test(p)) || parts[0];
        return { en, other };
    }

    function createTag(data, globalBg) {
        const tag = document.createElement('div'); tag.className = 'tag';
        const { name, logo1, logo2 } = data;
        const { en, other } = splitName(name);

        // Full background
        const bg = document.createElement('div'); bg.className = 'tag-bg';
        if (globalBg) bg.style.backgroundImage = `url('${globalBg}')`;
        tag.appendChild(bg);

        // Content
        const content = document.createElement('div'); content.className = 'tag-content';

        // Name: English on TOP
        const nameArea = document.createElement('div'); nameArea.className = 'name-area';
        if (en) {
            const enLine = document.createElement('div'); enLine.className = 'name-en';
            enLine.textContent = en; nameArea.appendChild(enLine);
        }
        if (other) {
            const otherLine = document.createElement('div'); otherLine.className = 'name-other';
            otherLine.textContent = other; nameArea.appendChild(otherLine);
        }
        if (!en && !other) {
            const line = document.createElement('div'); line.className = 'name-other';
            line.textContent = 'Your Name'; nameArea.appendChild(line);
        }
        content.appendChild(nameArea);

        // WHITE LOGO BAR: [Logo1] [Logo2] [Compass]
        const bar = document.createElement('div'); bar.className = 'logo-bar';

        [logo1, logo2].forEach(src => {
            if (!src) return;
            const img = new Image(); img.crossOrigin = 'anonymous'; img.src = src;
            img.className = 'logo-item';
            bar.appendChild(img);
        });

        const compass = new Image(); compass.crossOrigin = 'anonymous'; compass.src = COMPASS;
        compass.className = 'logo-item compass-logo';
        bar.appendChild(compass);

        content.appendChild(bar);
        tag.appendChild(content);
        return tag;
    }

    function layout(tags, bg) {
        const container = document.getElementById('pages');
        container.innerHTML = '';
        const perPage = 10;
        for (let i = 0; i < tags.length; i += perPage) {
            const page = document.createElement('div'); page.className = 'a4-page';
            const slice = tags.slice(i, i + perPage);
            slice.forEach(t => page.appendChild(createTag(t, bg)));
            while (page.children.length < perPage) {
                const dummy = document.createElement('div'); dummy.style.visibility = 'hidden';
                page.appendChild(dummy);
            }
            container.appendChild(page);
        }
    }

    async function exportJPG() {
        const loading = document.getElementById('loading'); loading.style.display = 'block';
        const pages = document.querySelectorAll('.a4-page');
        const zip = new JSZip();
        const scale = 300 / 96;

        for (let i = 0; i < pages.length; i++) {
            const canvas = await html2canvas(pages[i], { scale, useCORS: true, backgroundColor: '#fff' });
            zip.file(`page_${i+1}.jpg`, canvas.toDataURL('image/jpeg', 1.0).split(',')[1], { base64: true });
        }
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = 'name-tags-300dpi.zip'; a.click();
        loading.style.display = 'none';
    }

    async function exportPDF() {
        const loading = document.getElementById('loading'); loading.style.display = 'block';
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pages = document.querySelectorAll('.a4-page');
        for (let i = 0; i < pages.length; i++) {
            if (i) pdf.addPage();
            const canvas = await html2canvas(pages[i], { scale: 2, useCORS: true });
            pdf.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, 210, 297);
        }
        pdf.save('name-tags.pdf');
        loading.style.display = 'none';
    }

    // Init
    const { bg, tags } = getParams();
    if (!tags.length) {
        document.getElementById('info').innerHTML = `
            <strong>Example:</strong><br>
            ?bg=https://images.unsplash.com/...<br>
            &name0=李娜 / Lina<br>
            &logo10=https://img.freepik.com/...
        `;
    } else {
        document.getElementById('info').textContent = `${tags.length} tags • Background: ${bg?'Yes':'No'}`;
        layout(tags, bg);
    }

    document.getElementById('jpgBtn').onclick = exportJPG;
    document.getElementById('pdfBtn').onclick = exportPDF;
    document.getElementById('printBtn').onclick = () => window.print();
</script>
</body>
</html>
