<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compass Offices Client Logo Layout Editor</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-primary: 'SF Pro Display', sans-serif;
      --bg-color: #f5f5f7;
      --container-bg: #ffffff;
      --border-radius: 12px;
      --text-main: #1d1d1f;
    }
    body {
      font-family: var(--font-primary);
      background: var(--bg-color);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
      text-align: center;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: var(--container-bg);
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .button {
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      background: #ff6600;
      color: white;
    }
    .button:hover {
      background: #cc5200;
    }
    .button-black {
      background: #000;
      color: #fff;
    }
    .button-black:hover {
      background: #333;
    }
    select, label, input[type="text"] {
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
    }
    input[type="text"] {
      width: 300px;
    }
    input[type="checkbox"] {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1.5px solid rgba(0, 123, 255, 0.8);
      background-color: transparent;
      backdrop-filter: blur(6px);
      cursor: pointer;
      position: relative;
      transition: background 0.2s ease;
    }
    input[type="checkbox"]:checked {
      background-color: rgba(0, 123, 255, 0.15);
    }
    input[type="checkbox"]:checked::after {
      content: '✔';
      color: rgba(0, 123, 255, 1);
      font-size: 10px;
      font-weight: bold;
      position: absolute;
      top: 0;
      left: 3px;
    }
    .industry-group {
      text-align: left;
      margin-bottom: 30px;
      position: relative;
    }
    .industry-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      padding-left: 5px;
    }
    .divider {
      height: 1px;
      background-color: #ff6600;
      margin: 10px 0;
      border-radius: 1px;
    }
    .hide-divider .divider {
      display: none;
    }
    .client-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .client-logo {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: horizontal;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
      max-width: 300px;
      width: 100px;
      height: 100px;
      position: relative;
    }
    .image-wrapper {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .client-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transform: scale(1);
      transition: transform 0.2s ease;
      pointer-events: none;
      z-index: 1;
    }
    .client-name {
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: #333;
      background: rgba(255, 255, 255, 0.85);
      padding: 2px 6px;
      border-radius: 4px;
      display: none;
      z-index: 30;
    }
    .client-logo:hover .client-name {
      display: block;
    }
    .checkbox-container {
      position: absolute;
      top: 0;
      right: 0;
      margin: 4px;
      padding: 2px;
      z-index: 10;
    }
    .preview .client-logo {
      border: none !important;
      resize: none !important;
    }
    .preview .checkbox-container,
    .preview .client-name,
    .preview .scale-btn {
      display: none !important;
    }
    .client-logo.dragging {
      opacity: 0.4;
    }
    .scale-btn {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(6px);
      color: #000;
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 50%;
      font-size: 14px;
      font-weight: bold;
      width: 20px;
      height: 20px;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      transition: background 0.2s ease;
      position: absolute;
      z-index: 40;
    }
    .scale-btn:hover {
      background: rgba(255, 255, 255, 0.6);
    }
    .scale-btn.plus {
      bottom: 6px;
      left: 6px;
    }
    .scale-btn.minus {
      bottom: 6px;
      right: 6px;
    }
    #clientsSection {
      resize: both;
      overflow: auto;
      min-height: 400px;
      max-height: 90vh;
      width: 100%;
      max-width: 100%;
      margin-top: 20px;
      padding: 20px;
      box-sizing: border-box;
    }
    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="controls">
    <!-- Controls (unchanged) -->
    <select id="industrySelect">
      <option value="all">All Groups</option>
      <option value="finance">Finance</option>
      <option value="tech">Technology</option>
      <option value="retail">Retail</option>
      <option value="logistics">Logistics</option>
    </select>

    <label><input type="checkbox" id="toggleHidden" onchange="toggleHiddenLogos()" /> Show Hidden Logos</label>
    <label><input type="checkbox" id="toggleSectorTitles" checked onchange="toggleSectorTitles()" /> Show All Sectors</label>
    <label><input type="checkbox" id="toggleDividers" checked onchange="toggleDividers()" /> Hide Sector Dividers</label>

    <button class="button" id="toggleModeBtn" onclick="togglePreview()">Generate</button>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSefa4jK8eSB8feq2D_qN5pPSaACFWpnwlZoTVAtSconDBOeRA/viewform" target="_blank" class="button button-black">Submit Logo</a>
  </div>

  <div style="margin-top: 20px;">
    <button class="button" onclick="generateLayoutCode()">Generate Layout Code</button>
    <input type="text" id="layoutCodeInput" placeholder="Paste layout code here" />
    <button class="button button-black" onclick="loadLayoutCode()">Load Layout</button>
  </div>
</div>

<div class="container" id="clientsSection">
  <div class="industry-group" id="group-finance">
    <div class="industry-title">Finance</div>
    <div class="divider"></div>
    <div class="client-list" id="financeList"></div>
  </div>
  <div class="industry-group" id="group-tech">
    <div class="industry-title">Technology</div>
    <div class="divider"></div>
    <div class="client-list" id="techList"></div>
  </div>
  <div class="industry-group" id="group-retail">
    <div class="industry-title">Retail</div>
    <div class="divider"></div>
    <div class="client-list" id="retailList"></div>
  </div>
  <div class="industry-group" id="group-logistics">
    <div class="industry-title">Logistics</div>
    <div class="divider"></div>
    <div class="client-list" id="logisticsList"></div>
  </div>
</div>

<script>
  const hiddenLogos = new Set();
  let pendingLayoutCode = null;

  function togglePreview() {
    const section = document.getElementById("clientsSection");
    section.classList.toggle("preview");
    document.getElementById("toggleModeBtn").textContent = section.classList.contains("preview") ? "Release" : "Generate";
    document.querySelectorAll('.client-toggle').forEach(cb => cb.disabled = section.classList.contains("preview"));
  }

  function toggleSectorTitles() {
    document.querySelectorAll(".industry-title").forEach(title => {
      title.style.display = document.getElementById("toggleSectorTitles").checked ? "block" : "none";
    });
  }

  function toggleDividers() {
    const hide = !document.getElementById("toggleDividers").checked;
    document.querySelectorAll(".industry-group").forEach(group => group.classList.toggle("hide-divider", hide));
  }

  function toggleLogo(index) {
    const logo = document.getElementById(`logo-${index}`);
    const checkbox = logo.querySelector('.client-toggle');
    const showHidden = document.getElementById("toggleHidden").checked;
    if (checkbox.checked) {
      hiddenLogos.delete(index);
      logo.style.display = "flex";
    } else {
      hiddenLogos.add(index);
      logo.style.display = showHidden ? "flex" : "none";
    }
  }

  function toggleHiddenLogos() {
    const showHidden = document.getElementById("toggleHidden").checked;
    hiddenLogos.forEach(index => {
      const logo = document.getElementById(`logo-${index}`);
      if (logo) logo.style.display = showHidden ? "flex" : "none";
    });
  }

  document.getElementById("industrySelect").addEventListener("change", function () {
    const value = this.value;
    ["finance", "tech", "retail", "logistics"].forEach(id => {
      document.getElementById(`group-${id}`).style.display = (value === "all" || value === id) ? "block" : "none";
    });
  });

  function makeDraggable(containerId) {
    const container = document.getElementById(containerId);
    let dragged;
    container.addEventListener("dragstart", e => {
      if (e.target.classList.contains("client-logo")) {
        dragged = e.target;
        e.target.classList.add("dragging");
      }
    });
    container.addEventListener("dragover", e => {
      e.preventDefault();
      const target = e.target.closest(".client-logo");
      if (target && target !== dragged) {
        const rect = target.getBoundingClientRect();
        const next = (e.clientX - rect.left) / rect.width > 0.5;
        container.insertBefore(dragged, next ? target.nextSibling : target);
      }
    });
    container.addEventListener("dragend", e => e.target.classList.remove("dragging"));
  }

  function zoomImage(img, delta) {
    const current = parseFloat(img.dataset.scale || "1");
    let newScale = Math.min(5, Math.max(0.1, current + delta));
    img.dataset.scale = newScale.toFixed(2);
    img.style.transform = `scale(${newScale})`;
  }

  function generateLayoutCode() {
    const layout = [];
    const sectors = ["finance", "tech", "retail", "logistics"];
    sectors.forEach(sector => {
      const container = document.getElementById(sector + "List");
      const logos = container.querySelectorAll(".client-logo");
      logos.forEach(logo => {
        const id = logo.id.replace("logo-", "");
        const scale = parseFloat(logo.querySelector("img").dataset.scale || "1").toFixed(2);
        const visible = logo.querySelector(".client-toggle").checked ? 1 : 0;
        layout.push(`${sector}:${id}:${scale}:${visible}`);
      });
    });

    const clientsSection = document.getElementById("clientsSection");
    const width = clientsSection.offsetWidth;
    const height = clientsSection.offsetHeight;
    const sizePrefix = `size:${width}x${height}|`;

    const code = sizePrefix + layout.join(",");
    prompt("Copy your layout code:", code);
  }

  function loadLayoutCode() {
    const code = document.getElementById("layoutCodeInput").value.trim();
    if (!code) return alert("Please paste a layout code.");
    pendingLayoutCode = code;
    if (window._logosLoaded) applyLayoutCode(code);
  }

  function applyLayoutCode(code) {
    const [meta, data] = code.split("|");
    if (!meta.startsWith("size:")) return alert("Invalid layout code format.");

    const size = meta.replace("size:", "").split("x");
    const width = parseInt(size[0]);
    const height = parseInt(size[1]);

    const clientsSection = document.getElementById("clientsSection");
    clientsSection.style.width = width + "px";
    clientsSection.style.height = height + "px";

    const entries = data.split(",");
    const layout = entries.map(entry => {
      const [sector, id, scale, visible] = entry.split(":");
      return { sector, id, scale: parseFloat(scale), visible: visible === "1" };
    });

    const sectorMap = {
      finance: [],
      tech: [],
      retail: [],
      logistics: []
    };

    layout.forEach(({ sector, id, scale, visible }) => {
      const logo = document.getElementById(`logo-${id}`);
      if (!logo) return;
      const img = logo.querySelector("img");
      img.dataset.scale = scale;
      img.style.transform = `scale(${scale})`;
      const checkbox = logo.querySelector(".client-toggle");
      checkbox.checked = visible;
      logo.style.display = visible ? "flex" : "none";
      sectorMap[sector]?.push(logo);
    });

    Object.entries(sectorMap).forEach(([sector, logos]) => {
      const container = document.getElementById(sector + "List");
      if (container) {
        container.innerHTML = "";
        logos.forEach(logo => container.appendChild(logo));
      }
    });

    alert("Layout restored from code.");
  }

  async function fetchClientData() {
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaKv9U3pyL8aUtQ-7h7gnB0KJxCf_1QJFtEpLRnltip2cGDcxtClNyikvbYBlboD7D0n6dAfccYvth/pubhtml";
    const res = await fetch(SHEET_URL);
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, "text/html");
    const rows = [...doc.querySelectorAll("table tr")].slice(1);
    const industries = { finance: [], tech: [], retail: [], logistics: [] };

    rows.forEach((row, index) => {
      const cells = row.querySelectorAll("td");
      if (cells.length < 5) return;
      const logoURL = cells[2].textContent.trim();
      const name = cells[3].textContent.trim();
      const industry = cells[4].textContent.toLowerCase();
      const match = logoURL.match(/id=([a-zA-Z0-9_-]+)/);
      if (!match) return;
      const fileId = match[1];
      const imgSrc = `https://lh3.google.com/u/1/d/${fileId}=k`;

      const logoHTML = `
        <div class="client-logo" id="logo-${index}" draggable="true">
          <div class="checkbox-container">
            <input type="checkbox" class="client-toggle" checked onchange="toggleLogo(${index})" />
          </div>
          <div class="image-wrapper">
            <button class="scale-btn plus" onclick="zoomImage(this.closest('.client-logo').querySelector('img'), 0.1)">+</button>
            <button class="scale-btn minus" onclick="zoomImage(this.closest('.client-logo').querySelector('img'), -0.1)">−</button>
            <img src="${imgSrc}" alt="Logo" data-scale="1" />
          </div>
          <div class="client-name">${name}</div>
        </div>`;

      if (industry.includes("finance")) industries.finance.push(logoHTML);
      else if (industry.includes("tech")) industries.tech.push(logoHTML);
      else if (industry.includes("retail")) industries.retail.push(logoHTML);
      else industries.logistics.push(logoHTML);
    });

    document.getElementById("financeList").innerHTML = industries.finance.join('');
    document.getElementById("techList").innerHTML = industries.tech.join('');
    document.getElementById("retailList").innerHTML = industries.retail.join('');
    document.getElementById("logisticsList").innerHTML = industries.logistics.join('');

    ["financeList", "techList", "retailList", "logisticsList"].forEach(makeDraggable);

    window._logosLoaded = true;

    if (pendingLayoutCode) {
      applyLayoutCode(pendingLayoutCode);
      pendingLayoutCode = null;
    }
  }

  fetchClientData();
</script>

</body>
</html>
