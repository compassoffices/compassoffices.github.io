<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compass Collage Maker</title>
  <link rel="icon" type="image/png" href="https://www.compassoffices.com/wp-content/uploads/2025/09/compassoffices-logo-web-2025_icon-o-scaled.png">
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100%;
        }
        .header {
            background: #000000;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #333333;
        }
        .logo {
            height: 60px;
            margin-bottom: 10px;
        }
        .title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }
        .sidebar {
            width: 300px;
            background: #1a1a1a;
            padding: 20px;
            border-right: 2px solid #333333;
            overflow-y: auto;
        }
        .section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ff6600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        /* URL Input Group */
        .url-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .url-input {
            flex: 1;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 0.85rem;
        }
        .url-input::placeholder {
            color: #888;
        }
        .url-input:focus {
            outline: none;
            border-color: #ff6600;
        }
        .add-url-btn {
            padding: 10px 14px;
            background: #ff6600;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .add-url-btn:hover {
            background: #e55a00;
        }
        .url-error {
            color: #ff4444;
            font-size: 0.75rem;
            margin-top: 5px;
            display: none;
        }
        .upload-zone {
            border: 2px dashed #666666;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background: #2a2a2a;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .upload-zone:hover {
            border-color: #ff6600;
            background: #333333;
        }
        .upload-zone.dragover {
            border-color: #ff6600;
            background: #333333;
        }
        .upload-text {
            color: #cccccc;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .upload-hint {
            color: #888888;
            font-size: 0.8rem;
        }
        .image-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .image-item {
            display: flex;
            align-items: center;
            background: #2a2a2a;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #444444;
            cursor: grab;
        }
        .image-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        .image-name {
            flex: 1;
            font-size: 0.8rem;
            color: #cccccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .order-btn {
            background: #666;
            color: white;
            border: none;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            margin: 0 2px;
        }
        .order-btn:hover { background: #888; }
        .remove-btn {
            background: #ff6600;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .remove-btn:hover {
            background: #e55a00;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-label {
            font-size: 0.9rem;
            color: #cccccc;
            font-weight: 500;
        }
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #444444;
            outline: none;
            -webkit-appearance: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff6600;
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff6600;
            cursor: pointer;
            border: none;
        }
        .btn {
            padding: 12px 20px;
            background: #ff6600;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #e55a00;
        }
        .btn:disabled {
            background: #666666;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #666666;
        }
        .btn-secondary:hover {
            background: #777777;
        }
        .canvas-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111111;
            position: relative;
            overflow: hidden;
        }
        .canvas-container {
            position: relative;
            border: 2px solid #333333;
            border-radius: 8px;
            overflow: hidden;
            background: #ffffff;
        }
        #collageCanvas {
            display: block;
            cursor: crosshair;
        }
        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6600;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nw-resize;
            pointer-events: all;
            transform: translate(-50%, -50%);
        }
        .image-box {
            position: absolute;
            border: 2px dashed #ff6600;
            background: rgba(255, 102, 0, 0.1);
            cursor: move;
            pointer-events: all;
            user-select: none;
        }
        .image-box.selected {
            border-color: #ff6600;
            background: rgba(255, 102, 0, 0.2);
        }
        .image-box:has(.image-box-image) {
            cursor: grab;
        }
        .image-box:active:has(.image-box-image) {
            cursor: grabbing;
        }
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #666666;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .zoom-btn:hover {
            background: rgba(255, 102, 0, 0.8);
        }
        .layout-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }
        .layout-btn {
            padding: 10px 12px;
            background: #2a2a2a;
            color: #cccccc;
            border: 1px solid #444444;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .layout-btn:hover {
            border-color: #ff6600;
            background: #333333;
        }
        .layout-btn.active {
            border-color: #ff6600;
            background: #ff6600;
            color: white;
        }
        .layout-adjustments {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444444;
        }
        .adjustment-title {
            font-size: 0.9rem;
            color: #ff6600;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .adjustment-control {
            margin-bottom: 15px;
        }
        .adjustment-label {
            font-size: 0.8rem;
            color: #cccccc;
            margin-bottom: 5px;
            display: block;
        }
        .adjustment-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #444444;
            outline: none;
            -webkit-appearance: none;
        }
        .adjustment-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ff6600;
            cursor: pointer;
        }
        .adjustment-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ff6600;
            cursor: pointer;
            border: none;
        }
        .rotate-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .rotate-btn {
            background: #666;
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .rotate-btn:hover { background: #888; }
        .rotate-slider {
            flex: 1;
        }
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            .sidebar {
                width: 100%;
                height: auto;
            }
            .canvas-area {
                height: 400px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="header">
   <img src="https://www.compassoffices.com/wp-content/themes/compass-offices/assets/images/compassoffices-logo-web-all-in-one-2025_ow.svg" alt="Compass Offices Logo" class="logo" onerror="this.style.display='none';">
   <h1 class="title" id="appTitle">Collage Maker</h1>
  </div>
  <div class="main-container">
   <div class="sidebar">
    <div class="section">
     <div class="section-title">Upload Images</div>
     <!-- URL Input Field -->
     <div class="url-input-group">
      <input type="text" id="urlInput" class="url-input" placeholder="Paste image URL(s), separate with comma">
      <button id="addUrlBtn" class="add-url-btn">Add URL</button>
     </div>
     <div id="urlError" class="url-error"></div>
     <!-- Upload Zone -->
     <div class="upload-zone" id="uploadZone">
      <div class="upload-text" id="uploadText">Drop images here or click</div>
      <div class="upload-hint">JPG, PNG, GIF supported</div>
     </div>
     <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    
     <div class="image-list" id="imageList"></div>
     <button class="btn btn-secondary" id="clearBtn" style="display: none; margin-top: 15px;">Clear All</button>
    </div>
    <div class="section">
     <div class="section-title">Layout Options</div>
     <div class="layout-buttons">
      <button class="layout-btn active" data-layout="single">Single</button>
      <button class="layout-btn" data-layout="two">Two</button>
      <button class="layout-btn" data-layout="big-small">Big + Small</button>
      <button class="layout-btn" data-layout="three">Three</button>
      <button class="layout-btn" data-layout="four">Four</button>
     </div>
     <div class="layout-adjustments" id="layoutAdjustments">
      <div class="adjustment-title">Adjust Current Layout</div>
      <div id="adjustmentControls"></div>
     </div>
    </div>
    <div class="section">
     <div class="section-title">Canvas Settings</div>
     <div class="controls">
      <div class="control-group">
       <label class="control-label">Canvas Width: <span id="widthValue">1080</span>px</label>
       <input type="range" class="slider" id="widthSlider" min="400" max="2000" value="1080">
      </div>
      <div class="control-group">
       <label class="control-label">Canvas Height: <span id="heightValue">1350</span>px</label>
       <input type="range" class="slider" id="heightSlider" min="400" max="2000" value="1350">
      </div>
      <button class="btn" id="downloadBtn" disabled><span id="downloadText">Download JPG</span></button>
     </div>
    </div>
   </div>
   <div class="canvas-area">
    <div class="zoom-controls">
     <button class="zoom-btn" id="zoomOut">−</button>
     <button class="zoom-btn" id="zoomIn">+</button>
     <button class="zoom-btn" id="resetZoom">Reset</button>
    </div>
    <div class="canvas-container" id="canvasContainer">
     <canvas id="collageCanvas" width="1080" height="1350"></canvas>
     <div class="canvas-overlay" id="canvasOverlay"></div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
        app_title: "Collage Maker",
        upload_text: "Drop images here or click",
        download_button_text: "Download JPG"
    };
    let canvas, ctx, overlay;
    let uploadedImages = [];
    let imageBoxes = [];
    let selectedBox = null;
    let isDragging = false;
    let isResizing = false;
    let dragOffset = { x: 0, y: 0 };
    let canvasScale = 1;
    let canvasOffset = { x: 0, y: 0 };
    let currentLayout = 'single';
    const layoutConfigs = {
        single: { slots: [{ x: 0, y: 0, width: 1, height: 1 }], adjustments: {} },
        two: { slots: [], adjustments: { split: { label: 'Split Position', min: 0.2, max: 0.8, value: 0.5, step: 0.01 } } },
        'big-small': { slots: [], adjustments: { mainWidth: { label: 'Main Image Width', min: 0.5, max: 0.8, value: 0.67, step: 0.01 }, smallSplit: { label: 'Small Images Split', min: 0.2, max: 0.8, value: 0.5, step: 0.01 } } },
        three: { slots: [], adjustments: { topHeight: { label: 'Top Image Height', min: 0.2, max: 0.6, value: 0.33, step: 0.01 }, bottomSplit: { label: 'Bottom Split', min: 0.2, max: 0.8, value: 0.5, step: 0.01 } } },
        four: { slots: [], adjustments: { verticalSplit: { label: 'Vertical Split', min: 0.2, max: 0.8, value: 0.5, step: 0.01 }, horizontalSplit: { label: 'Horizontal Split', min: 0.2, max: 0.8, value: 0.5, step: 0.01 } } }
    };
    let layoutAdjustments = {};

    // === LOAD IMAGES FROM URL PARAMS ===
    function loadImagesFromUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const imageParam = params.get('image');
        if (!imageParam) return;
        const urls = imageParam.split(',').map(u => u.trim()).filter(u => u);
        if (urls.length === 0) return;
        let loaded = 0;
        urls.forEach(url => {
            loadImageFromUrl(url, img => {
                loaded++;
                if (img) {
                    uploadedImages.push(img);
                    updateImageList();
                    updateCanvas();
                }
                if (loaded === urls.length) {
                    createLayout();
                }
            });
        });
    }
    function loadImageFromUrl(url, callback) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
            img.fileName = url.split('/').pop().split('?')[0] || `Image_${uploadedImages.length + 1}`;
            callback(img);
        };
        img.onerror = () => callback(null);
        img.src = url;
    }
    function handleUrls(input) {
        const urls = input.split(',').map(u => u.trim()).filter(u => u);
        const errorDiv = document.getElementById('urlError');
        errorDiv.style.display = 'none';
        let loaded = 0, failed = 0;
        if (!urls.length) return;
        urls.forEach(url => {
            loadImageFromUrl(url, img => {
                loaded++;
                if (img) {
                    uploadedImages.push(img);
                    updateImageList();
                    updateCanvas();
                } else {
                    failed++;
                }
                if (loaded === urls.length && failed > 0) {
                    errorDiv.textContent = `${failed} image(s) failed to load.`;
                    errorDiv.style.display = 'block';
                }
            });
        });
    }

    // ==================== IMAGE BOX CLASS (with rotation) ====================
    class ImageBox {
        constructor(x, y, width, height, index) {
            this.id = Date.now() + Math.random();
            this.x = x; this.y = y; this.width = width; this.height = height;
            this.index = index; this.image = null;
            this.zoom = 1; this.panX = 0; this.panY = 0;
            this.rotation = 0;                     // NEW
            this.isPanning = false; this.panStartX = 0; this.panStartY = 0;
            this.element = null; this.resizeHandle = null;
            this.createElements();
        }
        createElements() {
            this.element = document.createElement('div');
            this.element.className = 'image-box';
            this.element.style.left = this.x + 'px';
            this.element.style.top = this.y + 'px';
            this.element.style.width = this.width + 'px';
            this.element.style.height = this.height + 'px';
            this.resizeHandle = document.createElement('div');
            this.resizeHandle.className = 'resize-handle';
            this.resizeHandle.style.left = this.width + 'px';
            this.resizeHandle.style.top = this.height + 'px';
            this.element.appendChild(this.resizeHandle);
            overlay.appendChild(this.element);
            this.setupEvents();
        }
        setupEvents() {
            this.element.addEventListener('mousedown', (e) => {
                if (e.target === this.resizeHandle) return;
                e.preventDefault();
                selectedBox = this;
                this.select();
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                if (this.image && e.shiftKey) {
                    isDragging = true;
                    dragOffset.x = mouseX - this.x;
                    dragOffset.y = mouseY - this.y;
                } else if (this.image) {
                    this.isPanning = true;
                    this.panStartX = mouseX - this.panX;
                    this.panStartY = mouseY - this.panY;
                    this.element.style.cursor = 'grabbing';
                }
            });
            this.resizeHandle.addEventListener('mousedown', (e) => {
                e.preventDefault(); e.stopPropagation();
                selectedBox = this; isResizing = true; this.select();
            });
            this.element.addEventListener('dblclick', () => this.assignNextImage());
            this.element.addEventListener('wheel', (e) => {
                if (!this.image) return;
                e.preventDefault();
                const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                this.zoom = Math.max(0.5, Math.min(3, this.zoom * zoomFactor));
                updateCanvas();
            });
            this.element.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (this.image) this.showImageControls(e.clientX, e.clientY);
            });
            this.element.addEventListener('mouseenter', () => {
                if (this.image && !this.isPanning) this.element.style.cursor = 'grab';
            });
            this.element.addEventListener('mouseleave', () => {
                if (!this.isPanning) this.element.style.cursor = this.image ? 'grab' : 'move';
            });
        }
        select() {
            imageBoxes.forEach(box => box.element.classList.remove('selected'));
            this.element.classList.add('selected');
        }
        assignNextImage() {
            if (uploadedImages[this.index]) {
                this.image = uploadedImages[this.index];
                this.zoom = 1; this.panX = 0; this.panY = 0; this.rotation = 0;
                updateCanvas();
            }
        }
        showImageControls(x, y) {
            const existingMenu = document.querySelector('.image-control-menu');
            if (existingMenu) existingMenu.remove();
            const menu = document.createElement('div');
            menu.className = 'image-control-menu';
            menu.style.cssText = `
                position: fixed; left: ${x}px; top: ${y}px; background: #2a2a2a;
                border: 1px solid #666; border-radius: 6px; padding: 8px; z-index: 1000;
                display: flex; flex-direction: column; gap: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;

            // Zoom
            const zoomRow = document.createElement('div');
            zoomRow.style.display = 'flex'; zoomRow.style.gap = '6px';
            const zoomInBtn = this.createControlButton('Zoom In', 'Zoom In', () => {
                this.zoom = Math.min(3, this.zoom * 1.2); updateCanvas();
            });
            const zoomOutBtn = this.createControlButton('Zoom Out', 'Zoom Out', () => {
                this.zoom = Math.max(0.5, this.zoom / 1.2); updateCanvas();
            });
            const resetBtn = this.createControlButton('Reset', 'Reset', () => {
                this.zoom = 1; this.panX = 0; this.panY = 0; this.rotation = 0; updateCanvas();
            });
            zoomRow.append(zoomInBtn, zoomOutBtn, resetBtn);
            menu.appendChild(zoomRow);

            // Rotation
            const rotRow = document.createElement('div');
            rotRow.style.display = 'flex'; rotRow.style.alignItems = 'center'; rotRow.style.gap = '6px';
            const rotLeft = this.createControlButton('CCW', 'Rotate Left', () => {
                this.rotation = (this.rotation - 1 + 360) % 360;
                updateCanvas();
            });
            const rotRight = this.createControlButton('CW', 'Rotate Right', () => {
                this.rotation = (this.rotation + 1) % 360;
                updateCanvas();
            });
            const rotSlider = document.createElement('input');
            rotSlider.type = 'range'; rotSlider.min = '0'; rotSlider.max = '359'; rotSlider.step = '1';
            rotSlider.value = this.rotation;
            rotSlider.className = 'rotate-slider';
            rotSlider.style.flex = '1';
            rotSlider.addEventListener('input', (e) => {
                this.rotation = Number(e.target.value);
                updateCanvas();
            });
            const rotVal = document.createElement('span');
            rotVal.style.width = '40px'; rotVal.style.fontSize = '0.8rem';
            rotVal.textContent = this.rotation + '°';
            rotSlider.addEventListener('input', () => rotVal.textContent = rotSlider.value + '°');
            rotRow.append(rotLeft, rotSlider, rotRight, rotVal);
            menu.appendChild(rotRow);

            // Change image
            const changeBtn = this.createControlButton('Change', 'Change Image', () => this.cycleImage());
            menu.appendChild(changeBtn);

            document.body.appendChild(menu);
            setTimeout(() => {
                document.addEventListener('click', () => menu.remove(), { once: true });
            }, 100);
        }
        createControlButton(text, title, onClick) {
            const btn = document.createElement('button');
            btn.textContent = text; btn.title = title;
            btn.style.cssText = `
                background: #ff6600; color: white; border: none; border-radius: 4px;
                padding: 4px 6px; cursor: pointer; font-size: 12px; min-width: 28px;
            `;
            btn.addEventListener('click', onClick);
            btn.addEventListener('mouseenter', () => btn.style.background = '#e55a00');
            btn.addEventListener('mouseleave', () => btn.style.background = '#ff6600');
            return btn;
        }
        cycleImage() {
            if (uploadedImages.length === 0) return;
            const currentIndex = uploadedImages.indexOf(this.image);
            const nextIndex = (currentIndex + 1) % uploadedImages.length;
            this.image = uploadedImages[nextIndex];
            this.zoom = 1; this.panX = 0; this.panY = 0; this.rotation = 0;
            updateCanvas();
        }
        update() {
            this.element.style.left = this.x + 'px';
            this.element.style.top = this.y + 'px';
            this.element.style.width = this.width + 'px';
            this.element.style.height = this.height + 'px';
            this.resizeHandle.style.left = this.width + 'px';
            this.resizeHandle.style.top = this.height + 'px';
        }
        remove() {
            if (this.element) overlay.removeChild(this.element);
        }
    }

    // ==================== CANVAS & LAYOUT ====================
    function initCanvas() {
        canvas = document.getElementById('collageCanvas');
        ctx = canvas.getContext('2d');
        overlay = document.getElementById('canvasOverlay');
        overlay.style.width = canvas.width + 'px';
        overlay.style.height = canvas.height + 'px';
        clearCanvas();
    }
    function clearCanvas() {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    function calculateLayoutSlots() {
        const config = layoutConfigs[currentLayout];
        const adjustments = layoutAdjustments;
        switch (currentLayout) {
            case 'single': return [{ x: 0, y: 0, width: 1, height: 1 }];
            case 'two':
                const split = adjustments.split || 0.5;
                return [{ x: 0, y: 0, width: 1, height: split }, { x: 0, y: split, width: 1, height: 1 - split }];
            case 'big-small':
                const mainWidth = adjustments.mainWidth || 0.67;
                const smallSplit = adjustments.smallSplit || 0.5;
                const sideWidth = 1 - mainWidth;
                return [
                    { x: 0, y: 0, width: mainWidth, height: 1 },
                    { x: mainWidth, y: 0, width: sideWidth, height: smallSplit },
                    { x: mainWidth, y: smallSplit, width: sideWidth, height: 1 - smallSplit }
                ];
            case 'three':
                const topHeight = adjustments.topHeight || 0.33;
                const bottomSplit = adjustments.bottomSplit || 0.5;
                const bottomHeight = 1 - topHeight;
                return [
                    { x: 0, y: 0, width: 1, height: topHeight },
                    { x: 0, y: topHeight, width: bottomSplit, height: bottomHeight },
                    { x: bottomSplit, y: topHeight, width: 1 - bottomSplit, height: bottomHeight }
                ];
            case 'four':
                const vSplit = adjustments.verticalSplit || 0.5;
                const hSplit = adjustments.horizontalSplit || 0.5;
                return [
                    { x: 0, y: 0, width: vSplit, height: hSplit },
                    { x: vSplit, y: 0, width: 1 - vSplit, height: hSplit },
                    { x: 0, y: hSplit, width: vSplit, height: 1 - hSplit },
                    { x: vSplit, y: hSplit, width: 1 - vSplit, height: 1 - hSplit }
                ];
            default: return config.slots;
        }
    }
    function createLayout() {
        imageBoxes.forEach(box => box.remove());
        imageBoxes = [];
        const layoutSlots = calculateLayoutSlots();
        layoutSlots.forEach((slot, index) => {
            const x = slot.x * canvas.width;
            const y = slot.y * canvas.height;
            const width = slot.width * canvas.width;
            const height = slot.height * canvas.height;
            const box = new ImageBox(x, y, width, height, index);
            if (uploadedImages[index]) box.image = uploadedImages[index];
            imageBoxes.push(box);
        });
        updateCanvas();
    }
    function createAdjustmentControls() {
        const controlsContainer = document.getElementById('adjustmentControls');
        const config = layoutConfigs[currentLayout];
        controlsContainer.innerHTML = '';
        layoutAdjustments = {};
        Object.entries(config.adjustments).forEach(([key, adjustment]) => {
            layoutAdjustments[key] = adjustment.value;
            const controlDiv = document.createElement('div');
            controlDiv.className = 'adjustment-control';
            const label = document.createElement('label');
            label.className = 'adjustment-label';
            label.textContent = `${adjustment.label}: ${Math.round(adjustment.value * 100)}%`;
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.className = 'adjustment-slider';
            slider.min = adjustment.min;
            slider.max = adjustment.max;
            slider.step = adjustment.step;
            slider.value = adjustment.value;
            slider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                layoutAdjustments[key] = value;
                label.textContent = `${adjustment.label}: ${Math.round(value * 100)}%`;
                createLayout();
            });
            controlDiv.appendChild(label);
            controlDiv.appendChild(slider);
            controlsContainer.appendChild(controlDiv);
        });
        const adjustmentSection = document.getElementById('layoutAdjustments');
        adjustmentSection.style.display = Object.keys(config.adjustments).length > 0 ? 'block' : 'none';
    }

    // ==================== DRAWING WITH ROTATION ====================
    function updateCanvas() {
        clearCanvas();
        imageBoxes.forEach(box => {
            if (box.image) {
                const img = box.image;
                const imgAspect = img.width / img.height;
                const boxAspect = box.width / box.height;
                let baseWidth, baseHeight;
                if (imgAspect > boxAspect) {
                    baseHeight = box.height;
                    baseWidth = baseHeight * imgAspect;
                } else {
                    baseWidth = box.width;
                    baseHeight = baseWidth / imgAspect;
                }
                const drawWidth = baseWidth * box.zoom;
                const drawHeight = baseHeight * box.zoom;

                // Center of the box
                const cx = box.x + box.width / 2;
                const cy = box.y + box.height / 2;

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate((box.rotation * Math.PI) / 180);
                ctx.beginPath();
                ctx.rect(-box.width / 2, -box.height / 2, box.width, box.height);
                ctx.clip();

                const drawX = -drawWidth / 2 + box.panX;
                const drawY = -drawHeight / 2 + box.panY;
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                ctx.restore();
            }
        });
        drawLayoutDividers();
        document.getElementById('downloadBtn').disabled = imageBoxes.length === 0 || uploadedImages.length === 0;
    }

    function drawLayoutDividers() {
        if (imageBoxes.length <= 1) return;
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 5;
        ctx.lineCap = 'square';
        const layoutSlots = calculateLayoutSlots();
        switch (currentLayout) {
            case 'two':
                const split = layoutAdjustments.split || 0.5;
                const y = split * canvas.height;
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
                break;
            case 'big-small':
                const mainWidth = layoutAdjustments.mainWidth || 0.67;
                const x = mainWidth * canvas.width;
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
                const smallSplit = layoutAdjustments.smallSplit || 0.5;
                const smallY = smallSplit * canvas.height;
                ctx.beginPath(); ctx.moveTo(x, smallY); ctx.lineTo(canvas.width, smallY); ctx.stroke();
                break;
            case 'three':
                const topHeight = layoutAdjustments.topHeight || 0.33;
                const topY = topHeight * canvas.height;
                ctx.beginPath(); ctx.moveTo(0, topY); ctx.lineTo(canvas.width, topY); ctx.stroke();
                const bottomSplit = layoutAdjustments.bottomSplit || 0.5;
                const bottomX = bottomSplit * canvas.width;
                ctx.beginPath(); ctx.moveTo(bottomX, topY); ctx.lineTo(bottomX, canvas.height); ctx.stroke();
                break;
            case 'four':
                const vSplit = layoutAdjustments.verticalSplit || 0.5;
                const vX = vSplit * canvas.width;
                ctx.beginPath(); ctx.moveTo(vX, 0); ctx.lineTo(vX, canvas.height); ctx.stroke();
                const hSplit = layoutAdjustments.horizontalSplit || 0.5;
                const hY = hSplit * canvas.height;
                ctx.beginPath(); ctx.moveTo(0, hY); ctx.lineTo(canvas.width, hY); ctx.stroke();
                break;
        }
    }

    // ==================== IMAGE LIST (re-order + rotate UI) ====================
    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        img.fileName = file.name;
                        uploadedImages.push(img);
                        updateImageList();
                        updateCanvas();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function updateImageList() {
        const imageList = document.getElementById('imageList');
        const clearBtn = document.getElementById('clearBtn');
        imageList.innerHTML = '';
        uploadedImages.forEach((img, index) => {
            const item = document.createElement('div');
            item.className = 'image-item';
            item.draggable = true;

            const thumb = document.createElement('canvas');
            thumb.width = 40; thumb.height = 40; thumb.className = 'image-thumb';
            const thumbCtx = thumb.getContext('2d');
            const size = Math.min(img.width, img.height);
            const sx = (img.width - size) / 2;
            const sy = (img.height - size) / 2;
            thumbCtx.drawImage(img, sx, sy, size, size, 0, 0, 40, 40);

            const name = document.createElement('div');
            name.className = 'image-name';
            name.textContent = img.fileName || `Image ${index + 1}`;

            // Order buttons
            const upBtn = document.createElement('button');
            upBtn.className = 'order-btn';
            upBtn.textContent = 'Up';
            upBtn.disabled = index === 0;
            upBtn.addEventListener('click', () => moveImage(index, index - 1));

            const downBtn = document.createElement('button');
            downBtn.className = 'order-btn';
            downBtn.textContent = 'Down';
            downBtn.disabled = index === uploadedImages.length - 1;
            downBtn.addEventListener('click', () => moveImage(index, index + 1));

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '×';
            removeBtn.addEventListener('click', () => {
                uploadedImages.splice(index, 1);
                imageBoxes.forEach(box => { if (box.image === img) box.image = null; });
                updateImageList();
                updateCanvas();
            });

            item.appendChild(thumb);
            item.appendChild(name);
            item.appendChild(upBtn);
            item.appendChild(downBtn);
            item.appendChild(removeBtn);
            imageList.appendChild(item);

            // Drag & drop re-order
            let dragSrc = null;
            item.addEventListener('dragstart', (e) => {
                dragSrc = item;
                e.dataTransfer.effectAllowed = 'move';
                item.style.opacity = '0.5';
            });
            item.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (item !== dragSrc) item.style.borderTop = '2px solid #ff6600';
            });
            item.addEventListener('dragover', (e) => e.preventDefault());
            item.addEventListener('dragleave', () => {
                item.style.borderTop = '';
            });
            item.addEventListener('drop', (e) => {
                e.stopPropagation();
                if (dragSrc !== item) {
                    const srcIdx = Array.from(imageList.children).indexOf(dragSrc);
                    const tgtIdx = Array.from(imageList.children).indexOf(item);
                    moveImage(srcIdx, tgtIdx);
                }
                item.style.borderTop = '';
                return false;
            });
            item.addEventListener('dragend', () => {
                imageList.querySelectorAll('.image-item').forEach(i => {
                    i.style.opacity = '';
                    i.style.borderTop = '';
                });
            });
        });
        clearBtn.style.display = uploadedImages.length > 0 ? 'block' : 'none';
    }

    function moveImage(fromIdx, toIdx) {
        if (fromIdx < 0 || toIdx < 0 || fromIdx >= uploadedImages.length || toIdx >= uploadedImages.length) return;
        const [moved] = uploadedImages.splice(fromIdx, 1);
        uploadedImages.splice(toIdx, 0, moved);
        updateImageList();
        // Re-assign images to boxes preserving current box settings (zoom/pan/rotation)
        const oldAssignments = imageBoxes.map(b => b.image);
        imageBoxes.forEach((box, i) => {
            box.image = uploadedImages[i] || null;
        });
        updateCanvas();
    }

    function updateCanvasSize() {
        const width = parseInt(document.getElementById('widthSlider').value);
        const height = parseInt(document.getElementById('heightSlider').value);
        canvas.width = width; canvas.height = height;
        overlay.style.width = width + 'px'; overlay.style.height = height + 'px';
        document.getElementById('widthValue').textContent = width;
        document.getElementById('heightValue').textContent = height;
        createLayout();
    }

    function downloadCollage() {
        const link = document.createElement('a');
        link.download = 'collage.jpg';
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('DOMContentLoaded', () => {
        initCanvas();

        // URL Input
        const urlInput = document.getElementById('urlInput');
        const addUrlBtn = document.getElementById('addUrlBtn');
        addUrlBtn.onclick = () => {
            if (urlInput.value.trim()) {
                handleUrls(urlInput.value);
                urlInput.value = '';
            }
        };
        urlInput.onkeydown = (e) => { if (e.key === 'Enter') addUrlBtn.click(); };

        // Upload Zone
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        uploadZone.onclick = () => fileInput.click();
        uploadZone.ondragover = e => { e.preventDefault(); uploadZone.classList.add('dragover'); };
        uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');
        uploadZone.ondrop = e => { e.preventDefault(); uploadZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
        fileInput.onchange = e => handleFiles(e.target.files);

        // Layout Buttons
        document.querySelectorAll('.layout-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelector('.layout-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentLayout = btn.dataset.layout;
                createAdjustmentControls();
                createLayout();
            };
        });

        // Canvas Size Controls
        document.getElementById('widthSlider').oninput = updateCanvasSize;
        document.getElementById('heightSlider').oninput = updateCanvasSize;

        // Buttons
        document.getElementById('downloadBtn').onclick = downloadCollage;
        document.getElementById('clearBtn').onclick = () => {
            uploadedImages = []; imageBoxes.forEach(b => b.image = null); updateImageList(); updateCanvas();
        };

        // Mouse Events (drag / resize / pan)
        document.onmousemove = e => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            if (isDragging && selectedBox) {
                selectedBox.x = Math.max(0, Math.min(canvas.width - selectedBox.width, mouseX - dragOffset.x));
                selectedBox.y = Math.max(0, Math.min(canvas.height - selectedBox.height, mouseY - dragOffset.y));
                selectedBox.update(); updateCanvas();
            } else if (isResizing && selectedBox) {
                const newWidth = Math.max(50, mouseX - selectedBox.x);
                const newHeight = Math.max(50, mouseY - selectedBox.y);
                selectedBox.width = Math.min(newWidth, canvas.width - selectedBox.x);
                selectedBox.height = Math.min(newHeight, canvas.height - selectedBox.y);
                selectedBox.update(); updateCanvas();
            } else if (selectedBox && selectedBox.isPanning) {
                selectedBox.panX = mouseX - selectedBox.panStartX;
                selectedBox.panY = mouseY - selectedBox.panStartY;
                updateCanvas();
            }
        };
        document.onmouseup = () => {
            isDragging = false; isResizing = false;
            if (selectedBox) { selectedBox.isPanning = false; selectedBox.element.style.cursor = selectedBox.image ? 'grab' : 'move'; }
        };

        // Zoom Controls
        document.getElementById('zoomIn').onclick = () => { canvasScale = Math.min(canvasScale * 1.2, 3); updateCanvasTransform(); };
        document.getElementById('zoomOut').onclick = () => { canvasScale = Math.max(canvasScale / 1.2, 0.3); updateCanvasTransform(); };
        document.getElementById('resetZoom').onclick = () => { canvasScale = 1; canvasOffset = { x: 0, y: 0 }; updateCanvasTransform(); };
        function updateCanvasTransform() {
            document.getElementById('canvasContainer').style.transform = `scale(${canvasScale}) translate(${canvasOffset.x}px, ${canvasOffset.y}px)`;
        }

        // Load from URL params
        loadImagesFromUrlParams();
        createAdjustmentControls();
        createLayout();
    });

    // ==================== SDK FUNCTIONS ====================
    async function render(config) {
        document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
        document.getElementById('uploadText').textContent = config.upload_text || defaultConfig.upload_text;
        document.getElementById('downloadText').textContent = config.download_button_text || defaultConfig.download_button_text;
    }
    function mapToCapabilities() { return { recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }; }
    function mapToEditPanelValues(config) {
        return new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["upload_text", config.upload_text || defaultConfig.upload_text],
            ["download_button_text", config.download_button_text || defaultConfig.download_button_text]
        ]);
    }
    if (window.elementSdk) {
        window.elementSdk.init({ defaultConfig, render, mapToCapabilities, mapToEditPanelValues });
    }
  </script>
 </body>
</html>
