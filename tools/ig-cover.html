<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Photo Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    @font-face {
      font-family: 'Neue Haas Grotesk Display Pro';
      src: local('Helvetica Neue'), local('Arial');
      font-weight: 400;
    }
    
    @font-face {
      font-family: 'Neue Haas Grotesk Display Pro';
      src: local('Helvetica Neue Bold'), local('Arial Bold');
      font-weight: 700;
    }
    
    .canvas-container {
      width: 1080px;
      height: 1600px;
      position: relative;
      margin: 0 auto;
      background: transparent;
    }
    
    .white-section {
      width: 1080px;
      height: 850px;
      background: white;
      position: absolute;
      left: 50%;
      top: 850px;
      transform: translate(-50%, -50%);
    }
    
    .dark-section {
      width: 1080px;
      height: 500px;
      background: #282828;
      position: absolute;
      left: 50%;
      top: 1350px;
      transform: translate(-50%, -50%);
    }
    
    .photo-mask {
      width: 1000px;
      height: 900px;
      position: absolute;
      left: 50%;
      top: 960px;
      transform: translate(-50%, -50%);
      overflow: hidden;
      background: #1a1a1a;
      cursor: pointer;
      z-index: 5;
      border-radius: 20px;
    }
    
    .photo-mask img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-gradient {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.3) 100%);
      pointer-events: none;
      z-index: 2;
    }
    
    .logo-container {
      position: absolute;
      left: 80px;
      top: 550px;
      width: 250px;
      height: 100px;
      z-index: 6;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.1);
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logo-placeholder:hover {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.5);
    }
    
    .logo-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .text-box {
      width: 1000px;
      height: 300px;
      position: absolute;
      left: 50%;
      top: 1260px;
      transform: translateX(-50%);
      background: white;
      border-radius: 20px;
      padding: 50px 60px;
      z-index: 7;
    }
    
    .text-editor {
      font-family: 'Neue Haas Grotesk Display Pro', 'Helvetica Neue', Arial, sans-serif;
      font-size: 70px;
      line-height: 1.3;
      color: #000000;
      outline: none;
      border: none;
      width: 100%;
      min-height: 140px;
      resize: none;
      background: transparent;
      text-align: left;
    }
    
    .upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.7);
      z-index: 1;
    }
    
    .control-panel {
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      margin-bottom: 8px;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .formatting-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .format-btn {
      padding: 6px 12px;
      border-radius: 5px;
      border: 1.5px solid #e5e7eb;
      background: white;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .format-btn:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .format-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
  <div id="app-container" class="h-full w-full overflow-auto pt-2 pb-4 px-8"><!-- Controls Panel -->
   <div class="max-w-[1080px] mx-auto control-panel">
    <h1 class="text-lg font-bold mb-3" style="font-family: 'Inter', sans-serif;">Professional Photo Editor</h1><!-- Formatting Toolbar -->
    <div class="formatting-toolbar"><button id="bold-btn" class="format-btn">Bold</button> <button id="highlight-btn" class="format-btn" style="background: #ff6600; color: white; border-color: #ff6600;">Highlight</button> <button id="size-70-btn" class="format-btn active">70pt</button> <button id="size-50-btn" class="format-btn">50pt</button> <button id="clear-format-btn" class="format-btn">Clear Format</button>
    </div><!-- Action Buttons -->
    <div class="flex gap-3 flex-wrap"><button id="upload-photo-btn" class="btn btn-primary">Upload Photo</button> <button id="download-btn" class="btn btn-primary">Download JPG</button>
    </div><input type="file" id="photo-input" accept="image/*" class="hidden">
   </div><!-- Canvas -->
   <div class="canvas-container" id="canvas"><!-- White Background Section -->
    <div class="white-section"></div><!-- Dark Background Section -->
    <div class="dark-section"></div><!-- Photo Mask -->
    <div class="photo-mask" id="photo-mask"><img id="photo-image" src="" alt="" class="hidden" loading="lazy" onerror="this.src=''; this.alt='Image failed to load';">
     <div class="photo-gradient"></div>
     <div class="upload-overlay" id="upload-overlay">
      <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      <p class="text-lg font-semibold">Click to upload photo</p>
     </div>
    </div><!-- Logo Container -->
    <div class="logo-container" id="logo-container"><img id="logo-image" src="https://compassoffices.github.io/img/logo/compass-w-logo.png" alt="Compass Offices Logo" class="logo-image" loading="lazy" onerror="this.src=''; this.alt='Logo failed to load';">
    </div><!-- Text Box -->
    <div class="text-box">
     <div id="text-display" class="text-editor" contenteditable="true" data-placeholder="Enter your text here...">
      Enter your text here...
     </div>
    </div>
   </div><!-- Toast Notification -->
   <div id="toast" class="fixed bottom-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 flex items-center gap-2">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg><span id="toast-message">Success!</span>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      text_content: "Enter your text here...",
      background_color: "#ffffff",
      dark_section_color: "#282828",
      text_color: "#000000",
      highlight_color: "#ff6600",
      font_family: "Neue Haas Grotesk Display Pro",
      font_size: 32
    };

    // DOM Elements
    const photoInput = document.getElementById('photo-input');
    const uploadPhotoBtn = document.getElementById('upload-photo-btn');
    const downloadBtn = document.getElementById('download-btn');
    const photoMask = document.getElementById('photo-mask');
    const photoImage = document.getElementById('photo-image');
    const uploadOverlay = document.getElementById('upload-overlay');
    const logoImage = document.getElementById('logo-image');
    const textDisplay = document.getElementById('text-display');
    const boldBtn = document.getElementById('bold-btn');
    const highlightBtn = document.getElementById('highlight-btn');
    const size70Btn = document.getElementById('size-70-btn');
    const size50Btn = document.getElementById('size-50-btn');
    const clearFormatBtn = document.getElementById('clear-format-btn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    // Upload handlers
    uploadPhotoBtn.addEventListener('click', () => photoInput.click());
    
    photoMask.addEventListener('click', () => {
      if (photoImage.classList.contains('hidden')) {
        photoInput.click();
      }
    });

    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          photoImage.src = e.target.result;
          photoImage.classList.remove('hidden');
          uploadOverlay.classList.add('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // Text formatting
    boldBtn.addEventListener('click', () => {
      document.execCommand('bold');
      boldBtn.classList.toggle('active');
    });

    highlightBtn.addEventListener('click', () => {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.color = '#ff6600';
        span.style.fontWeight = '700';
        
        try {
          range.surroundContents(span);
        } catch (e) {
          // If selection spans multiple elements, use execCommand
          document.execCommand('foreColor', false, '#ff6600');
        }
      }
    });

    size70Btn.addEventListener('click', () => {
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && !selection.isCollapsed) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.fontSize = '70px';
        try {
          range.surroundContents(span);
        } catch (e) {
          document.execCommand('fontSize', false, '7');
          const fontElements = textDisplay.querySelectorAll('font[size="7"]');
          fontElements.forEach(el => {
            el.style.fontSize = '70px';
            el.removeAttribute('size');
          });
        }
      }
      size70Btn.classList.add('active');
      size50Btn.classList.remove('active');
    });

    size50Btn.addEventListener('click', () => {
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && !selection.isCollapsed) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.fontSize = '50px';
        try {
          range.surroundContents(span);
        } catch (e) {
          document.execCommand('fontSize', false, '6');
          const fontElements = textDisplay.querySelectorAll('font[size="6"]');
          fontElements.forEach(el => {
            el.style.fontSize = '50px';
            el.removeAttribute('size');
          });
        }
      }
      size50Btn.classList.add('active');
      size70Btn.classList.remove('active');
    });

    clearFormatBtn.addEventListener('click', () => {
      document.execCommand('removeFormat');
      document.execCommand('foreColor', false, '#000000');
      textDisplay.style.fontSize = '70px';
    });

    // Update config when text changes
    textDisplay.addEventListener('input', () => {
      if (window.elementSdk) {
        window.elementSdk.setConfig({ text_content: textDisplay.innerHTML });
      }
    });

    // Download functionality
    downloadBtn.addEventListener('click', async () => {
      const canvas = document.createElement('canvas');
      canvas.width = 1080;
      canvas.height = 1350;
      const ctx = canvas.getContext('2d');

      // Draw transparent background for top section
      ctx.clearRect(0, 0, 1080, 1350);

      // Draw white section centered at x:540, y:675 (scale factor 0.84375)
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 250, 1080, 717);

      // Draw dark section centered at x:540, y:1096.875 (scale factor 0.84375)
      ctx.fillStyle = '#282828';
      ctx.fillRect(0, 846.875, 1080, 422);

      // Draw photo if uploaded
      if (!photoImage.classList.contains('hidden')) {
        ctx.save();
        
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = photoImage.src;
        
        await new Promise((resolve) => {
          img.onload = () => {
            // Draw rounded rectangle photo (scale factor 0.84375: 1000*0.84375=843.75, 900*0.84375=759.375)
            ctx.beginPath();
            roundRect(ctx, 118, 351, 844, 759, 17);
            ctx.clip();
            
            ctx.drawImage(img, 118, 351, 844, 759);
            
            // Draw gradient overlay
            const gradient = ctx.createLinearGradient(0, 351, 0, 1110);
            gradient.addColorStop(0, 'rgba(0,0,0,0.4)');
            gradient.addColorStop(0.5, 'rgba(0,0,0,0.1)');
            gradient.addColorStop(1, 'rgba(0,0,0,0.3)');
            ctx.fillStyle = gradient;
            ctx.fillRect(118, 351, 844, 759);
            
            ctx.restore();
            resolve();
          };
        });
      }

      // Draw logo
      if (logoImage.complete && logoImage.naturalWidth > 0) {
        const logo = new Image();
        logo.crossOrigin = 'anonymous';
        logo.src = logoImage.src;
        
        await new Promise((resolve) => {
          logo.onload = () => {
            const logoWidth = 211; // 250 * 0.84375
            const logoHeight = (logo.height / logo.width) * logoWidth;
            const logoX = 135; // 80 + 55 (adjusted for scale)
            const logoY = 390; // 550 * 0.84375 - 74
            
            ctx.drawImage(logo, logoX, logoY, logoWidth, logoHeight);
            resolve();
          };
          logo.onerror = () => resolve();
        });
      }

      // Draw text box (scale factor 0.84375: 1000*0.84375=843.75, 300*0.84375=253.125)
      ctx.fillStyle = '#ffffff';
      roundRect(ctx, 118, 911, 844, 253, 17);
      ctx.fill();

      // Draw text with formatting
      const textContent = textDisplay.innerHTML;
      ctx.textBaseline = 'top';
      ctx.textAlign = 'left';
      
      let yPos = 953;
      
      // Create a hidden div to render the HTML exactly as displayed
      const renderDiv = document.createElement('div');
      renderDiv.innerHTML = textContent;
      renderDiv.style.font = '700 59px "Helvetica Neue", Arial, sans-serif'; // 70px * 0.84375
      renderDiv.style.lineHeight = '1.3';
      renderDiv.style.color = '#000000';
      
      // Recursive function to render text nodes with formatting
      function renderNode(node, currentFont, currentColor, isBold) {
        if (node.nodeType === Node.TEXT_NODE) {
          const text = node.textContent;
          if (text && text !== '\n') {
            ctx.font = currentFont;
            ctx.fillStyle = currentColor;
            
            // Split by line breaks
            const lines = text.split('\n');
            lines.forEach((line, index) => {
              if (line.trim() || index === 0) {
                ctx.fillText(line, 168, yPos); // 100 + 68 (adjusted for scale)
                if (index < lines.length - 1) {
                  yPos += currentFont.includes('59px') ? 77 : 55; // 91*0.84375=77, 65*0.84375=55
                }
              }
            });
          }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          let fontSize = '59px'; // 70px * 0.84375
          let color = currentColor;
          let bold = isBold;
          
          // Check for font size
          if (node.style.fontSize) {
            const originalSize = parseInt(node.style.fontSize);
            fontSize = Math.round(originalSize * 0.84375) + 'px';
          }
          
          // Check for color (highlight)
          if (node.style.color) {
            const colorValue = node.style.color;
            if (colorValue === 'rgb(255, 102, 0)' || colorValue === '#ff6600') {
              color = '#ff6600';
            }
          }
          
          // Check for bold
          if (node.tagName === 'B' || node.tagName === 'STRONG' || node.style.fontWeight === '700' || node.style.fontWeight === 'bold') {
            bold = true;
          }
          
          const fontWeight = bold ? '700' : '700';
          const font = `${fontWeight} ${fontSize} "Helvetica Neue", Arial, sans-serif`;
          
          // Process child nodes
          node.childNodes.forEach(child => {
            renderNode(child, font, color, bold);
          });
        }
        
        // Handle BR tags
        if (node.nodeName === 'BR') {
          yPos += 77; // 91 * 0.84375
        }
        
        // Handle DIV tags (new paragraphs)
        if (node.nodeName === 'DIV' && node !== renderDiv) {
          yPos += 77; // 91 * 0.84375
        }
      }
      
      renderDiv.childNodes.forEach(node => {
        renderNode(node, '700 59px "Helvetica Neue", Arial, sans-serif', '#000000', true);
      });

      // Download
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `design-${Date.now()}.jpg`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Downloaded successfully!');
      }, 'image/jpeg', 0.95);
    });

    function roundRect(ctx, x, y, width, height, radius) {
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + height - radius);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
      ctx.lineTo(x + radius, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
    }

    function showToast(message) {
      toastMessage.textContent = message;
      toast.style.transform = 'translateY(0)';
      setTimeout(() => {
        toast.style.transform = 'translateY(8rem)';
      }, 3000);
    }

    // Element SDK Integration
    async function onConfigChange(config) {
      const cfg = { ...defaultConfig, ...config };
      
      const textContent = cfg.text_content || defaultConfig.text_content;
      if (textDisplay.innerHTML !== textContent) {
        textDisplay.innerHTML = textContent;
      }
    }

    function mapToCapabilities(config) {
      const cfg = { ...defaultConfig, ...config };
      return {
        recolorables: [
          {
            get: () => cfg.background_color || defaultConfig.background_color,
            set: (value) => { cfg.background_color = value; window.elementSdk.setConfig({ background_color: value }); }
          },
          {
            get: () => cfg.dark_section_color || defaultConfig.dark_section_color,
            set: (value) => { cfg.dark_section_color = value; window.elementSdk.setConfig({ dark_section_color: value }); }
          },
          {
            get: () => cfg.text_color || defaultConfig.text_color,
            set: (value) => { cfg.text_color = value; window.elementSdk.setConfig({ text_color: value }); }
          },
          {
            get: () => cfg.highlight_color || defaultConfig.highlight_color,
            set: (value) => { cfg.highlight_color = value; window.elementSdk.setConfig({ highlight_color: value }); }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      const cfg = { ...defaultConfig, ...config };
      return new Map([
        ["text_content", cfg.text_content || defaultConfig.text_content]
      ]);
    }

    // Initialize SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9beaa470109e8acd',t:'MTc2ODUzNTM2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
