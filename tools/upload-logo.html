<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Compass Offices – Smart Logo Fit</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            color: #1f2937;
        }
        .card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
            width: 100%;
            max-width: 560px;
            overflow: hidden;
            border: 1px solid #f3f4f6;
        }
        .header {
            background: #ffffff;
            color: #ff6600;
            padding: 32px 28px;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
        }
        .header img {
            height: 58px;
            margin-bottom: 16px;
        }
        .header h1 { font-size: 1.85rem; font-weight: 700; }
        .header p { font-size: 1rem; color: #6b7280; margin-top: 8px; }
        .content { padding: 32px; }
        .form-group { margin-bottom: 24px; position: relative; }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111827;
        }
        input[type=text], select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all .3s ease;
        }
        input[type=text]:focus, select:focus {
            outline: none;
            border-color: #ff8533;
            box-shadow: 0 0 0 3px rgba(255,102,0,.15);
        }
        .upload-area {
            border: 3px dashed #ff8533;
            border-radius: 18px;
            padding: 45px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fffaf0;
        }
        .upload-area:hover { border-color: #ff6600; background: #fff5e6; }
        .upload-area.dragover { border-color: #ff6600; background: #ffedd5; }
        .upload-area i { font-size: 50px; color: #ff6600; margin-bottom: 14px; display: block; }
        .upload-area input { display: none; }
        .preview-box { margin: 22px 0; text-align: center; }
        .preview-box p { font-weight: 600; margin-bottom: 10px; color: #1f2937; }
        .preview-box img, .preview-box canvas {
            max-width: 100%;
            max-height: 200px;
            border-radius: 14px;
            box-shadow: 0 6px 16px rgba(0,0,0,.1);
            border: 1px solid #f3f4f6;
        }
        .info {
            background: #fff7ed;
            padding: 14px;
            border-radius: 12px;
            font-size: 0.94rem;
            color: #9a3412;
            margin: 18px 0;
            border-left: 4px solid #ff6600;
        }
        .upload-tip {
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
            margin: 10px 0;
            font-style: italic;
        }
        .btn {
            background: #ff6600;
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            transition: .3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover { background: #e65c00; transform: translateY(-1px); }
        .btn:disabled { background: #fb923c; cursor: not-allowed; }
        .loader {
            display: inline-block;
            width: 20px; height: 20px;
            border: 3px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }

        /* Smart Suggestions */
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 220px;
            overflow-y: auto;
            z-index: 100;
            list-style: none;
            padding: 0;
            margin: 0;
            box-shadow: 0 10px 20px rgba(0,0,0,.1);
        }
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.95rem;
            transition: background .2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suggestion-item:hover, .suggestion-item.active {
            background: #fff5e6;
            color: #ff6600;
        }
        .suggestion-domain {
            font-size: 0.8rem;
            color: #6b7280;
            margin-left: 8px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
<div class="card">
    <div class="header">
        <img src="https://compassoffices.github.io/img/logo/new-p1-02.png" alt="Compass Offices">
        <h1>Smart Logo Fit</h1>
        <p>Full logo preserved • Auto background remove • Fit to 1080×1080 or 1080×500</p>
    </div>
    <div class="content">
        <form id="logoForm">
            <!-- Company Name with Clearbit Autocomplete -->
            <div class="form-group">
                <label for="companyName">Company Name</label>
                <input type="text" id="companyName" placeholder="Start typing company name..." required autocomplete="off" />
                <ul id="suggestions" class="suggestions hidden"></ul>
            </div>

            <!-- Industry -->
            <div class="form-group">
                <label for="industry">Industry</label>
                <select id="industry" required>
                    <option value="" disabled selected>Select your industry</option>
                    <option value="finance">Finance, Banking & Insurance</option>
                    <option value="technology">Technology & Telecommunications</option>
                    <option value="retail">Retail, Hospitality & Lifestyle</option>
                    <option value="logistics">Logistics, Consulting & Professional Services</option>
                </select>
            </div>

            <!-- Upload -->
            <div class="upload-area" id="dropZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p><strong>Click or drag & drop</strong> your logo</p>
                <p style="font-size:0.85rem;color:#9ca3af;margin-top:6px;">JPG, PNG, WebP, GIF – any size</p>
                <input type="file" id="fileInput" accept="image/*"/>
            </div>
            <p class="upload-tip">Tip: Upload the highest resolution image possible for the best transparent background removal, especially if the logo is on a white background.</p>

            <div id="status" class="info hidden"></div>
            <div class="preview-box hidden" id="originalBox">
                <p>Original Image</p>
                <img id="originalImg" alt="Original"/>
            </div>
            <div class="preview-box hidden" id="resultBox">
                <p>Final Transparent Logo (No Crop)</p>
                <canvas id="resultCanvas"></canvas>
            </div>
            <button type="submit" class="btn hidden" id="submitBtn">
                <span class="loader hidden" id="loader"></span>
                <span id="btnText">Submit to Compass Offices</span>
            </button>
        </form>
    </div>
</div>

<script>
    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const originalBox = document.getElementById('originalBox');
    const originalImg = document.getElementById('originalImg');
    const resultBox = document.getElementById('resultBox');
    const resultCanvas = document.getElementById('resultCanvas');
    const submitBtn = document.getElementById('submitBtn');
    const loader = document.getElementById('loader');
    const btnText = document.getElementById('btnText');
    const companyName = document.getElementById('companyName');
    const industry = document.getElementById('industry');
    const form = document.getElementById('logoForm');
    const suggestionsUl = document.getElementById('suggestions');
    let finalBlob = null;
    const WEBHOOK = 'https://hook.eu2.make.com/vmt72bscm634y3pb25772pcfmkf0vq2w';

    // === CLEARBIT AUTOCOMPLETE (FREE, NO KEY) ===
    let debounceTimer;
    companyName.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        const query = companyName.value.trim();
        if (query.length < 2) {
            suggestionsUl.classList.add('hidden');
            return;
        }
        debounceTimer = setTimeout(() => fetchClearbitSuggestions(query), 300);
    });

    async function fetchClearbitSuggestions(query) {
        try {
            const res = await fetch(`https://autocomplete.clearbit.com/v1/companies/suggest?query=${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error();
            const data = await res.json();
            const suggestions = data.slice(0, 6).map(item => ({
                name: item.name,
                domain: item.domain
            }));
            showSuggestions(suggestions);
        } catch (err) {
            console.warn('Clearbit fetch failed:', err);
            suggestionsUl.classList.add('hidden');
        }
    }

    function showSuggestions(list) {
        suggestionsUl.innerHTML = '';
        if (list.length === 0) {
            suggestionsUl.classList.add('hidden');
            return;
        }
        list.forEach((item, i) => {
            const li = document.createElement('li');
            li.className = 'suggestion-item';
            li.innerHTML = `
                <span>${item.name}</span>
                ${item.domain ? `<span class="suggestion-domain">${item.domain}</span>` : ''}
            `;
            li.onclick = () => {
                companyName.value = item.name;
                suggestionsUl.classList.add('hidden');
            };
            if (i === 0) li.classList.add('active');
            suggestionsUl.appendChild(li);
        });
        suggestionsUl.classList.remove('hidden');
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!companyName.contains(e.target) && !suggestionsUl.contains(e.target)) {
            suggestionsUl.classList.add('hidden');
        }
    });

    // === DRAG & DROP + FILE INPUT ===
    ['dragenter','dragover','dragleave','drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false));
    ['dragenter','dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('dragover'), false));
    ['dragleave','drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'), false));
    dropZone.addEventListener('drop', e => { const f = e.dataTransfer.files[0]; if (f) processFile(f); });
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => { if (fileInput.files[0]) processFile(fileInput.files[0]); });

    // === PROCESS FILE (unchanged) ===
    async function processFile(file) {
        resetUI();
        showStatus('Analyzing image...', 'info');
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = async () => {
            URL.revokeObjectURL(url);
            originalImg.src = img.src;
            originalBox.classList.remove('hidden');
            await fitAndConvert(img);
        };
        img.src = url;
    }

    async function fitAndConvert(img) {
        showStatus('Removing background & detecting shape...', 'info');
        toggleLoader(true);
        const canvas = document.createElement('canvas');
        canvas.width = img.width; canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        // Remove white/light background
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
            const isLight = r > 220 && g > 220 && b > 220;
            if (a > 200 && isLight) data[i+3] = 0;
        }
        ctx.putImageData(imageData, 0, 0);

        // Find bounding box
        const box = getContentBoundingBox(ctx, canvas.width, canvas.height);
        if (!box || box.w < 30 || box.h < 30) {
            showStatus('No logo detected. Try a clearer image.', 'error');
            toggleLoader(false);
            return;
        }

        // Determine size
        const aspect = box.w / box.h;
        const isSquare = aspect >= 0.75 && aspect <= 1.4;
        const targetW = 1080;
        const targetH = isSquare ? 1080 : 500;
        showStatus(`Detected <strong>${isSquare ? 'square' : 'horizontal'}</strong> logo → ${targetW}×${targetH} PNG (100% preserved)`, 'success');

        // Fit to canvas
        resultCanvas.width = targetW; resultCanvas.height = targetH;
        const rctx = resultCanvas.getContext('2d');
        rctx.clearRect(0, 0, targetW, targetH);
        const scale = Math.min(targetW / box.w, targetH / box.h);
        const drawW = box.w * scale, drawH = box.h * scale;
        const dx = (targetW - drawW) / 2, dy = (targetH - drawH) / 2;
        rctx.drawImage(canvas, box.x, box.y, box.w, box.h, dx, dy, drawW, drawH);
        resultBox.classList.remove('hidden');

        // Export
        resultCanvas.toBlob(blob => {
            finalBlob = blob;
            submitBtn.classList.remove('hidden');
            toggleLoader(false);
        }, 'image/png');
    }

    function getContentBoundingBox(ctx, w, h) {
        const data = ctx.getImageData(0, 0, w, h).data;
        let minX = w, minY = h, maxX = 0, maxY = 0, found = false;
        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                if (data[(y * w + x) * 4 + 3] > 60) {
                    minX = Math.min(minX, x); minY = Math.min(minY, y);
                    maxX = Math.max(maxX, x); maxY = Math.max(maxY, y);
                    found = true;
                }
            }
        }
        return found ? { x: minX, y: minY, w: maxX - minX + 1, h: maxY - minY + 1 } : null;
    }

    // === SUBMIT ===
    form.addEventListener('submit', async e => {
        e.preventDefault();
        if (!finalBlob) return;
        if (!companyName.value.trim() || !industry.value) {
            showStatus('Please fill in company name and industry.', 'error');
            return;
        }
        toggleLoader(true);
        showStatus('Sending to Compass Offices...', 'info');
        const fd = new FormData();
        fd.append('logo', finalBlob, `logo-${Date.now()}.png`);
        fd.append('company_name', companyName.value.trim());
        fd.append('industry', industry.options[industry.selectedIndex].text);
        fd.append('timestamp', new Date().toISOString());
        fd.append('timezone', 'HKT');
        fd.append('country', 'HK');
        try {
            const res = await fetch(WEBHOOK, { method: 'POST', body: fd });
            if (res.ok) {
                showStatus('Success! Your logo has been submitted.', 'success');
                btnText.textContent = 'Submitted';
            } else throw new Error();
        } catch {
            showStatus('Failed to send. Try again.', 'error');
        } finally {
            toggleLoader(false);
        }
    });

    // === UI HELPERS ===
    function showStatus(msg, type = 'info') {
        status.innerHTML = msg;
        status.className = 'info';
        if (type === 'error') { status.style.background = '#fee2e2'; status.style.color = '#991b1b'; status.style.borderLeftColor = '#ef4444'; }
        if (type === 'success') { status.style.background = '#f0fdf4'; status.style.color = '#166534'; status.style.borderLeftColor = '#22c55e'; }
        status.classList.remove('hidden');
    }
    function toggleLoader(show) {
        loader.classList.toggle('hidden', !show);
        submitBtn.disabled = show;
        btnText.textContent = show ? 'Processing...' : 'Submit to Compass Offices';
    }
    function resetUI() {
        [originalBox, resultBox, submitBtn, status].forEach(el => el.classList.add('hidden'));
        finalBlob = null;
        toggleLoader(false);
    }
</script>
</body>
</html>
