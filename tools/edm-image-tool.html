<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://compassoffices.github.io/img/logo/new-p1-32.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <title>EDM Collage Tool</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      padding: 2rem;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 1rem;
      font-weight: 600;
      font-size: 2rem;
    }
    .upload-multi {
      text-align: center;
      margin-bottom: 1rem;
    }
    .upload-multi button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background: #ff6600;
      color: #ffffff;
      border: none;
      cursor: pointer;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
    }
    .upload-multi button:hover {
      background: #e55a00;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
    }
    .dropzones {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .dropzone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      background: #f9fafb;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      min-height: 80px;
      position: relative;
    }
    .dropzone:hover {
      background: #f3f4f6;
      border-color: #ff6600;
      box-shadow: 0 6px 20px rgba(255, 102, 0, 0.1);
    }
    .dropzone.dragover {
      background: #e5e7eb;
      border-color: #ff6600;
      box-shadow: 0 8px 25px rgba(255, 102, 0, 0.15);
    }
    .dropzone p {
      margin: 0;
      color: #6b7280;
      font-size: 1rem;
    }
    .preview {
      text-align: center;
    }
    .preview img {
      max-width: 60px;
      height: auto;
      border-radius: 8px;
      display: block;
      margin: 0 auto 0.5rem auto;
    }
    .preview p {
      margin: 0;
      color: #6b7280;
      font-size: 0.9rem;
    }
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .controls label {
      flex: 1 1 30%;
      font-size: 0.9rem;
      color: #374151;
      font-weight: 500;
    }
    .controls input[type="range"] {
      width: 100%;
      margin-top: 0.5rem;
    }
    canvas {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin: 1rem 0;
      width: 100%;
      height: auto;
      cursor: grab;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      transition: box-shadow 0.2s ease;
    }
    canvas:hover {
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
    }
    canvas:active {
      cursor: grabbing;
    }
    .btns {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      justify-content: center;
    }
    .btns button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background: #ff6600;
      color: #ffffff;
      border: none;
      cursor: pointer;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
    }
    .btns button:hover {
      background: #e55a00;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
    }
    .btns button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
<div class="container">
  <h1>EDM Collage Tool</h1>
  <div class="upload-multi">
    <button id="multiBtn">üìÅ Upload up to 3 Images</button>
  </div>
  <div class="dropzones">
    <div class="dropzone" id="drop1"><p>Drop or Click to Upload Image 1</p></div>
    <div class="dropzone" id="drop2"><p>Drop or Click to Upload Image 2</p></div>
    <div class="dropzone" id="drop3"><p>Drop or Click to Upload Image 3</p></div>
  </div>
  <div class="controls">
    <label>Zoom 1
      <input type="range" id="scale1" min="0.05" max="5" step="0.05" value="1">
    </label>
    <label>Zoom 2
      <input type="range" id="scale2" min="0.05" max="5" step="0.05" value="1">
    </label>
    <label>Zoom 3
      <input type="range" id="scale3" min="0.05" max="5" step="0.05" value="1">
    </label>
  </div>
  <canvas id="canvas400" width="1600" height="1200"></canvas>
  <canvas id="canvas680" width="2720" height="1200"></canvas>
  <div class="btns">
    <button onclick="downloadImage(canvas400, '400x300')">Download 400x300</button>
    <button onclick="downloadImage(canvas680, '680x300')">Download 680x300</button>
  </div>
</div>
<script>
  const images = [null, null, null];
  const offsets = [{ x: 0, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 0 }];
  const scales = [1, 1, 1];
  const dropZones = [document.getElementById('drop1'), document.getElementById('drop2'), document.getElementById('drop3')];
  const scaleInputs = [scale1, scale2, scale3];
  const canvas400 = document.getElementById('canvas400');
  const canvas680 = document.getElementById('canvas680');
  const ctx400 = canvas400.getContext('2d');
  const ctx680 = canvas680.getContext('2d');
  let dragging = null;
  let isCanvasDragging = false;
  let dragStart = { x: 0, y: 0 };

  // Layouts in high resolution (√ó4)
  const layout400 = [
    { x: 20, y: 20, w: 1560, h: 580 },
    { x: 20, y: 620, w: 760, h: 560 },
    { x: 820, y: 620, w: 760, h: 560 },
  ];
  const layout680 = [
    { x: 20, y: 20, w: 1520, h: 1160 },
    { x: 1560, y: 20, w: 1120, h: 560 },
    { x: 1560, y: 620, w: 1120, h: 560 },
  ];

  // Multiple upload input
  const multiInput = document.createElement('input');
  multiInput.type = 'file';
  multiInput.accept = 'image/*';
  multiInput.style.display = 'none';
  multiInput.multiple = true;
  document.body.appendChild(multiInput);

  const multiBtn = document.getElementById('multiBtn');
  multiBtn.addEventListener('click', () => {
    delete multiInput.dataset.targetI;
    multiInput.multiple = true;
    multiInput.click();
  });

  multiInput.addEventListener('change', (e) => {
    if (multiInput.multiple === false) {
      const i = parseInt(multiInput.dataset.targetI);
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        loadImage(i, file);
      }
    } else {
      const files = Array.from(e.target.files).slice(0, 3);
      for (let k = 0; k < files.length; k++) {
        loadImage(k, files[k]);
      }
    }
    e.target.value = '';
  });

  function loadImage(i, file) {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        images[i] = img;
        offsets[i] = { x: 0, y: 0 };
        updatePreview(i);
        renderAll(true);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  }

  function updatePreview(i) {
    const zone = dropZones[i];
    zone.innerHTML = '';
    if (!images[i]) {
      const p = document.createElement('p');
      p.textContent = `Drop or Click to Upload Image ${i + 1}`;
      zone.appendChild(p);
      return;
    }
    const preview = document.createElement('div');
    preview.className = 'preview';
    preview.draggable = true;
    const imgEl = document.createElement('img');
    imgEl.src = images[i].src;
    imgEl.alt = `Image ${i + 1}`;
    const p = document.createElement('p');
    p.textContent = `Slot ${i + 1} - Drag to reorder`;
    preview.appendChild(imgEl);
    preview.appendChild(p);
    zone.appendChild(preview);
    preview.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', i.toString());
    });
  }

  dropZones.forEach((zone, i) => {
    zone.dataset.index = i.toString();
    zone.addEventListener('click', () => {
      if (images[i] && !confirm(`Replace image in slot ${i + 1}?`)) return;
      multiInput.multiple = false;
      multiInput.dataset.targetI = i.toString();
      multiInput.click();
    });
    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.classList.add('dragover');
    });
    zone.addEventListener('dragleave', () => {
      zone.classList.remove('dragover');
    });
    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.classList.remove('dragover');
      const sourceStr = e.dataTransfer.getData('text/plain');
      if (sourceStr !== '') {
        const sourceI = parseInt(sourceStr);
        const targetI = i;
        if (sourceI !== targetI && images[sourceI]) {
          if (images[targetI]) {
            [images[sourceI], images[targetI]] = [images[targetI], images[sourceI]];
          } else {
            images[targetI] = images[sourceI];
            images[sourceI] = null;
          }
          updatePreview(sourceI);
          updatePreview(targetI);
          renderAll(true);
        }
        return;
      }
      // file drop
      const files = e.dataTransfer.files;
      if (files.length > 1) {
        alert('For multiple images, please use the "Upload up to 3 Images" button.');
        return;
      }
      const file = files[0];
      if (!file || !file.type.startsWith('image/')) return;
      loadImage(i, file);
    });
  });

  scaleInputs.forEach((input, i) => {
    input.addEventListener('input', () => {
      scales[i] = parseFloat(input.value);
      renderAll(true);
    });
  });

  function drawImageClipped(ctx, img, box, offset, scale) {
    if (!img) return;
    const iw = img.width * scale;
    const ih = img.height * scale;
    const dx = box.x + (box.w - iw) / 2 + offset.x;
    const dy = box.y + (box.h - ih) / 2 + offset.y;
    ctx.save();
    ctx.beginPath();
    ctx.rect(box.x, box.y, box.w, box.h);
    ctx.clip();
    ctx.fillStyle = "#fff";
    ctx.fillRect(box.x - 6, box.y - 6, box.w + 12, box.h + 12); // white gap
    ctx.drawImage(img, dx, dy, iw, ih);
    ctx.restore();
  }

  function drawBorders(ctx, layout) {
    ctx.strokeStyle = 'rgba(255, 102, 0, 0.5)';
    ctx.lineWidth = 2;
    layout.forEach(box => {
      ctx.strokeRect(box.x, box.y, box.w, box.h);
    });
  }

  function renderAll(showBorders = true) {
    ctx400.fillStyle = "#fff";
    ctx400.fillRect(0, 0, canvas400.width, canvas400.height);
    layout400.forEach((box, i) => drawImageClipped(ctx400, images[i], box, offsets[i], scales[i]));
    if (showBorders) drawBorders(ctx400, layout400);

    ctx680.fillStyle = "#fff";
    ctx680.fillRect(0, 0, canvas680.width, canvas680.height);
    layout680.forEach((box, i) => drawImageClipped(ctx680, images[i], box, offsets[i], scales[i]));
    if (showBorders) drawBorders(ctx680, layout680);
  }

  // Dragging support for both canvases
  [canvas400, canvas680].forEach((canvas, canvasIndex) => {
    const layout = canvasIndex === 0 ? layout400 : layout680;
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      for (let i = 0; i < layout.length; i++) {
        const b = layout[i];
        if (x >= b.x && x <= b.x + b.w && y >= b.y && y <= b.y + b.h) {
          dragging = i;
          dragStart = { x, y };
          isCanvasDragging = true;
          renderAll(true);
          break;
        }
      }
    });
    canvas.addEventListener('mousemove', (e) => {
      if (dragging === null) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      const dx = x - dragStart.x;
      const dy = y - dragStart.y;
      dragStart = { x, y };
      offsets[dragging].x += dx;
      offsets[dragging].y += dy;
      renderAll(true);
    });
    canvas.addEventListener('mouseup', () => {
      dragging = null;
      isCanvasDragging = false;
      renderAll(true);
    });
    canvas.addEventListener('mouseleave', () => {
      dragging = null;
      isCanvasDragging = false;
      renderAll(true);
    });
  });

  function downloadImage(canvas, label) {
    renderAll(false);
    const now = new Date().toISOString().replace(/[:.]/g, '-');
    const link = document.createElement('a');
    link.download = `collage-${label}-${now}.jpg`;
    link.href = canvas.toDataURL('image/jpeg', 1.0);
    link.click();
    renderAll(true);
  }
</script>
</body>
</html>
