<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .image-slider {
            position: relative;
            overflow: hidden;
        }
        
        .slider-container {
            display: flex;
            transition: transform 0.3s ease;
        }
        
        .slider-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,102,0,0.8);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 10;
        }
        
        .slider-nav:hover {
            background: rgba(255,102,0,1);
        }
        
        .slider-nav.prev {
            left: 10px;
        }
        
        .slider-nav.next {
            right: 10px;
        }
        
        .slider-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .slider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .slider-dot.active {
            background: #ff6600;
        }
        
        .event-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #333;
        }
        
        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(255, 102, 0, 0.2), 0 10px 10px -5px rgba(255, 102, 0, 0.1);
            border-color: #ff6600;
        }
        
        .placeholder-image {
            background: linear-gradient(135deg, #ff6600 0%, #cc5200 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .loading-spinner {
            border: 4px solid #333;
            border-top: 4px solid #ff6600;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black min-h-full">
    <header class="bg-black shadow-sm border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 py-6 flex items-center gap-6">
            <img src="https://www.compassoffices.com/wp-content/themes/compass-offices/assets/images/compassoffices-logo-web-all-in-one-2025_ow.svg" alt="Compass Offices Logo" class="h-12 w-auto" onerror="this.style.display='none'">
            <h1 id="page-title" class="text-3xl font-bold text-white">Event Gallery</h1>
        </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Filter Section -->
        <div class="mb-8 flex flex-col sm:flex-row gap-4">
            <div class="relative flex-1 max-w-md">
                <input type="text" id="filter-input" placeholder="Search events..." class="w-full px-4 py-2 pl-10 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white text-black">
                <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <div class="relative">
                <select id="filter-dropdown" class="px-4 py-2 pr-8 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white text-black">
                    <option value="">All Events</option>
                </select>
                <svg class="absolute right-2 top-2.5 h-5 w-5 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
        <!-- Loading State -->
        <div id="loading-state" class="flex justify-center items-center py-16">
            <div class="loading-spinner"></div>
            <span class="ml-3 text-white">Loading events...</span>
        </div>
        <!-- Events Grid -->
        <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
        <!-- No Events Message -->
        <div id="no-events" class="text-center py-16 hidden">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p id="no-events-text" class="mt-4 text-lg text-white">No events found</p>
        </div>
    </main>
    <script>
        let allEvents = [];
        let filteredEvents = [];
        
        const defaultConfig = {
            page_title: "Event Gallery",
            filter_label: "Search events...",
            no_events_message: "No events found"
        };

        // Robust CSV parsing
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Fetch events from Google Sheet
        async function fetchEvents() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTIVKI_E2fEjdS6XT0GjkgvwqU2UBTIjVXBy8zUMWplk4984UFbXULf0bSZK2vhkkeG6k4LFimALywt/pub?gid=0&single=true&output=csv', {
                    cache: 'no-store' // Ensure fresh data
                });
                
                if (!response.ok) throw new Error('Failed to fetch CSV');
                
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim());
                
                if (lines.length < 1) return [];
                
                const headers = parseCSVLine(lines[0]);
                const events = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= headers.length) {
                        const event = {};
                        headers.forEach((header, index) => {
                            event[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
                        });
                        events.push({
                            eventName: event.event_name || '',
                            clientName: event.client_name || '',
                            date: event.date || '',
                            imageUrl: event.image_url || '',
                            displayUrl: event.display_url || ''
                        });
                    }
                }
                
                return events;
            } catch (error) {
                console.error('Error fetching events:', error);
                return [];
            }
        }

        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            
            const formats = [
                () => new Date(dateStr),
                () => {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        return new Date(parts[2], parts[0] - 1, parts[1]);
                    }
                    return null;
                },
                () => {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        return new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                    return null;
                }
            ];
            
            for (const format of formats) {
                try {
                    const date = format();
                    if (date && !isNaN(date.getTime())) return date;
                } catch (e) {
                    continue;
                }
            }
            
            return new Date(0);
        }

        function formatDate(dateStr) {
            const date = parseDate(dateStr);
            if (date.getTime() === 0) return dateStr;
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function groupEventsByDateAndName(events) {
            const grouped = {};
            
            events.forEach(event => {
                const key = `${event.date}-${event.eventName}-${event.clientName}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        ...event,
                        images: []
                    };
                }
                if (event.imageUrl) {
                    grouped[key].images.push({
                        url: event.imageUrl,
                        displayUrl: event.displayUrl
                    });
                } else if (grouped[key].images.length === 0) {
                    grouped[key].images.push({
                        url: '',
                        displayUrl: event.displayUrl
                    });
                }
            });
            
            return Object.values(grouped);
        }

        function createImageSlider(images, eventId) {
            if (images.length === 0 || !images[0].url) {
                return `<div class="placeholder-image w-full h-48 rounded-t-lg">ðŸ“…</div>`;
            }
            
            if (images.length === 1) {
                return `<img src="${images[0].url}" alt="Event image" class="w-full h-48 object-cover rounded-t-lg" onerror="this.parentElement.innerHTML='<div class=\\'placeholder-image w-full h-48 rounded-t-lg\\'>ðŸ“…</div>'">`;
            }
            
            const sliderId = `slider-${eventId}`;
            let sliderHTML = `
                <div class="image-slider w-full h-48 rounded-t-lg relative">
                    <div class="slider-container" id="${sliderId}-container">
            `;
            
            images.forEach((image, index) => {
                sliderHTML += `<img src="${image.url}" alt="Event image ${index + 1}" class="w-full h-48 object-cover flex-shrink-0" style="min-width: 100%" onerror="this.style.display='none'">`;
            });
            
            sliderHTML += `
                    </div>
                    <button class="slider-nav prev" onclick="previousSlide('${sliderId}')" aria-label="Previous image">â€¹</button>
                    <button class="slider-nav next" onclick="nextSlide('${sliderId}')" aria-label="Next image">â€º</button>
                    <div class="slider-dots">
            `;
            
            images.forEach((_, index) => {
                sliderHTML += `<div class="slider-dot ${index === 0 ? 'active' : ''}" onclick="goToSlide('${sliderId}', ${index})"></div>`;
            });
            
            sliderHTML += `</div></div>`;
            return sliderHTML;
        }

        function renderEvents(events) {
            const container = document.getElementById('events-container');
            const noEventsDiv = document.getElementById('no-events');
            const loadingDiv = document.getElementById('loading-state');
            
            loadingDiv.classList.add('hidden');
            
            if (events.length === 0) {
                container.classList.add('hidden');
                noEventsDiv.classList.remove('hidden');
                return;
            }
            
            noEventsDiv.classList.add('hidden');
            container.classList.remove('hidden');
            
            const groupedEvents = groupEventsByDateAndName(events);
            
            groupedEvents.sort((a, b) => {
                const dateA = parseDate(a.date);
                const dateB = parseDate(b.date);
                const now = new Date();
                const diffA = Math.abs(dateA.getTime() - now.getTime());
                const diffB = Math.abs(dateB.getTime() - now.getTime());
                return diffA - diffB;
            });
            
            container.innerHTML = groupedEvents.map((event, index) => `
                <div class="event-card bg-white rounded-lg shadow-md overflow-hidden">
                    ${createImageSlider(event.images, index)}
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-black mb-2">${event.eventName}</h3>
                        <p class="text-gray-700 mb-2">Client: ${event.clientName}</p>
                        <p class="text-gray-600 text-sm mb-4">${formatDate(event.date)}</p>
                        ${event.images.length > 0 && event.images[0].url ? `
                            <button onclick="downloadCurrentImage('${event.eventName}', ${JSON.stringify(event.images).replace(/"/g, '&quot;')}, 'slider-${index}')" 
                                    class="inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-md hover:bg-orange-700 transition-colors" style="background-color: #ff6600;">
                                Download Current Image
                                <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        const sliderStates = {};

        function initSlider(sliderId) {
            if (!sliderStates[sliderId]) {
                sliderStates[sliderId] = { currentIndex: 0 };
            }
        }

        function updateSlider(sliderId) {
            const container = document.getElementById(`${sliderId}-container`);
            const sliderElement = document.querySelector(`[id*="${sliderId.replace('slider-', '')}"] .slider-dots`);
            const dots = sliderElement ? sliderElement.querySelectorAll('.slider-dot') : [];
            
            if (container) {
                const translateX = -sliderStates[sliderId].currentIndex * 100;
                container.style.transform = `translateX(${translateX}%)`;
            }
            
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === sliderStates[sliderId].currentIndex);
            });
        }

        function nextSlide(sliderId) {
            initSlider(sliderId);
            const container = document.getElementById(`${sliderId}-container`);
            const imageCount = container ? container.children.length : 0;
            sliderStates[sliderId].currentIndex = (sliderStates[sliderId].currentIndex + 1) % imageCount;
            updateSlider(sliderId);
        }

        function previousSlide(sliderId) {
            initSlider(sliderId);
            const container = document.getElementById(`${sliderId}-container`);
            const imageCount = container ? container.children.length : 0;
            sliderStates[sliderId].currentIndex = sliderStates[sliderId].currentIndex === 0 
                ? imageCount - 1 
                : sliderStates[sliderId].currentIndex - 1;
            updateSlider(sliderId);
        }

        function goToSlide(sliderId, index) {
            initSlider(sliderId);
            sliderStates[sliderId].currentIndex = index;
            updateSlider(sliderId);
        }

        async function downloadCurrentImage(eventName, images, sliderId) {
            try {
                initSlider(sliderId);
                const currentIndex = sliderStates[sliderId].currentIndex;
                const currentImage = images[currentIndex];
                
                if (currentImage && currentImage.url) {
                    const response = await fetch(currentImage.url, { mode: 'cors' });
                    if (!response.ok) throw new Error('Failed to fetch image');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const urlParts = currentImage.url.split('.');
                    const extension = urlParts.length > 1 ? urlParts[urlParts.length - 1].split('?')[0] : 'jpg';
                    a.download = `${eventName.replace(/[^a-z0-9]/gi, '_')}_image_${currentIndex + 1}.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Error downloading image:', error);
                alert('Error downloading image. Please try again.');
            }
        }

        function populateFilterDropdown() {
            const dropdown = document.getElementById('filter-dropdown');
            const clients = [...new Set(allEvents.map(event => event.clientName))].sort();
            dropdown.innerHTML = '<option value="">All Events</option>';
            clients.forEach(client => {
                if (client) {
                    const option = document.createElement('option');
                    option.value = client;
                    option.textContent = client;
                    dropdown.appendChild(option);
                }
            });
        }

        function filterEvents() {
            const searchValue = document.getElementById('filter-input').value.toLowerCase();
            const selectedClient = document.getElementById('filter-dropdown').value;
            
            filteredEvents = allEvents.filter(event => {
                const matchesSearch = !searchValue || 
                    event.eventName.toLowerCase().includes(searchValue) ||
                    event.clientName.toLowerCase().includes(searchValue) ||
                    event.date.toLowerCase().includes(searchValue);
                const matchesClient = !selectedClient || event.clientName === selectedClient;
                return matchesSearch && matchesClient;
            });
            
            renderEvents(filteredEvents);
        }

        async function initialize() {
            document.getElementById('filter-input').addEventListener('input', filterEvents);
            document.getElementById('filter-dropdown').addEventListener('change', filterEvents);
            
            allEvents = await fetchEvents();
            filteredEvents = [...allEvents];
            populateFilterDropdown();
            renderEvents(filteredEvents);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
