<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hong Kong Events Dashboard</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .month-selector {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .month-selector label {
            font-weight: 600;
            font-size: 1rem;
        }

        .month-selector select {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .month-selector select:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .month-selector select option {
            background: #2c3e50;
            color: white;
            padding: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .events-container {
            padding: 30px;
        }

        .event-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
            position: relative;
        }

        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .event-card.today {
            border-left-color: #ff6b6b;
            background: linear-gradient(135deg, #ffe6e6, #ffcccc);
            border: 2px solid #ff6b6b;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
        }

        .event-card.today .event-title {
            color: #d63031;
        }

        .event-card.upcoming {
            border-left-color: #51cf66;
        }

        .event-date {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .date-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-right: 15px;
        }

        .today .date-badge {
            background: #ff6b6b;
        }

        .upcoming .date-badge {
            background: #51cf66;
        }

        .time-badge {
            background: #e9ecef;
            color: #495057;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .event-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
        }

        .detail-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            opacity: 0.7;
        }

        .detail-text {
            color: #555;
            font-weight: 500;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-events h3 {
            color: #999;
            margin-bottom: 10px;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #d63031;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .event-details {
                grid-template-columns: 1fr;
            }
            
            .event-date {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <main class="container">
   <header class="header">
    <h1>Compass Hong Kong Events</h1>
    <p>Upcoming events and today's schedule</p>
    <div class="month-selector"><label for="month-select">Filter by Month:</label> <select id="month-select"> <option value="all">All Months</option> <option value="0">January</option> <option value="1">February</option> <option value="2">March</option> <option value="3">April</option> <option value="4">May</option> <option value="5">June</option> <option value="6">July</option> <option value="7">August</option> <option value="8">September</option> <option value="9">October</option> <option value="10">November</option> <option value="11">December</option> </select>
    </div>
   </header>
   <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading Hong Kong events...</p>
   </div>
   <div id="events-container" class="events-container" style="display: none;">
    <div id="events-list"></div>
   </div>
   <div id="error-container" style="display: none;">
    <div class="error-message">
     <h3>Unable to load events</h3>
     <p>There was an issue fetching data from the Google Sheet. Please check the sheet URL and try again.</p>
    </div>
   </div>
  </main>
  <script>
        // Convert Google Sheets published URL to CSV format
        function getCSVUrl(publishedUrl) {
            // Extract spreadsheet ID from the provided URL
            const spreadsheetId = '1vTazGFKOEPVQu77BpCHV9rTo8odUfVeH7_k0xLjio7V4bUXw__hk14JMBJu0iDC3MewNy8Hw3kowOJt';
            const gid = '1632866699';
            
            return `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // Parse a single CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Parse date string to Date object
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Try different date formats
            const formats = [
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/, // MM/DD/YYYY or DD/MM/YYYY
                /(\d{4})-(\d{1,2})-(\d{1,2})/, // YYYY-MM-DD
                /(\d{1,2})-(\d{1,2})-(\d{4})/, // DD-MM-YYYY or MM-DD-YYYY
            ];

            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    // Assume DD/MM/YYYY format for the first pattern
                    if (format === formats[0]) {
                        return new Date(match[3], match[2] - 1, match[1]);
                    } else if (format === formats[1]) {
                        return new Date(match[1], match[2] - 1, match[3]);
                    } else {
                        return new Date(match[3], match[1] - 1, match[2]);
                    }
                }
            }
            
            // Fallback to native Date parsing
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        // Check if date is today
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // Check if date is upcoming (today or future)
        function isUpcoming(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const eventDate = new Date(date);
            eventDate.setHours(0, 0, 0, 0);
            return eventDate >= today;
        }

        // Get current month number (0-11)
        function getCurrentMonth() {
            return new Date().getMonth();
        }

        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Create event card HTML
        function createEventCard(event, eventDate) {
            const todayClass = isToday(eventDate) ? 'today' : (isUpcoming(eventDate) ? 'upcoming' : '');
            const dateLabel = isToday(eventDate) ? 'Today' : formatDate(eventDate);
            
            return `
                <div class="event-card ${todayClass}">
                    <div class="event-date">
                        <span class="date-badge">${dateLabel}</span>
                        ${event.Time ? `<span class="time-badge">${event.Time}</span>` : ''}
                    </div>
                    
                    <div class="event-title">${event['Event-Name'] || 'Untitled Event'}</div>
                    
                    <div class="event-details">
                        ${event['Client-Name'] ? `
                            <div class="detail-item">
                                <svg class="detail-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                </svg>
                                <span class="detail-text">${event['Client-Name']}</span>
                            </div>
                        ` : ''}
                        
                        ${event.Location ? `
                            <div class="detail-item">
                                <svg class="detail-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="detail-text">${event.Location}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Main function to load and display events
        async function loadEvents() {
            const csvUrl = getCSVUrl();
            
            try {
                // Try multiple methods to fetch the data
                let csvText = '';
                let success = false;

                // Method 1: Direct CSV export
                try {
                    const response = await fetch(csvUrl, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain,*/*'
                        }
                    });
                    if (response.ok) {
                        csvText = await response.text();
                        success = true;
                    }
                } catch (e) {
                    console.log('Method 1 failed, trying alternative...');
                }

                // Method 2: Alternative URL format
                if (!success) {
                    try {
                        const altUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTazGFKOEPVQu77BpCHV9rTo8odUfVeH7_k0xLjio7V4bUXw__hk14JMBJu0iDC3MewNy8Hw3kowOJt/pub?gid=1632866699&single=true&output=csv';
                        const response = await fetch(altUrl, {
                            mode: 'cors'
                        });
                        if (response.ok) {
                            csvText = await response.text();
                            success = true;
                        }
                    } catch (e) {
                        console.log('Method 2 failed, using sample data...');
                    }
                }

                // Method 3: Use sample data if fetch fails
                if (!success) {
                    csvText = `Time,Date,Client-Name,Region,Event-Name,Location,Reception,Details,Trigger,Confirmed,Quarter
10:00 AM,12/25/2024,ABC Corp,Hong Kong,Annual Conference,Central Plaza,Yes,Year-end meeting,Email,Yes,Q4
2:00 PM,12/26/2024,XYZ Ltd,Hong Kong,Product Launch,Tsim Sha Tsui,No,New product reveal,Phone,Yes,Q4
9:00 AM,12/27/2024,Tech Solutions,Hong Kong,Workshop,Wan Chai,Yes,Training session,Online,Yes,Q4
3:00 PM,12/28/2024,Global Inc,Hong Kong,Networking Event,Admiralty,Yes,Business networking,Email,Yes,Q4`;
                    
                    // Show a notice that we're using sample data
                    showSampleDataNotice();
                }
                
                const allEvents = parseCSV(csvText);
                
                // Filter for Hong Kong events only
                const hongKongEvents = allEvents.filter(event => 
                    event.Region && event.Region.toLowerCase().includes('hong kong')
                );

                // Parse dates - include ALL events with valid dates (not just upcoming)
                const eventsWithDates = hongKongEvents
                    .map(event => ({
                        ...event,
                        parsedDate: parseDate(event.Date)
                    }))
                    .filter(event => event.parsedDate);

                // Remove duplicates based on event name, date, and time
                const uniqueEvents = eventsWithDates.filter((event, index, array) => {
                    return index === array.findIndex(e => 
                        e['Event-Name'] === event['Event-Name'] &&
                        e.Date === event.Date &&
                        e.Time === event.Time &&
                        e['Client-Name'] === event['Client-Name']
                    );
                });

                // Sort by date
                const sortedEvents = uniqueEvents.sort((a, b) => a.parsedDate - b.parsedDate);

                // Store events globally
                allEventsData = sortedEvents;
                
                // Set default month to current month
                const currentMonth = getCurrentMonth();
                document.getElementById('month-select').value = currentMonth.toString();
                
                // Display events for current month by default
                filterEventsByMonth();
                
                // Set up month selector event listener
                document.getElementById('month-select').addEventListener('change', filterEventsByMonth);
                
            } catch (error) {
                console.error('Error loading events:', error);
                showError();
            }
        }

        // Global variable to store all events
        let allEventsData = [];

        // Display events in the UI
        function displayEvents(events) {
            const loadingEl = document.getElementById('loading');
            const containerEl = document.getElementById('events-container');
            const listEl = document.getElementById('events-list');

            loadingEl.style.display = 'none';
            containerEl.style.display = 'block';

            if (events.length === 0) {
                listEl.innerHTML = `
                    <div class="no-events">
                        <h3>No events found</h3>
                        <p>There are no Hong Kong events for the selected month.</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = events
                .map(event => createEventCard(event, event.parsedDate))
                .join('');
        }

        // Filter events by selected month
        function filterEventsByMonth() {
            const selectedMonth = document.getElementById('month-select').value;
            
            let filteredEvents = allEventsData;
            
            if (selectedMonth !== 'all') {
                const monthNum = parseInt(selectedMonth);
                filteredEvents = allEventsData.filter(event => 
                    event.parsedDate.getMonth() === monthNum
                );
            }
            
            // Custom sorting: Today's events first, then upcoming events by date, then past events
            filteredEvents.sort((a, b) => {
                const aIsToday = isToday(a.parsedDate);
                const bIsToday = isToday(b.parsedDate);
                const aIsUpcoming = isUpcoming(a.parsedDate);
                const bIsUpcoming = isUpcoming(b.parsedDate);
                
                // Today's events always come first
                if (aIsToday && !bIsToday) return -1;
                if (!aIsToday && bIsToday) return 1;
                
                // If both are today or both are not today, sort by upcoming status
                if (aIsUpcoming && !bIsUpcoming) return -1;
                if (!aIsUpcoming && bIsUpcoming) return 1;
                
                // Within the same category (both today, both upcoming, or both past), sort by date
                return a.parsedDate - b.parsedDate;
            });
            
            displayEvents(filteredEvents);
        }

        // Show error message
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-container').style.display = 'block';
        }

        // Show sample data notice
        function showSampleDataNotice() {
            const header = document.querySelector('.header p');
            header.innerHTML = 'Showing sample data - Please ensure your Google Sheet is publicly accessible';
            header.style.background = 'rgba(255,255,255,0.2)';
            header.style.padding = '10px';
            header.style.borderRadius = '8px';
            header.style.marginTop = '15px';
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', loadEvents);

        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: {},
                render: async (config) => {},
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map()
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f817da26cf20de',t:'MTc2MDYyMzMzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
