<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Compass Events</title>
    
    <style>
        :root {
            --bg: #f8f9fa;
            --card-white: #ffffff;
            --card-past: #f1f3f5;
            --text: #2d3436;
            --accent: #ff6600;
            --border: #dfe6e9;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body {
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 12px 10px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        header {
            padding: 20px 0 24px;
            text-align: center;
            position: relative;
        }
        .header-title {
            margin: 0 0 4px;
            font-size: clamp(1.9rem, 6.5vw, 2.6rem);
            color: #111;
        }
        .header-subtitle {
            margin: 0;
            color: var(--accent);
            font-size: clamp(1rem, 4vw, 1.15rem);
        }
        .filter-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 50%;
            color: var(--accent);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            z-index: 100;
        }
        .filter-toggle:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(255,102,0,0.2);
        }
        .filters-panel {
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin: 16px 0 32px;
        }
        .filters-panel.show {
            display: block;
        }
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }
        .filter-group {
            flex: 1 1 140px;
            min-width: 140px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #4b5563;
            font-size: 0.9rem;
        }
        select, button {
            width: 100%;
            padding: 10px 12px;
            background: #fff;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
        }
        button.reset-btn {
            background: var(--accent);
            color: white;
            border: none;
            font-weight: 600;
        }
        button.reset-btn:hover {
            background: #e65c00;
        }
        select:focus, button:focus {
            border-color: var(--accent);
            outline: none;
        }
        .event-count {
            text-align: center;
            color: #6b7280;
            margin: 16px 0 24px;
            font-size: 1.1rem;
        }
        .carousel-container {
            position: relative;
            overflow: hidden;
        }
        .carousel {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 8px 0 24px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) #d1d5db;
        }
        .carousel::-webkit-scrollbar {
            height: 6px;
        }
        .carousel::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 6px;
        }
        .event-card {
            background: var(--card);
            border-radius: 16px;
            width: 280px;
            min-width: 280px;
            padding: 18px;
            box-shadow: var(--shadow);
            border: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .event-card.past {
            background: var(--card-past);
            border-color: #d1d5db;
            color: #6b7280;
        }
        .event-card.today {
            border: 3px solid var(--accent);
            box-shadow: 0 8px 24px rgba(255,102,0,0.18);
        }
        .event-card.today .big-date,
        .event-card.today .event-title,
        .event-card.today .event-date-info {
            color: var(--accent);
        }
        .big-date {
            font-size: 3.2rem;
            font-weight: 900;
            color: #444;
            line-height: 1;
            margin-bottom: 4px;
            text-align: center;
        }
        .event-date-info {
            font-size: 0.95rem;
            color: #6b7280;
            text-align: center;
            margin-bottom: 10px;
        }
        .event-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 10px;
            color: #111;
            text-align: center;
        }
        .event-info {
            font-size: 0.92rem;
            line-height: 1.5;
            margin: 6px 0;
        }
        .event-info strong {
            color: #374151;
        }
        .no-events {
            text-align: center;
            color: #9ca3af;
            font-size: 1.2rem;
            padding: 80px 20px;
        }
        @media (max-width: 600px) {
            .event-card { width: 88vw; min-width: 88vw; padding: 16px; }
            .big-date { font-size: 2.6rem; }
            .filter-toggle { top: 16px; right: 16px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Compass Events</h1>
        <p class="header-subtitle">This Month's Schedule</p>
        <button class="filter-toggle" id="filter-toggle">⚙</button>
    </header>

    <div class="filters-panel" id="filters-panel">
        <div class="filter-row">
            <div class="filter-group">
                <label>Year</label>
                <select id="year-select"><option value="all">All Years</option></select>
            </div>
            <div class="filter-group">
                <label>Month</label>
                <select id="month-select">
                    <option value="all">All Months</option>
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <label>Region</label>
                <select id="region-select"><option value="all">All Regions</option></select>
            </div>
            <div class="filter-group">
                <label>Location</label>
                <select id="location-select"><option value="all">All Locations</option></select>
            </div>
            <div class="filter-group">
                <button class="reset-btn" id="reset-btn">Reset to Today</button>
            </div>
        </div>
    </div>

    <div class="event-count" id="event-count">Loading events...</div>

    <div class="carousel-container">
        <div class="carousel" id="event-carousel"></div>
    </div>
</div>

<script>
// ──────────────────────────────────────────────
const SPREADSHEET_ID = '1vTazGFKOEPVQu77BpCHV9rTo8odUfVeH7_k0xLjio7V4bUXw__hk14JMBJu0iDC3MewNy8Hw3kowOJt';
const GID = '1632866699';

let allEvents = [];

async function loadEvents() {
    document.getElementById('event-count').textContent = 'Loading events...';
    let csvText = '', success = false;

    // Try 1: Standard export URL (most reliable when sheet is shared properly)
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${GID}`;
        const res = await fetch(url, { mode: 'cors', cache: 'no-store' });
        if (res.ok) {
            csvText = await res.text();
            success = true;
            console.log('Loaded from export URL');
        }
    } catch (e) {
        console.log('Export URL failed:', e);
    }

    // Try 2: Published URL fallback (your working one)
    if (!success) {
        try {
            const alt = `https://docs.google.com/spreadsheets/d/e/2PACX-1vTazGFKOEPVQu77BpCHV9rTo8odUfVeH7_k0xLjio7V4bUXw__hk14JMBJu0iDC3MewNy8Hw3kowOJt/pub?gid=${GID}&output=csv`;
            const res = await fetch(alt, { mode: 'cors', cache: 'no-store' });
            if (res.ok) {
                csvText = await res.text();
                success = true;
                console.log('Loaded from published URL');
            }
        } catch (e) {
            console.log('Published URL failed:', e);
        }
    }

    if (!success || !csvText.trim() || csvText.length < 50) {
        document.getElementById('event-carousel').innerHTML = '<div class="no-events">Failed to load events<br><small>→ Please check: Sheet must be published to web as CSV (File → Share → Publish to web)</small></div>';
        document.getElementById('event-count').textContent = 'Error loading data';
        return;
    }

    try {
        allEvents = parseCSV(csvText)
            .map(r => ({ ...r, parsedDate: parseDate(r.Date) }))
            .filter(r => r.parsedDate)
            .sort((a,b) => a.parsedDate - b.parsedDate);

        console.log(`Loaded ${allEvents.length} events`);
        populateFilters();
        filterAndRender();
    } catch (err) {
        document.getElementById('event-carousel').innerHTML = '<div class="no-events">Data loaded but invalid<br><small>Error: ' + err.message + '</small></div>';
    }
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g,''));
    return lines.slice(1).filter(l=>l.trim()).map(line => {
        const vals = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v=>v.trim().replace(/^"|"$/g,''));
        const obj = {};
        headers.forEach((h,i) => obj[h] = vals[i] || '');
        return obj;
    });
}

function parseDate(str) {
    if (!str) return null;
    str = str.trim();
    const m = str.match(/(\d{1,2})[/-](\d{1,2})[/-](\d{4})/) || str.match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/);
    if (!m) return null;
    return m[1].length === 4 ? new Date(+m[1], +m[2]-1, +m[3]) : new Date(+m[3], +m[2]-1, +m[1]);
}

function populateFilters() {
    const years = [...new Set(allEvents.map(e => e.parsedDate.getFullYear()))].sort((a,b)=>b-a);
    const yearSel = document.getElementById('year-select');
    yearSel.innerHTML = '<option value="all">All Years</option>';
    years.forEach(y => yearSel.add(new Option(y, y)));
    yearSel.value = new Date().getFullYear();

    updateRegionFilter();
    updateLocationFilter();
}

function updateRegionFilter() {
    let ev = filterByYearAndMonth();
    const regions = [...new Set(ev.map(e => e.Region?.trim()).filter(Boolean))].sort();
    const sel = document.getElementById('region-select');
    sel.innerHTML = '<option value="all">All Regions</option>';
    regions.forEach(r => sel.add(new Option(r, r)));
}

function updateLocationFilter() {
    let ev = filterByYearAndMonth();
    const reg = document.getElementById('region-select').value;
    if (reg !== 'all') ev = ev.filter(e => e.Region === reg);
    const locs = [...new Set(ev.map(e => e.Location?.trim()).filter(Boolean))].sort();
    const sel = document.getElementById('location-select');
    sel.innerHTML = '<option value="all">All Locations</option>';
    locs.forEach(l => sel.add(new Option(l, l)));
}

function filterByYearAndMonth() {
    let ev = allEvents;
    const y = document.getElementById('year-select').value;
    const m = document.getElementById('month-select').value;
    if (y !== 'all') ev = ev.filter(e => e.parsedDate.getFullYear() === +y);
    if (m !== 'all') ev = ev.filter(e => e.parsedDate.getMonth() === +m);
    return ev;
}

function resetToToday() {
    const now = new Date();
    document.getElementById('year-select').value = now.getFullYear();
    document.getElementById('month-select').value = now.getMonth();
    document.getElementById('region-select').value = 'all';
    document.getElementById('location-select').value = 'all';
    setTimeout(() => document.getElementById('filters-panel').classList.remove('show'), 300);
    filterAndRender();
}

function filterAndRender() {
    let events = filterByYearAndMonth();
    const reg = document.getElementById('region-select').value;
    const loc = document.getElementById('location-select').value;
    if (reg !== 'all') events = events.filter(e => e.Region === reg);
    if (loc !== 'all') events = events.filter(e => e.Location === loc);

    events.sort((a, b) => a.parsedDate - b.parsedDate);

    const now = new Date();
    const todayStr = now.toDateString();

    const past = events.filter(e => e.parsedDate.toDateString() < todayStr);
    const todayEvents = events.filter(e => e.parsedDate.toDateString() === todayStr);
    const future = events.filter(e => e.parsedDate.toDateString() > todayStr);

    const orderedEvents = [...past, ...todayEvents, ...future];

    document.getElementById('event-count').textContent = orderedEvents.length 
        ? `${orderedEvents.length} event${orderedEvents.length > 1 ? 's' : ''} this month • Today: ${todayEvents.length}`
        : 'No events this month';

    renderCarousel(orderedEvents);
}

function renderCarousel(events) {
    const carousel = document.getElementById('event-carousel');
    carousel.innerHTML = '';

    if (events.length === 0) {
        carousel.innerHTML = '<div class="no-events">No events this month</div>';
        return;
    }

    events.forEach(e => {
        const date = e.parsedDate;
        const isTodayEvent = date.toDateString() === new Date().toDateString();
        const isPast = date < new Date();

        const card = document.createElement('div');
        card.className = 'event-card' + (isPast ? ' past' : '') + (isTodayEvent ? ' today' : '');

        const dayNum = date.getDate();
        const monthYear = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        const weekday = date.toLocaleDateString('en-US', { weekday: 'long' });

        card.innerHTML = `
            <div class="big-date">${dayNum}</div>
            <div class="event-date-info">${weekday}, ${monthYear}${isTodayEvent ? ' • Today' : ''}</div>
            <div class="event-title">${e['Event-Name'] || 'Event'}</div>
            <div class="event-info"><strong>Time:</strong> ${e.Time || '—'}</div>
            <div class="event-info"><strong>Client:</strong> ${e['Client-Name'] || '—'}</div>
            <div class="event-info"><strong>Location:</strong> ${e.Location || '—'}</div>
            <div class="event-info"><strong>Region:</strong> ${e.Region || '—'}</div>
            ${e.Details ? `<div class="event-info"><strong>Details:</strong><br>${e.Details}</div>` : ''}
        `;
        carousel.appendChild(card);
    });

    setTimeout(() => {
        const todayCards = Array.from(carousel.children).filter(c => c.classList.contains('today'));
        const targetCard = todayCards.length > 0 
            ? todayCards[0] 
            : carousel.firstElementChild;

        if (targetCard) {
            targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }, 400);
}

// Toggle filters panel
const toggleBtn = document.getElementById('filter-toggle');
const panel = document.getElementById('filters-panel');

toggleBtn.onclick = () => {
    panel.classList.toggle('show');
};

document.addEventListener('click', e => {
    if (!panel.contains(e.target) && e.target !== toggleBtn) {
        panel.classList.remove('show');
    }
});

// Auto-hide panel after filter change
document.querySelectorAll('#filters-panel select').forEach(sel => {
    sel.onchange = () => {
        setTimeout(() => panel.classList.remove('show'), 300);
        filterAndRender();
    };
});

// Reset to Today inside filters
document.getElementById('reset-btn').onclick = () => {
    const now = new Date();
    document.getElementById('year-select').value = now.getFullYear();
    document.getElementById('month-select').value = now.getMonth();
    document.getElementById('region-select').value = 'all';
    document.getElementById('location-select').value = 'all';
    setTimeout(() => panel.classList.remove('show'), 300);
    filterAndRender();
};

// Start
loadEvents();
</script>
</body>
</html>
