<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Poster Generator</title>
  <link rel="icon" type="image/png" href="https://www.compassoffices.com/wp-content/uploads/2025/09/compassoffices-logo-web-2025_icon-o-scaled.png">
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
        body {box-sizing:border-box;}
        .poster-template{
            width:595px;height:842px;position:relative;overflow:hidden;
            box-shadow:0 8px 32px rgba(0,0,0,0.1);background:white;
            transform:scale(0.85);transform-origin:top center;margin-bottom:-126px;
        }
        .email-banner{
            width:600px;height:200px;position:relative;overflow:visible;
            box-shadow:0 4px 16px rgba(0,0,0,0.1);background:white;
            transform:scale(1);transform-origin:top left;margin-bottom:0;
        }
        .loading-spinner{
            border:3px solid #f3f4f6;border-top:3px solid #3b82f6;
            border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;
        }
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .form-section{background:linear-gradient(135deg,#2d3748 0%,#1a202c 100%);}
        .preview-section{background:linear-gradient(135deg,#4a5568 0%,#2d3748 100%);}
        .download-btn{background:linear-gradient(45deg,#ff6600,#e55a00);}
        .download-btn:hover{background:linear-gradient(45deg,#e55a00,#cc4f00);}
        .pdf-btn{background:linear-gradient(45deg,#7c3aed,#5b21b6);}
        .pdf-btn:hover{background:linear-gradient(45deg,#5b21b6,#4c1d95);}

        /* Rich Text */
        [contenteditable="true"]:empty:before{content:attr(data-placeholder);color:rgba(255,255,255,0.7);pointer-events:none;}
        [contenteditable="true"]:focus:before{display:none;}
        .rich-editor{outline:none;}
        .rich-editor strong{font-weight:bold;}
        .rich-editor em{font-style:italic;}
        .rich-editor ul{list-style-type:disc;margin-left:20px;margin:8px 0;}
        .rich-editor ol{list-style-type:decimal;margin-left:20px;margin:8px 0;}
        .rich-editor li{margin-bottom:4px;}
        .rich-editor p{margin-bottom:8px;}
        .rich-editor p:last-child{margin-bottom:0;}

        /* Drag handle */
        .drag-handle{
            position:absolute;top:-8px;right:-8px;width:20px;height:20px;
            background:#ff6600;border-radius:50%;cursor:move;display:none;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
        }
        .draggable:hover .drag-handle{display:block;}

        /* Resize handle (bottom-right) */
        .resize-handle{
            position:absolute;bottom:-6px;right:-6px;width:16px;height:16px;
            background:#ff6600;border-radius:50%;cursor:nwse-resize;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
        }
        .resizable:hover .resize-handle{display:block;}
    </style>
 </head>
 <body class="min-h-full bg-gray-100">
  <div class="min-h-full">
   <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4">
     <h1 id="main-title" class="text-3xl font-bold text-gray-900">Event Poster Generator</h1>
     <p class="text-gray-600 mt-2">Create stunning event posters and email banners with customizable layouts</p>
    </div>
   </header>

   <div class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">

     <!-- ==== FORM ==== -->
     <div class="form-section rounded-2xl p-8 text-white lg:col-span-2">
      <h2 class="text-2xl font-bold mb-6">Create New Event</h2>
      <form id="eventForm" class="space-y-6">

       <!-- Title -->
       <div><label for="event_title" class="block text-sm font-medium mb-2">Event Title</label>
        <div class="space-y-3">
         <div class="relative">
          <div id="titleEditor" contenteditable="true" class="rich-editor w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 resize-none min-h-[60px] max-h-[120px] overflow-y-auto" data-placeholder="Summer Music Festival"></div>
          <input type="hidden" id="event_title" name="event_title" required>
         </div>
         <div class="flex flex-wrap gap-2">
          <button type="button" id="titleBold" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors font-bold">Bold</button>
          <button type="button" id="titleThin" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors font-thin">Thin</button>
          <button type="button" id="titleSmall" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors" style="font-size:10px;">Small</button>
          <button type="button" id="titleLarge" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors" style="font-size:16px;">Large</button>
          <button type="button" id="titleClear" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Clear</button>
         </div>
         <div><label for="title_font_size" class="block text-xs font-medium mb-1 text-white/80">Title Font Size</label>
          <select id="title_font_size" name="title_font_size" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
           <option value="16">16px</option><option value="18">18px</option><option value="20">20px</option><option value="22">22px</option><option value="24">24px</option><option value="26">26px</option><option value="28">28px</option><option value="30">30px</option><option value="32" selected>32px</option><option value="34">34px</option><option value="36">36px</option><option value="38">38px</option><option value="40">40px</option><option value="42">42px</option><option value="44">44px</option><option value="46">46px</option><option value="48">48px</option><option value="50">50px</option><option value="52">52px</option><option value="54">54px</option><option value="56">56px</option><option value="58">58px</option><option value="60">60px</option>
          </select>
         </div>
        </div>
       </div>

       <!-- Date / Time -->
       <div><label for="event_date" class="block text-sm font-medium mb-2">Date</label>
        <input type="date" id="event_date" name="event_date" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50"></div>
       <div class="grid grid-cols-2 gap-4">
        <div><label for="event_time" class="block text-sm font-medium mb-2">Start Time</label>
         <input type="time" id="event_time" name="event_time" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50"></div>
        <div><label for="end_time" class="block text-sm font-medium mb-2">End Time</label>
         <input type="time" id="end_time" name="end_time" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50"></div>
       </div>

       <!-- Location -->
       <div><label for="location" class="block text-sm font-medium mb-2">Location</label>
        <input type="text" id="location" name="location" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Central Park, New York"></div>

       <!-- Description -->
       <div><label for="description" class="block text-sm font-medium mb-2">Description</label>
        <div class="space-y-3">
         <div class="relative">
          <div id="descriptionEditor" contenteditable="true" class="rich-editor w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 resize-none min-h-[80px] max-h-[200px] overflow-y-auto" data-placeholder="Join us for an amazing evening of music and entertainment"></div>
          <input type="hidden" id="description" name="description">
         </div>
         <div class="flex flex-wrap gap-2">
          <button type="button" id="descBold" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors font-bold">Bold</button>
          <button type="button" id="descItalic" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors italic">Italic</button>
          <button type="button" id="descBullet" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Bullet List</button>
          <button type="button" id="descNumber" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Number List</button>
          <button type="button" id="descClear" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Clear</button>
         </div>
        </div>
       </div>

       <!-- Images / Colors -->
       <div><label for="image_url" class="block text-sm font-medium mb-2">Key Image URL (300x300)</label>
        <input type="url" id="image_url" name="image_url" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="https://example.com/key-image.jpg"></div>
       <div><label for="qr_code_url" class="block text-sm font-medium mb-2">QR Code URL (Auto-Generate)</label>
        <input type="url" id="qr_code_url" name="qr_code_url" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="https://example.com/event-page"><p class="text-xs text-white/70 mt-1">Enter any URL to auto-generate QR code</p></div>
       <div><label for="secondary_image_url" class="block text-sm font-medium mb-2">Secondary Image URL (Optional)</label>
        <input type="url" id="secondary_image_url" name="secondary_image_url" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="https://example.com/secondary-image.jpg"></div>
       <div class="grid grid-cols-2 gap-4">
        <div><label for="content_background_color" class="block text-sm font-medium mb-2">Content Background</label>
         <input type="color" id="content_background_color" name="content_background_color" value="#f8f9fa" class="w-full h-12 rounded-lg border border-white/30 bg-white/20 cursor-pointer"></div>
        <div><label for="banner_background_color" class="block text-sm font-medium mb-2">Banner Background</label>
         <input type="color" id="banner_background_color" name="banner_background_color" value="#3b82f6" class="w-full h-12 rounded-lg border border-white/30 bg-white/20 cursor-pointer"></div>
       </div>

       <!-- Email Banner Text -->
       <div class="space-y-4">
        <h3 class="text-lg font-semibold text-white">Email Banner Text</h3>
        <div><label for="banner_title" class="block text-sm font-medium mb-2">Banner Title</label>
         <input type="text" id="banner_title" name="banner_title" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Join us for an amazing event"></div>
        <div><label for="banner_subtitle" class="block text-sm font-medium mb-2">Banner Subtitle</label>
         <input type="text" id="banner_subtitle" name="banner_subtitle" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Don't miss this incredible opportunity"></div>
       </div>

       <div class="mt-6">
        <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center">
         <span id="submitSpinner" class="loading-spinner hidden mr-2"></span>
         <span>Create Event</span>
        </button>
       </div>
      </form>
     </div>

     <!-- ==== PREVIEW ==== -->
     <div class="preview-section rounded-2xl p-8 text-white lg:col-span-3">
      <h2 class="text-2xl font-bold mb-6">Live Previews</h2>
      <div class="space-y-8">

       <!-- Poster -->
       <div>
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-semibold">Event Poster</h3>
         <div class="flex gap-2">
          <button id="downloadPoster" class="download-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200">JPG</button>
          <button id="downloadPosterPDF" class="pdf-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200">PDF</button>
         </div>
        </div>
        <div class="flex justify-center">
         <div id="posterPreview" class="poster-template bg-blue-500 overflow-hidden"></div>
        </div>
       </div>

       <!-- Email Banner -->
       <div>
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-semibold">Email Banner</h3>
         <div class="flex gap-2">
          <button id="downloadBanner" class="download-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200">JPG</button>
          <button id="downloadBannerPDF" class="pdf-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200">PDF</button>
          <button onclick="copyShareableURL()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200">Share URL</button>
         </div>
        </div>
        <div class="flex justify-center">
         <div id="bannerPreview" class="email-banner bg-blue-500 overflow-hidden"></div>
        </div>
       </div>

      </div>
     </div>
    </div>

    <!-- Gallery (unchanged) -->
    <div class="mt-12">
     <h2 class="text-2xl font-bold text-gray-900 mb-6">Your Event Gallery</h2>
     <div id="eventsGallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
     <div id="emptyState" class="text-center py-12 text-gray-500">
      <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>
      <p class="text-lg">No events yet</p>
      <p class="text-sm">Create your first event poster using the form above</p>
     </div>
    </div>
   </div>
  </div>

  <script>
    // ---------- CONFIG & SDK ----------
    const defaultConfig = { default_organizer: "Your Organization", contact_info: "contact@example.com", website_url: "www.example.com" };
    let currentData = [], isLoading = false;

    const dataHandler = { onDataChanged(d){ currentData=d; updateDataCount(); renderEventsGallery(); updatePreviewWithLatest(); }};
    const elementConfig = { defaultConfig, onConfigChange: async c=>updatePreviewWithConfig(c), mapToCapabilities:c=>({}), mapToEditPanelValues:c=>new Map([["default_organizer",c.default_organizer||defaultConfig.default_organizer],["contact_info",c.contact_info||defaultConfig.contact_info],["website_url",c.website_url||defaultConfig.website_url]]) };

    async function initializeApp(){
        try{
            if(window.elementSdk) await window.elementSdk.init(elementConfig);
            if(window.dataSdk){ const r=await window.dataSdk.init(dataHandler); if(!r.isOk) console.warn("Data storage not available");}
            initializePreview(); setupDownloadHandlers(); setTimeout(updateLivePreview,200);
        }catch(e){ console.error(e); initializePreview(); setupDownloadHandlers(); setTimeout(updateLivePreview,200);}
    }

    // ---------- PREVIEW INITIAL ----------
    function initializePreview(){
        const sample={event_title:"Summer Music Festival",event_date:"2024-07-15",event_time:"18:00",end_time:"22:00",location:"Lee Garden 1, 24/F, Central Park",description:"Join us for an amazing evening of music and entertainment under the stars. Experience live performances from top artists.",content_background_color:"#f8f9fa",title_font_size:"32",banner_title:"Join us for an amazing event",banner_subtitle:"Don't miss this incredible opportunity",image_url:"",qr_code_url:"",secondary_image_url:""};
        updatePreviewElements(sample);
    }

    // ---------- RICH TEXT ----------
    function setupRichTextEditors(){
        const titleEditor=document.getElementById('titleEditor');
        const descEditor=document.getElementById('descriptionEditor');
        const titleHidden=document.getElementById('event_title');
        const descHidden=document.getElementById('description');

        titleEditor.innerHTML='Summer Music Festival';
        descEditor.innerHTML='Join us for an amazing evening of music and entertainment';

        titleEditor.addEventListener('input',()=>{titleHidden.value=titleEditor.innerHTML;updateLivePreview();});
        descEditor.addEventListener('input',()=>{descHidden.value=descEditor.innerHTML;updateLivePreview();});

        document.getElementById('titleBold').onclick=()=>applyFormatting('bold',titleEditor);
        document.getElementById('titleThin').onclick=()=>{applyFormatting('removeFormat',titleEditor);applyFormatting('fontWeight',titleEditor,'100');};
        document.getElementById('titleClear').onclick=()=>applyFormatting('removeFormat',titleEditor);
        document.getElementById('titleSmall').onclick=()=>applyFormatting('fontSize',titleEditor,'1');
        document.getElementById('titleLarge').onclick=()=>applyFormatting('fontSize',titleEditor,'7');

        document.getElementById('descBold').onclick=()=>applyFormatting('bold',descEditor);
        document.getElementById('descItalic').onclick=()=>applyFormatting('italic',descEditor);
        document.getElementById('descBullet').onclick=()=>applyFormatting('insertUnorderedList',descEditor);
        document.getElementById('descNumber').onclick=()=>applyFormatting('insertOrderedList',descEditor);
        document.getElementById('descClear').onclick=()=>applyFormatting('removeFormat',descEditor);

        titleHidden.value=titleEditor.innerHTML;
        descHidden.value=descEditor.innerHTML;
    }

    function applyFormatting(cmd,editor,val=null){
        editor.focus();
        if(cmd==='fontWeight'){
            const sel=window.getSelection();
            if(sel.rangeCount){
                const range=sel.getRangeAt(0);
                if(!range.collapsed){
                    const span=document.createElement('span');
                    span.style.fontWeight=val;
                    try{range.surroundContents(span);}catch{const c=range.extractContents();span.appendChild(c);range.insertNode(span);}
                    sel.removeAllRanges();
                }
            }
        }else document.execCommand(cmd,false,val);
        const hidden=editor.id==='titleEditor'?document.getElementById('event_title'):document.getElementById('description');
        hidden.value=editor.innerHTML;
        updateLivePreview();
    }

    function processRichText(html){
        if(!html) return '';
        let p=html.replace(/<div>/g,'<p>').replace(/<\/div>/g,'</p>').replace(/<br\s*\/?>/g,'<br>').replace(/&nbsp;/g,' ');
        if(!p.includes('<p>')&&!p.includes('<ul>')&&!p.includes('<ol>')&&!p.includes('<strong>')&&!p.includes('<em>')) p=`<p>${p}</p>`;
        return p
            .replace(/<ul>/g,'<ul style="margin:8px 0;padding-left:20px;list-style:disc;">')
            .replace(/<ol>/g,'<ol style="margin:8px 0;padding-left:20px;list-style:decimal;">')
            .replace(/<li>/g,'<li style="margin-bottom:4px;line-height:1.5;">')
            .replace(/<p>/g,'<p style="margin:0 0 8px 0;line-height:1.6;">')
            .replace(/<strong>/g,'<strong style="font-weight:700;color:#2d3748;">')
            .replace(/<em>/g,'<em style="font-style:italic;color:#4a5568;">');
    }

    // ---------- LIVE PREVIEW ----------
    function updateLivePreview(){
        const titleEditor=document.getElementById('titleEditor');
        const descEditor=document.getElementById('descriptionEditor');
        const eventData={
            event_title:titleEditor.innerHTML||'Summer Music Festival',
            event_date:document.getElementById('event_date').value||'2024-07-15',
            event_time:document.getElementById('event_time').value||'18:00',
            end_time:document.getElementById('end_time').value||'22:00',
            location:document.getElementById('location').value||'Central Park, New York',
            description:descEditor.innerHTML||'Join us...',
            image_url:document.getElementById('image_url').value||'',
            qr_code_url:document.getElementById('qr_code_url').value||'',
            secondary_image_url:document.getElementById('secondary_image_url').value||'',
            content_background_color:document.getElementById('content_background_color').value||'#f8f9fa',
            title_font_size:document.getElementById('title_font_size').value||'32',
            banner_title:document.getElementById('banner_title').value||'Join us for an amazing event',
            banner_subtitle:document.getElementById('banner_subtitle').value||'Don\'t miss this incredible opportunity'
        };
        updatePreviewElements(eventData);
    }

    // ---------- FORM SUBMIT ----------
    document.getElementById('eventForm').onsubmit=async e=>{
        e.preventDefault();
        if(isLoading||currentData.length>=999) return showError("Max 999 events.");
        const f=new FormData(e.target);
        const data={
            id:Date.now().toString(),
            event_title:f.get('event_title'),
            event_date:f.get('event_date'),
            event_time:f.get('event_time'),
            end_time:f.get('end_time')||'',
            location:f.get('location'),
            description:f.get('description')||'',
            image_url:f.get('image_url')||'',
            qr_code_url:f.get('qr_code_url')||'',
            secondary_image_url:f.get('secondary_image_url')||'',
            content_background_color:f.get('content_background_color')||'#f8f9fa',
            title_font_size:f.get('title_font_size')||'32',
            banner_title:f.get('banner_title')||'Join us for an amazing event',
            banner_subtitle:f.get('banner_subtitle')||'Don\'t miss this incredible opportunity',
            created_at:new Date().toISOString()
        };
        await submitEventData(data);
    };

    async function submitEventData(data){
        setLoading(true);
        try{
            if(window.dataSdk){
                const r=await window.dataSdk.create(data);
                if(r.isOk){document.getElementById('eventForm').reset();showSuccess("Saved!");setTimeout(updateLivePreview,100);}
                else showError("Save failed.");
            }else{document.getElementById('eventForm').reset();showSuccess("Created!");setTimeout(updateLivePreview,100);}
        }catch{showError("Error.");}finally{setLoading(false);}
    }

    // ---------- HTML GENERATORS ----------
    function generatePosterHTML(event){
        const formattedDate=formatDate(event.event_date);
        const timeRange=event.end_time?`${formatTime(event.event_time)} - ${formatTime(event.end_time)}`:formatTime(event.event_time);
        const titleFontSize=event.title_font_size||'32';
        const qrSrc=event.qr_code_url?`https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(event.qr_code_url)}`:'';

        return `
            <div style="width:595px;height:842px;background:white;position:relative;overflow:hidden;">
                <!-- Header -->
                <div style="width:595px;height:300px;background:linear-gradient(135deg,#ff6600 0%,#e55a00 100%);display:flex;">
                    <div style="width:297.5px;height:300px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.95);">
                        <div style="font-size:${titleFontSize}px;line-height:1.2;color:#2d3748;text-align:left;margin:0;padding:20px;word-wrap:break-word;font-weight:600;">${processRichText(event.event_title)}</div>
                    </div>
                    <div style="width:297.5px;height:300px;background:#f8f9fa;overflow:hidden;">
                        ${event.image_url?`<img src="${event.image_url}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';">`:`<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;"><svg width=80 height=80 fill=currentColor viewBox='0 0 20 20'><path d='M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z'/></svg></div>`}
                    </div>
                </div>

                <!-- Content area (472px high) -->
                <div id="contentArea" style="width:595px;height:472px;background:${event.content_background_color||'#fff'};padding:25px;box-sizing:border-box;position:relative;">

                    <!-- ==== RESIZABLE DESCRIPTION (NO SCROLL) ==== -->
                    <div id="descBox" class="draggable resizable" style="position:absolute;top:25px;left:25px;width:545px;min-height:100px;overflow:hidden;background:rgba(255,255,255,0.9);padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <div class="drag-handle"></div>
                        <div class="resize-handle"></div>
                        <h2 style="font-size:22px;font-weight:bold;margin-bottom:12px;color:#2d3748;border-bottom:2px solid #ff6600;padding-bottom:8px;display:inline-block;">About This Event</h2>
                        <div id="descText" style="font-size:15px;line-height:1.6;color:#4a5568;">${processRichText(event.description)||'Event description...'}</div>
                    </div>

                    <!-- Info card -->
                    <div class="draggable" style="position:absolute;top:180px;left:25px;width:350px;">
                        <div class="drag-handle"></div>
                        <div style="background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);padding:20px;border-radius:15px;border:1px solid #dee2e6;box-shadow:0 4px 12px rgba(0,0,0,0.08);">
                            <div style="display:flex;align-items:center;padding:12px 0;"><div style="width:24px;height:24px;margin-right:12px;"><img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-01.svg" style="width:100%;height:100%;"></div><div style="font-size:15px;color:#2d3748;font-weight:500;">${formattedDate}</div></div>
                            <div style="height:1px;background:linear-gradient(90deg,#dee2e6 0%,#adb5bd 50%,#dee2e6 100%);"></div>
                            <div style="display:flex;align-items:center;padding:12px 0;"><div style="width:24px;height:24px;margin-right:12px;"><img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-02.svg" style="width:100%;height:100%;"></div><div style="font-size:15px;color:#2d3748;font-weight:500;">${timeRange}</div></div>
                            <div style="height:1px;background:linear-gradient(90deg,#dee2e6 0%,#adb5bd 50%,#dee2e6 100%);"></div>
                            <div style="display:flex;align-items:center;padding:12px 0;"><div style="width:24px;height:24px;margin-right:12px;"><img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-03.svg" style="width:100%;height:100%;"></div><div style="font-size:15px;color:#2d3748;font-weight:500;line-height:1.4;">${event.location}</div></div>
                        </div>
                    </div>

                    <!-- QR -->
                    ${qrSrc?`<div class="draggable" style="position:absolute;top:180px;right:25px;width:140px;height:140px;"><div class="drag-handle"></div><div style="background:white;padding:10px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:1px solid #dee2e6;"><img src="${qrSrc}" style="width:100%;height:100%;object-fit:contain;"></div></div>`:''}

                    <!-- Secondary image -->
                    ${event.secondary_image_url?`<div class="draggable" style="position:absolute;top:340px;left:25px;width:200px;height:100px;"><div class="drag-handle"></div><img src="${event.secondary_image_url}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);"></div>`:''}
                </div>

                <!-- Footer logo -->
                <div style="width:100%;height:70px;background:white;position:absolute;bottom:0;left:0;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                    <img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-04.svg" style="width:100%;height:100%;object-fit:cover;object-position:center;">
                </div>
            </div>`;
    }

    function generateBannerHTML(event){
        const info=`${formatSimplifiedDate(event.event_date)} | ${formatSimplifiedTime(event.event_time,event.end_time)} | ${event.location.split(',')[0]}`;
        return `
            <div style="width:600px;height:200px;background:white;color:#333;display:flex;align-items:center;padding:30px;box-sizing:border-box;position:relative;border:1px solid #dee2e6;">
                <div style="position:absolute;top:15px;left:30px;background:#2d3748;color:white;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:500;">${info}</div>
                <div style="flex:1;padding-right:30px;margin-top:20px;">
                    <div style="font-size:24px;margin-bottom:8px;line-height:1.2;font-weight:bold;color:#333;">${event.banner_title||event.event_title}</div>
                    <p style="font-size:16px;margin:0;line-height:1.4;color:#666;">${event.banner_subtitle||'Join us for an amazing event'}</p>
                </div>
                <div style="width:140px;height:140px;background:#f8f9fa;border-radius:8px;overflow:hidden;border:1px solid #dee2e6;">
                    ${event.image_url?`<img src="${event.image_url}" style="width:100%;height:100%;object-fit:cover;">`:`<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;"><svg width=60 height=60 fill=currentColor viewBox='0 0 20 20'><path d='M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z'/></svg></div>`}
                </div>
            </div>`;
    }

    // ---------- DRAG + RESIZE ----------
    function makeDraggableAndResizable(){
        // ----- DRAG -----
        document.querySelectorAll('.draggable').forEach(el=>{
            let isDragging=false,startX,startY,initLeft,initTop;
            const handle=el.querySelector('.drag-handle')||el;

            const startDrag=e=>{
                isDragging=true;
                startX=e.clientX; startY=e.clientY;
                const rect=el.getBoundingClientRect();
                const parent=el.parentElement.getBoundingClientRect();
                initLeft=rect.left-parent.left;
                initTop=rect.top-parent.top;
                el.style.zIndex='1000';
                e.preventDefault();
            };
            handle.addEventListener('mousedown',startDrag);
            el.addEventListener('mousedown',e=>{if(e.target===el||e.target.closest('.drag-handle')) startDrag(e);});

            document.addEventListener('mousemove',e=>{
                if(!isDragging) return;
                const dx=e.clientX-startX, dy=e.clientY-startY;
                const maxX=el.parentElement.offsetWidth-el.offsetWidth;
                const maxY=el.parentElement.offsetHeight-el.offsetHeight;
                const newL=Math.max(0,Math.min(initLeft+dx,maxX));
                const newT=Math.max(0,Math.min(initTop+dy,maxY));
                el.style.left=newL+'px';
                el.style.top=newT+'px';
            });
            document.addEventListener('mouseup',()=>{if(isDragging){isDragging=false;el.style.zIndex='auto';}});
        });

        // ----- RESIZE (only description box) -----
        const descBox=document.getElementById('descBox');
        if(!descBox) return;
        let isResizing=false,startX,startY,initW,initH;

        const resizeHandle=descBox.querySelector('.resize-handle');
        resizeHandle.addEventListener('mousedown',e=>{
            isResizing=true;
            startX=e.clientX; startY=e.clientY;
            initW=descBox.offsetWidth; initH=descBox.offsetHeight;
            e.preventDefault();
        });

        document.addEventListener('mousemove',e=>{
            if(!isResizing) return;
            const dx=e.clientX-startX, dy=e.clientY-startY;
            const newW=Math.max(200,initW+dx);           // min width
            const newH=Math.max(100,initH+dy);           // min height
            const maxW=descBox.parentElement.offsetWidth - descBox.offsetLeft - 20;
            const maxH=descBox.parentElement.offsetHeight - descBox.offsetTop - 20;
            descBox.style.width=Math.min(newW,maxW)+'px';
            descBox.style.height=Math.min(newH,maxH)+'px';
        });

        document.addEventListener('mouseup',()=>{isResizing=false;});
    }

    function updatePreviewElements(eventData){
        document.getElementById('posterPreview').innerHTML=generatePosterHTML(eventData);
        document.getElementById('bannerPreview').innerHTML=generateBannerHTML(eventData);
        setTimeout(makeDraggableAndResizable,100);
    }

    // ---------- DOWNLOAD ----------
    async function downloadElement(id,name){
        const btn=id==='posterPreview'?document.getElementById('downloadPoster'):document.getElementById('downloadBanner');
        const orig=btn.textContent;
        btn.innerHTML='<div class="loading-spinner inline-block mr-2"></div>Generating...';
        btn.disabled=true;
        try{
            const el=document.getElementById(id);
            await Promise.all([...el.querySelectorAll('img')].map(i=>new Promise(r=>{if(i.complete)r();else i.onload=i.onerror=r;})));
            const w=id==='posterPreview'?595:600;
            const h=id==='posterPreview'?842:200;
            const canvas=await html2canvas(el,{backgroundColor:'#fff',scale:2,useCORS:true,width:w,height:h});
            canvas.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=name.replace(/\.png$/i,'.jpg');a.click();URL.revokeObjectURL(a.href);showSuccess('Downloaded!');},'image/jpeg',0.92);
        }catch{showError('Download failed.');}finally{btn.innerHTML=orig;btn.disabled=false;}
    }

    async function exportToPDF(id,name){
        const btn=id==='posterPreview'?document.getElementById('downloadPosterPDF'):document.getElementById('downloadBannerPDF');
        const orig=btn.textContent;
        btn.innerHTML='<div class="loading-spinner inline-block mr-2"></div>Generating PDF...';
        btn.disabled=true;
        try{
            const el=document.getElementById(id);
            await Promise.all([...el.querySelectorAll('img')].map(i=>new Promise(r=>{if(i.complete)r();else i.onload=i.onerror=r;})));
            const w=id==='posterPreview'?595:600;
            const h=id==='posterPreview'?842:200;
            const canvas=await html2canvas(el,{backgroundColor:'#fff',scale:2,useCORS:true,width:w,height:h});
            const {jsPDF}=window.jspdf;
            const pdf=new jsPDF({orientation:id==='posterPreview'?'portrait':'landscape',unit:'px',format:[w,h]});
            pdf.addImage(canvas.toDataURL('image/jpeg',0.95),'JPEG',0,0,w,h);
            pdf.save(name.replace(/\.png$/i,'.pdf'));
            showSuccess('PDF downloaded!');
        }catch{showError('PDF failed.');}finally{btn.innerHTML=orig;btn.disabled=false;}
    }

    function setupDownloadHandlers(){
        document.getElementById('downloadPoster').onclick=()=>downloadElement('posterPreview','event-poster.jpg');
        document.getElementById('downloadBanner').onclick=()=>downloadElement('bannerPreview','event-banner.jpg');
        document.getElementById('downloadPosterPDF').onclick=()=>exportToPDF('posterPreview','event-poster.pdf');
        document.getElementById('downloadBannerPDF').onclick=()=>exportToPDF('bannerPreview','event-banner.pdf');
    }

    // ---------- HELPERS ----------
    function formatDate(d){if(!d)return'TBD';return new Date(d).toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'short',day:'numeric'});}
    function formatTime(t){if(!t)return'TBD';const[h,m]=t.split(':');const dt=new Date();dt.setHours(+h,+m);return dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});}
    function formatSimplifiedDate(d){if(!d)return'TBD';const dt=new Date(d);return `${dt.getDate()}.${dt.getMonth()+1}.${dt.getFullYear()}`;}
    function formatSimplifiedTime(s,e){if(!s)return'TBD';const f=t=>{const[h,m]=t.split(':');const hr=+h;const ampm=hr>=12?'pm':'am';const dh=hr===0?12:hr>12?hr-12:hr;return m==='00'?`${dh}${ampm}`:`${dh}:${m}${ampm}`;};return e?`${f(s)}-${f(e)}`:f(s);}

    function setLoading(l){isLoading=l;const b=document.getElementById('submitBtn');const s=document.getElementById('submitSpinner');if(l){b.disabled=true;b.classList.add('opacity-75');s.classList.remove('hidden');}else{b.disabled=false;b.classList.remove('opacity-75');s.classList.add('hidden');}}
    function showSuccess(m){showToast(m,'success');}
    function showError(m){showToast(m,'error');}
    function showToast(m,t){const d=document.createElement('div');d.className=`fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${t==='success'?'bg-green-500':'bg-red-500'}`;d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);}

    function copyShareableURL(){/* unchanged */} 
    function autoFillFromURL(){/* unchanged */}

    // ---------- START ----------
    document.addEventListener('DOMContentLoaded',()=>{
        initializeApp();
        setupRichTextEditors();
        document.querySelectorAll('#eventForm input, #eventForm select').forEach(i=>{i.addEventListener('input',updateLivePreview);i.addEventListener('change',updateLivePreview);});
        setTimeout(()=>{if(autoFillFromURL()){showSuccess('Auto-filled from URL!');updateLivePreview();}},500);
        setTimeout(makeDraggableAndResizable,500);
    });
  </script>
 </body>
</html>
