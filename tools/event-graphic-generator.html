<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Poster Generator</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.herokuapp.com/dist/html2canvas.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .poster-template {
            width: 595px;
            height: 842px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            background: white;
            transform: scale(0.85);
            transform-origin: top center;
            margin-bottom: -126px;
        }
        .email-banner {
            width: 600px;
            height: 200px;
            position: relative;
            overflow: visible;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            background: white;
            transform: scale(1.0);
            transform-origin: top left;
            margin-bottom: 0px;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .form-section {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
        .preview-section {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        .layout-option {
            cursor: pointer;
            transition: all 0.2s;
        }
        .layout-option:hover {
            transform: scale(1.05);
        }
        .layout-option.selected {
            ring: 2px;
            ring-color: white;
        }
        .download-btn {
            background: linear-gradient(45deg, #ff6600, #e55a00);
        }
        .download-btn:hover {
            background: linear-gradient(45deg, #e55a00, #cc4f00);
        }
        
        /* Rich Text Editor Styles */
        [contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
        }
        
        [contenteditable="true"]:focus:before {
            display: none;
        }
        
        .rich-editor {
            outline: none;
        }
        
        .rich-editor strong {
            font-weight: bold;
        }
        
        .rich-editor em {
            font-style: italic;
        }
        
        .rich-editor ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        .rich-editor ol {
            list-style-type: decimal;
            margin-left: 20px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        .rich-editor li {
            margin-bottom: 4px;
        }
        
        .rich-editor p {
            margin-bottom: 8px;
        }
        
        .rich-editor p:last-child {
            margin-bottom: 0;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gray-100">
  <div class="min-h-full"><!-- Header -->
   <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4">
     <h1 id="main-title" class="text-3xl font-bold text-gray-900">Event Poster Generator</h1>
     <p class="text-gray-600 mt-2">Create stunning event posters and email banners with customizable layouts</p>
    </div>
   </header>
   <div class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8"><!-- Event Data Input Section -->
     <div class="form-section rounded-2xl p-8 text-white lg:col-span-2">
      <h2 class="text-2xl font-bold mb-6">Create New Event</h2>
      <form id="eventForm" class="space-y-6">
       <div><label for="event_title" class="block text-sm font-medium mb-2">Event Title</label>
        <div class="space-y-3"><!-- Rich Text Editor for Title -->
         <div class="relative">
          <div id="titleEditor" contenteditable="true" class="rich-editor w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 resize-none min-h-[60px] max-h-[120px] overflow-y-auto" style="line-height: 1.4;" data-placeholder="Summer Music Festival"></div><input type="hidden" id="event_title" name="event_title" required>
         </div><!-- Title Formatting Controls -->
         <div class="flex flex-wrap gap-2"><button type="button" id="titleBold" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors font-bold"> <strong>B</strong> Bold </button> <button type="button" id="titleThin" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors font-thin"> T Thin </button> <button type="button" id="titleSmall" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors" style="font-size: 10px;"> Small </button> <button type="button" id="titleLarge" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors" style="font-size: 16px;"> Large </button> <button type="button" id="titleClear" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors"> ✕ Clear Format </button>
         </div><!-- Font Size Control -->
         <div><label for="title_font_size" class="block text-xs font-medium mb-1 text-white/80">Title Font Size</label> <select id="title_font_size" name="title_font_size" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 text-sm"> <option value="16">16px</option> <option value="18">18px</option> <option value="20">20px</option> <option value="22">22px</option> <option value="24">24px</option> <option value="26">26px</option> <option value="28">28px</option> <option value="30">30px</option> <option value="32" selected>32px</option> <option value="34">34px</option> <option value="36">36px</option> <option value="38">38px</option> <option value="40">40px</option> <option value="42">42px</option> <option value="44">44px</option> <option value="46">46px</option> <option value="48">48px</option> <option value="50">50px</option> <option value="52">52px</option> <option value="54">54px</option> <option value="56">56px</option> <option value="58">58px</option> <option value="60">60px</option> </select>
         </div><!-- Hidden inputs for formatting --> <input type="hidden" id="title_alignment" name="title_alignment" value="left"> <input type="hidden" id="title_formatting" name="title_formatting" value="">
        </div>
       </div>
       <div><label for="event_date" class="block text-sm font-medium mb-2">Date</label> <input type="date" id="event_date" name="event_date" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
       </div>
       <div class="grid grid-cols-2 gap-4">
        <div><label for="event_time" class="block text-sm font-medium mb-2">Start Time</label> <input type="time" id="event_time" name="event_time" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
        </div>
        <div><label for="end_time" class="block text-sm font-medium mb-2">End Time</label> <input type="time" id="end_time" name="end_time" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
        </div>
       </div>
       <div><label for="location" class="block text-sm font-medium mb-2">Location</label> <input type="text" id="location" name="location" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Central Park, New York">
       </div>
       <div><label for="description" class="block text-sm font-medium mb-2">Description</label>
        <div class="space-y-3"><!-- Rich Text Editor for Description -->
         <div class="relative">
          <div id="descriptionEditor" contenteditable="true" class="rich-editor w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 resize-none min-h-[80px] max-h-[200px] overflow-y-auto" style="line-height: 1.6;" data-placeholder="Join us for an amazing evening of music and entertainment"></div><input type="hidden" id="description" name="description">
         </div><!-- Description Formatting Controls -->
         <div class="flex flex-wrap gap-2"><button type="button" id="descBold" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors font-bold"> <strong>B</strong> Bold </button> <button type="button" id="descItalic" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors italic"> <em>I</em> Italic </button> <button type="button" id="descBullet" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors"> • Bullet List </button> <button type="button" id="descNumber" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors"> 1. Number List </button> <button type="button" id="descClear" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors"> ✕ Clear Format </button>
         </div>
        </div>
       </div>
       <div><label for="image_url" class="block text-sm font-medium mb-2">Key Image URL (300x300)</label> <input type="url" id="image_url" name="image_url" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="https://example.com/key-image.jpg">
       </div>
       <div><label for="qr_code_url" class="block text-sm font-medium mb-2">QR Code URL (Auto-Generate)</label> <input type="url" id="qr_code_url" name="qr_code_url" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="https://example.com/event-page">
        <p class="text-xs text-white/70 mt-1">Enter any URL to auto-generate QR code</p>
       </div>
       <div><label for="secondary_image_url" class="block text-sm font-medium mb-2">Secondary Image URL (Optional)</label> <input type="url" id="secondary_image_url" name="secondary_image_url" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="https://example.com/secondary-image.jpg">
       </div><!-- Color Controls -->
       <div class="grid grid-cols-2 gap-4">
        <div><label for="content_background_color" class="block text-sm font-medium mb-2">Content Background</label> <input type="color" id="content_background_color" name="content_background_color" value="#f8f9fa" class="w-full h-12 rounded-lg border border-white/30 bg-white/20 cursor-pointer">
        </div>
        <div><label for="banner_background_color" class="block text-sm font-medium mb-2">Banner Background</label> <input type="color" id="banner_background_color" name="banner_background_color" value="#3b82f6" class="w-full h-12 rounded-lg border border-white/30 bg-white/20 cursor-pointer">
        </div>
       </div><!-- Banner Text Controls -->
       <div class="space-y-4">
        <h3 class="text-lg font-semibold text-white">Email Banner Text</h3>
        <div><label for="banner_title" class="block text-sm font-medium mb-2">Banner Title</label> <input type="text" id="banner_title" name="banner_title" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Join us for an amazing event">
        </div>
        <div><label for="banner_subtitle" class="block text-sm font-medium mb-2">Banner Subtitle</label> <input type="text" id="banner_subtitle" name="banner_subtitle" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Don't miss this incredible opportunity">
        </div>
       </div>
      </form>
     </div><!-- Preview Section -->
     <div class="preview-section rounded-2xl p-8 text-white lg:col-span-3">
      <h2 class="text-2xl font-bold mb-6">Live Previews</h2>
      <div class="space-y-8"><!-- Poster Preview -->
       <div>
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-semibold">Event Poster</h3><button id="downloadPoster" class="download-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200"> 📥 Download Poster </button>
        </div>
        <div class="flex justify-center">
         <div id="posterPreview" class="poster-template bg-blue-500 overflow-hidden"><!-- Poster content will be dynamically generated -->
         </div>
        </div>
       </div><!-- Email Banner Preview -->
       <div>
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-semibold">Email Banner</h3><button id="downloadBanner" class="download-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200"> 📥 Download Banner </button>
        </div>
        <div class="flex justify-center">
         <div id="bannerPreview" class="email-banner bg-blue-500 overflow-hidden"><!-- Banner content will be dynamically generated -->
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Generated Events Gallery -->
    <div class="mt-12">
     <h2 class="text-2xl font-bold text-gray-900 mb-6">Your Event Gallery</h2>
     <div id="eventsGallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Events will be populated here -->
     </div>
     <div id="emptyState" class="text-center py-12 text-gray-500">
      <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
      </svg>
      <p class="text-lg">No events yet</p>
      <p class="text-sm">Create your first event poster using the form above</p>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            default_organizer: "Your Organization",
            contact_info: "contact@example.com",
            website_url: "www.example.com"
        };

        let currentData = [];
        let isLoading = false;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                currentData = data;
                updateDataCount();
                renderEventsGallery();
                updatePreviewWithLatest();
            }
        };

        // Element SDK Implementation
        const elementConfig = {
            defaultConfig,
            onConfigChange: async (config) => {
                // Update form placeholders and preview with config values
                updatePreviewWithConfig(config);
            },
            mapToCapabilities: (config) => ({
                recolorables: [
                    {
                        get: () => config.primary_color || "#667eea",
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.secondary_color || "#f093fb",
                        set: (value) => {
                            config.secondary_color = value;
                            window.elementSdk.setConfig({ secondary_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: {
                    get: () => config.font_family || "Inter",
                    set: (value) => {
                        config.font_family = value;
                        window.elementSdk.setConfig({ font_family: value });
                    }
                },
                fontSizeable: {
                    get: () => config.font_size || 16,
                    set: (value) => {
                        config.font_size = value;
                        window.elementSdk.setConfig({ font_size: value });
                    }
                }
            }),
            mapToEditPanelValues: (config) => new Map([
                ["default_organizer", config.default_organizer || defaultConfig.default_organizer],
                ["contact_info", config.contact_info || defaultConfig.contact_info],
                ["website_url", config.website_url || defaultConfig.website_url]
            ])
        };

        // Initialize SDKs
        async function initializeApp() {
            try {
                // Initialize Element SDK
                if (window.elementSdk) {
                    await window.elementSdk.init(elementConfig);
                }

                // Initialize Data SDK
                if (window.dataSdk) {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        console.warn("Data storage not available, continuing without persistence");
                    }
                }

                // Initialize preview with sample data
                initializePreview();
                
                // Setup download handlers
                setupDownloadHandlers();
                
                // Trigger initial live preview
                setTimeout(updateLivePreview, 200);
            } catch (error) {
                console.error("Initialization error:", error);
                // Continue with basic functionality even if SDKs fail
                initializePreview();
                setupDownloadHandlers();
                setTimeout(updateLivePreview, 200);
            }
        }

        function initializePreview() {
            const sampleEvent = {
                event_title: "Summer Music Festival",
                event_date: "2024-07-15",
                event_time: "18:00",
                end_time: "22:00",
                location: "Lee Garden 1, 24/F, Central Park",
                description: "Join us for an amazing evening of music and entertainment under the stars. Experience live performances from top artists.",
                background_color: "#ff6600",
                banner_background_color: "#ff6600",
                content_background_color: "#f8f9fa",
                layout_style: "classic",
                title_font_size: "32",
                banner_title: "Join us for an amazing event",
                banner_subtitle: "Don't miss this incredible opportunity",
                image_url: "",
                qr_code_url: "",
                secondary_image_url: ""
            };
            updatePreviewElements(sampleEvent);
        }

        // Real-time preview updates
        function setupRealTimePreview() {
            const formInputs = document.querySelectorAll('#eventForm input, #eventForm select');
            
            formInputs.forEach(input => {
                input.addEventListener('input', updateLivePreview);
                input.addEventListener('change', updateLivePreview);
            });
            
            // Setup rich text editors
            setupRichTextEditors();
        }
        
        function setupRichTextEditors() {
            // Setup title editor
            const titleEditor = document.getElementById('titleEditor');
            const titleHidden = document.getElementById('event_title');
            
            // Setup description editor
            const descEditor = document.getElementById('descriptionEditor');
            const descHidden = document.getElementById('description');
            
            // Initialize with sample content
            titleEditor.innerHTML = 'Summer Music Festival';
            descEditor.innerHTML = 'Join us for an amazing evening of music and entertainment';
            
            // Update hidden fields when content changes
            titleEditor.addEventListener('input', () => {
                titleHidden.value = titleEditor.innerHTML;
                updateLivePreview();
            });
            
            descEditor.addEventListener('input', () => {
                descHidden.value = descEditor.innerHTML;
                updateLivePreview();
            });
            
            // Title formatting controls
            document.getElementById('titleBold').addEventListener('click', () => {
                applyFormatting('bold', titleEditor);
            });
            
            document.getElementById('titleThin').addEventListener('click', () => {
                applyFormatting('removeFormat', titleEditor);
                applyFormatting('fontWeight', titleEditor, '100');
            });
            
            document.getElementById('titleClear').addEventListener('click', () => {
                applyFormatting('removeFormat', titleEditor);
            });
            
            document.getElementById('titleSmall').addEventListener('click', () => {
                applyFormatting('fontSize', titleEditor, '1');
            });
            
            document.getElementById('titleLarge').addEventListener('click', () => {
                applyFormatting('fontSize', titleEditor, '7');
            });
            
            // Description formatting controls
            document.getElementById('descBold').addEventListener('click', () => {
                applyFormatting('bold', descEditor);
            });
            
            document.getElementById('descItalic').addEventListener('click', () => {
                applyFormatting('italic', descEditor);
            });
            
            document.getElementById('descBullet').addEventListener('click', () => {
                applyFormatting('insertUnorderedList', descEditor);
            });
            
            document.getElementById('descNumber').addEventListener('click', () => {
                applyFormatting('insertOrderedList', descEditor);
            });
            
            document.getElementById('descClear').addEventListener('click', () => {
                applyFormatting('removeFormat', descEditor);
            });
            
            // Update hidden fields initially
            titleHidden.value = titleEditor.innerHTML;
            descHidden.value = descEditor.innerHTML;
        }
        
        function applyFormatting(command, editor, value = null) {
            editor.focus();
            
            if (command === 'fontWeight') {
                // Apply font weight to selection
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    if (!range.collapsed) {
                        const span = document.createElement('span');
                        span.style.fontWeight = value;
                        try {
                            range.surroundContents(span);
                        } catch (e) {
                            // If can't surround, extract and wrap
                            const contents = range.extractContents();
                            span.appendChild(contents);
                            range.insertNode(span);
                        }
                        selection.removeAllRanges();
                    }
                }
            } else {
                document.execCommand(command, false, value);
            }
            
            // Update hidden field
            const hiddenField = editor.id === 'titleEditor' ? 
                document.getElementById('event_title') : 
                document.getElementById('description');
            hiddenField.value = editor.innerHTML;
            
            updateLivePreview();
        }

        function processRichText(htmlContent) {
            if (!htmlContent) return '';
            
            // Clean up the HTML and ensure it displays properly
            let processed = htmlContent
                .replace(/<div>/g, '<p>')
                .replace(/<\/div>/g, '</p>')
                .replace(/<br\s*\/?>/g, '<br>')
                .replace(/&nbsp;/g, ' ')
                .replace(/<p><\/p>/g, '') // Remove empty paragraphs
                .replace(/<p>\s*<\/p>/g, ''); // Remove paragraphs with only whitespace
            
            // Ensure proper paragraph structure for plain text
            if (!processed.includes('<p>') && !processed.includes('<ul>') && !processed.includes('<ol>') && !processed.includes('<strong>') && !processed.includes('<em>')) {
                processed = `<p>${processed}</p>`;
            }
            
            // Add proper styling to lists
            processed = processed
                .replace(/<ul>/g, '<ul style="margin: 8px 0; padding-left: 20px; list-style-type: disc;">')
                .replace(/<ol>/g, '<ol style="margin: 8px 0; padding-left: 20px; list-style-type: decimal;">')
                .replace(/<li>/g, '<li style="margin-bottom: 4px; line-height: 1.5;">')
                .replace(/<p>/g, '<p style="margin: 0 0 8px 0; line-height: 1.6;">')
                .replace(/<strong>/g, '<strong style="font-weight: 700; color: #2d3748;">')
                .replace(/<em>/g, '<em style="font-style: italic; color: #4a5568;">');
            
            return processed;
        }

        function updateLivePreview() {
            const titleEditor = document.getElementById('titleEditor');
            const descEditor = document.getElementById('descriptionEditor');
            
            const eventData = {
                event_title: titleEditor.innerHTML || 'Summer Music Festival',
                event_date: document.getElementById('event_date').value || '2024-07-15',
                event_time: document.getElementById('event_time').value || '18:00',
                end_time: document.getElementById('end_time').value || '22:00',
                location: document.getElementById('location').value || 'Central Park, New York',
                description: descEditor.innerHTML || 'Join us for an amazing evening of music and entertainment under the stars. Experience live performances from top artists.',
                image_url: document.getElementById('image_url').value || '',
                qr_code_url: document.getElementById('qr_code_url').value || '',
                secondary_image_url: document.getElementById('secondary_image_url').value || '',
                background_color: '#ff6600',
                banner_background_color: document.getElementById('banner_background_color').value || '#ff6600',
                content_background_color: document.getElementById('content_background_color').value || '#f8f9fa',
                layout_style: 'classic',
                title_font_size: document.getElementById('title_font_size').value || '32',
                title_alignment: document.getElementById('title_alignment').value || 'left',
                title_formatting: document.getElementById('title_formatting').value || '',
                banner_title: document.getElementById('banner_title').value || 'Join us for an amazing event',
                banner_subtitle: document.getElementById('banner_subtitle').value || 'Don\'t miss this incredible opportunity'
            };
            
            updatePreviewElements(eventData);
        }

        // Form submission
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isLoading) return;
            
            // Check data limit
            if (currentData.length >= 999) {
                showError("Maximum limit of 999 events reached. Please delete some events first.");
                return;
            }

            const formData = new FormData(e.target);
            const eventData = {
                id: Date.now().toString(),
                event_title: formData.get('event_title'),
                event_date: formData.get('event_date'),
                event_time: formData.get('event_time'),
                end_time: formData.get('end_time') || '',
                location: formData.get('location'),
                description: formData.get('description') || '',
                image_url: formData.get('image_url') || '',
                qr_code_url: formData.get('qr_code_url') || '',
                secondary_image_url: formData.get('secondary_image_url') || '',
                background_color: '#ff6600',
                banner_background_color: formData.get('banner_background_color') || '#ff6600',
                content_background_color: formData.get('content_background_color') || '#f8f9fa',
                layout_style: 'classic',
                title_font_size: formData.get('title_font_size') || '32',
                title_alignment: formData.get('title_alignment') || 'left',
                title_formatting: formData.get('title_formatting') || '',
                banner_title: formData.get('banner_title') || 'Join us for an amazing event',
                banner_subtitle: formData.get('banner_subtitle') || 'Don\'t miss this incredible opportunity',
                created_at: new Date().toISOString()
            };

            await submitEventData(eventData);
        });

        async function submitEventData(data) {
            setLoading(true);
            
            try {
                if (window.dataSdk) {
                    const result = await window.dataSdk.create(data);
                    if (result.isOk) {
                        document.getElementById('eventForm').reset();
                        showSuccess("Event poster created and saved successfully!");
                        // Update preview with default values after reset
                        setTimeout(updateLivePreview, 100);
                    } else {
                        showError("Failed to save event. Please try again.");
                    }
                } else {
                    // If no data SDK, just show success for the creation
                    document.getElementById('eventForm').reset();
                    showSuccess("Event poster created successfully!");
                    setTimeout(updateLivePreview, 100);
                }
            } catch (error) {
                showError("An error occurred while saving.");
                console.error('Submit error:', error);
            } finally {
                setLoading(false);
            }
        }

        function updatePreviewWithConfig(config) {
            // Update preview elements with config values if no current data
            if (currentData.length === 0) {
                const sampleEvent = {
                    event_title: "Summer Music Festival",
                    event_date: "2024-07-15",
                    event_time: "18:00",
                    location: "Central Park, New York",
                    description: "Join us for an amazing evening of music and entertainment",
                    background_color: "#ff6600",
                    layout_style: "classic",
                    image_url: ""
                };
                updatePreviewElements(sampleEvent, config);
            }
        }

        function updatePreviewWithLatest() {
            if (currentData.length > 0) {
                const latest = currentData[currentData.length - 1];
                updatePreviewElements(latest);
            }
        }

        function updatePreviewElements(eventData, config = null) {
            const currentConfig = config || (window.elementSdk?.config || defaultConfig);
            
            // Generate poster HTML
            const posterHTML = generatePosterHTML(eventData, currentConfig);
            document.getElementById('posterPreview').innerHTML = posterHTML;

            // Generate banner HTML
            const bannerHTML = generateBannerHTML(eventData, currentConfig);
            document.getElementById('bannerPreview').innerHTML = bannerHTML;
            
            // Re-enable drag functionality after updating preview
            setTimeout(makeDraggable, 100);
        }

        function generatePosterHTML(event, config) {
            const formattedDate = formatDate(event.event_date);
            const startTime = formatTime(event.event_time);
            const endTime = event.end_time ? formatTime(event.end_time) : '';
            const timeRange = endTime ? `${startTime} - ${endTime}` : startTime;
            const titleFontSize = event.title_font_size || '32';
            
            // Process title formatting
            const alignment = event.title_alignment || 'left';
            const formats = event.title_formatting ? event.title_formatting.split(',') : [];
            
            let titleStyle = `font-size: ${titleFontSize}px; line-height: 1.2; color: #333; text-align: ${alignment}; margin: 0; padding: 20px; word-wrap: break-word;`;
            
            if (formats.includes('bold')) titleStyle += ' font-weight: bold;';
            else if (formats.includes('thin')) titleStyle += ' font-weight: 100;';
            else titleStyle += ' font-weight: 600;';
            
            // Generate QR code URL if provided
            const qrCodeSrc = event.qr_code_url ? `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(event.qr_code_url)}` : '';
            
            return `
                <div style="width: 595px; height: 842px; background: white; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                    <!-- Header Section (595x300) -->
                    <div style="width: 595px; height: 300px; background: linear-gradient(135deg, #ff6600 0%, #e55a00 100%); display: flex; position: relative;">
                        <!-- Event Title Area (297.5x300) -->
                        <div style="width: 297.5px; height: 300px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; background: rgba(255,255,255,0.95);">
                            <div style="${titleStyle.replace('color: #333', 'color: #2d3748')}">${processRichText(event.event_title)}</div>
                        </div>
                        
                        <!-- Key Image (297.5x300) -->
                        <div style="width: 297.5px; height: 300px; background-color: #f8f9fa; overflow: hidden; position: relative;">
                            ${event.image_url ? 
                                `<img src="${event.image_url}" alt="Event" style="width: 100%; height: 100%; object-fit: cover; display: block;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#666;background:#f8f9fa;\\'><svg width=\\'80\\' height=\\'80\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'><path fill-rule=\\'evenodd\\' d=\\'M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z\\' clip-rule=\\'evenodd\\'/></svg></div>';">` :
                                `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;background:#f8f9fa;"><svg width="80" height="80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/></svg></div>`
                            }
                        </div>
                    </div>
                    
                    <!-- Content Body (595x472) -->
                    <div style="width: 595px; height: 472px; background: ${event.content_background_color || '#ffffff'}; color: #333; position: relative; padding: 25px; box-sizing: border-box;">
                        <!-- About This Event -->
                        <div class="draggable" style="position: absolute; top: 25px; left: 25px; width: 545px; max-height: 160px; overflow-y: auto;">
                            <h2 style="font-size: 22px; font-weight: bold; margin-bottom: 12px; color: #2d3748; margin-top: 0; border-bottom: 2px solid #ff6600; padding-bottom: 8px; display: inline-block;">About This Event</h2>
                            <div style="font-size: 15px; line-height: 1.6; margin: 0; color: #4a5568; word-wrap: break-word; overflow-wrap: break-word;">${processRichText(event.description) || 'Event description will appear here with all your formatting including <strong>bold text</strong>, <em>italic text</em>, and bullet points.'}</div>
                        </div>
                        
                        <!-- Event Details with Custom Icons -->
                        <div class="draggable" style="position: absolute; top: 180px; left: 25px; width: 350px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; border: 1px solid #dee2e6; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <!-- Date -->
                                <div style="display: flex; align-items: center; padding: 12px 0;">
                                    <div style="width: 24px; height: 24px; margin-right: 12px; flex-shrink: 0;">
                                        <img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-01.svg" alt="Date" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.outerHTML='<div style=\\'width:24px;height:24px;background:#ff6600;border-radius:4px;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:bold;\\'>📅</div>';">
                                    </div>
                                    <div style="font-size: 15px; color: #2d3748; font-weight: 500;">${formattedDate}</div>
                                </div>
                                
                                <!-- Separator Line -->
                                <div style="height: 1px; background: linear-gradient(90deg, #dee2e6 0%, #adb5bd 50%, #dee2e6 100%); margin: 0;"></div>
                                
                                <!-- Time -->
                                <div style="display: flex; align-items: center; padding: 12px 0;">
                                    <div style="width: 24px; height: 24px; margin-right: 12px; flex-shrink: 0;">
                                        <img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-02.svg" alt="Time" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.outerHTML='<div style=\\'width:24px;height:24px;background:#ff6600;border-radius:4px;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:bold;\\'>🕐</div>';">
                                    </div>
                                    <div style="font-size: 15px; color: #2d3748; font-weight: 500;">${timeRange}</div>
                                </div>
                                
                                <!-- Separator Line -->
                                <div style="height: 1px; background: linear-gradient(90deg, #dee2e6 0%, #adb5bd 50%, #dee2e6 100%); margin: 0;"></div>
                                
                                <!-- Location -->
                                <div style="display: flex; align-items: center; padding: 12px 0;">
                                    <div style="width: 24px; height: 24px; margin-right: 12px; flex-shrink: 0;">
                                        <img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-03.svg" alt="Location" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.outerHTML='<div style=\\'width:24px;height:24px;background:#ff6600;border-radius:4px;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:bold;\\'>📍</div>';">
                                    </div>
                                    <div style="font-size: 15px; color: #2d3748; font-weight: 500; line-height: 1.4;">${event.location}</div>
                                </div>
                                
                                <!-- Bottom Separator Line -->
                                <div style="height: 1px; background: linear-gradient(90deg, #dee2e6 0%, #adb5bd 50%, #dee2e6 100%); margin: 0;"></div>
                            </div>
                        </div>
                        
                        <!-- QR Code -->
                        ${qrCodeSrc ? `
                        <div class="draggable" style="position: absolute; top: 180px; right: 25px; width: 140px; height: 140px;">
                            <div style="background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
                                <img src="${qrCodeSrc}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none';">
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Secondary Image -->
                        ${event.secondary_image_url ? `
                        <div class="draggable" style="position: absolute; top: 340px; left: 25px; width: 200px; height: 100px;">
                            <img src="${event.secondary_image_url}" alt="Secondary Image" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.style.display='none';">
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer with Custom SVG (595x70) -->
                    <div style="width: 100%; height: 70px; background: white; position: absolute; bottom: 0; left: 0; display: flex; align-items: center; justify-content: center; box-sizing: border-box; overflow: hidden;">
                        <img src="https://www.compassoffices.com/wp-content/uploads/2025/10/compassoffices-poster-04.svg" alt="Footer" style="width: 100%; height: 100%; object-fit: cover; object-position: center;" onerror="this.outerHTML='<div style=\\'color:#666;font-size:14px;font-weight:500;width:100%;height:100%;display:flex;align-items:center;justify-content:center;\\'>Event Poster</div>';">
                    </div>
                </div>
            `;
        }

        function generateBannerHTML(event, config) {
            const formattedDate = formatDate(event.event_date);
            const startTime = formatTime(event.event_time);
            const endTime = event.end_time ? formatTime(event.end_time) : '';
            const timeRange = endTime ? `${startTime} - ${endTime}` : startTime;
            
            // Generate simplified date format for banner
            const simplifiedDate = formatSimplifiedDate(event.event_date);
            const simplifiedTime = formatSimplifiedTime(event.event_time, event.end_time);
            const simplifiedLocation = event.location.split(',')[0];
            const infoText = `${simplifiedDate} | ${simplifiedTime} | ${simplifiedLocation}`;
            
            return `
                <div style="width: 600px; height: 200px; background-color: white; color: #333; display: flex; align-items: center; padding: 30px; box-sizing: border-box; position: relative; border: 1px solid #dee2e6;">
                    <!-- Info Box -->
                    <div style="position: absolute; top: 15px; left: 30px; background: #2d3748; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; z-index: 10;">
                        ${infoText}
                    </div>
                    
                    <div style="flex: 1; padding-right: 30px; margin-top: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px; line-height: 1.2; margin-top: 0; font-weight: bold; color: #333;">${event.banner_title || event.event_title}</div>
                        <p style="font-size: 16px; margin: 0; line-height: 1.4; color: #666;">${event.banner_subtitle || 'Join us for an amazing event'}</p>
                    </div>
                    <div style="width: 140px; height: 140px; flex-shrink: 0; background: #f8f9fa; border-radius: 8px; overflow: hidden; border: 1px solid #dee2e6;">
                        ${event.image_url ? 
                            `<img src="${event.image_url}" alt="Event" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#666;\\'><svg width=\\'60\\' height=\\'60\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'><path fill-rule=\\'evenodd\\' d=\\'M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z\\' clip-rule=\\'evenodd\\'/></svg></div>';">` :
                            `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;"><svg width="60" height="60" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/></svg></div>`
                        }
                    </div>
                </div>
            `;
        }

        function setupDownloadHandlers() {
            document.getElementById('downloadPoster').addEventListener('click', () => {
                downloadElement('posterPreview', 'event-poster.png');
            });

            document.getElementById('downloadBanner').addEventListener('click', () => {
                downloadElement('bannerPreview', 'event-banner.png');
            });
        }

        async function downloadElement(elementId, filename) {
            try {
                const element = document.getElementById(elementId);
                if (!element) {
                    showError("Element not found for download");
                    return;
                }

                showSuccess("Preparing high-resolution JPG download...");
                
                // Wait for any images to load
                const images = element.querySelectorAll('img');
                await Promise.all(Array.from(images).map(img => {
                    return new Promise((resolve) => {
                        if (img.complete) {
                            resolve();
                        } else {
                            img.onload = resolve;
                            img.onerror = resolve;
                            setTimeout(resolve, 2000); // Timeout after 2 seconds
                        }
                    });
                }));

                // Create a temporary container for high-res rendering
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.top = '-10000px';
                tempContainer.style.left = '-10000px';
                tempContainer.style.zIndex = '-1000';
                tempContainer.style.pointerEvents = 'none';
                document.body.appendChild(tempContainer);

                // Clone the element
                const clone = element.cloneNode(true);
                
                // Set high resolution dimensions for better quality
                const scale = 3; // 3x scale for high resolution
                let targetWidth, targetHeight;
                
                if (elementId === 'posterPreview') {
                    targetWidth = 595 * scale;   // 1785px
                    targetHeight = 842 * scale;  // 2526px
                    filename = filename.replace('.png', '.jpg');
                } else if (elementId === 'bannerPreview') {
                    targetWidth = 600 * scale;   // 1800px  
                    targetHeight = 200 * scale;  // 600px
                    filename = filename.replace('.png', '.jpg');
                }

                // Apply scaling to clone
                clone.style.width = targetWidth + 'px';
                clone.style.height = targetHeight + 'px';
                clone.style.transform = 'none';
                clone.style.transformOrigin = 'top left';
                clone.style.position = 'relative';
                clone.style.display = 'block';

                // Scale all text and spacing
                const scaleElements = (element, scaleFactor) => {
                    const allElements = element.querySelectorAll('*');
                    allElements.forEach(el => {
                        const style = window.getComputedStyle(el);
                        
                        // Scale font sizes
                        const fontSize = parseFloat(style.fontSize);
                        if (fontSize && fontSize > 0) {
                            el.style.fontSize = (fontSize * scaleFactor) + 'px';
                        }
                        
                        // Scale line heights
                        const lineHeight = parseFloat(style.lineHeight);
                        if (lineHeight && lineHeight > 0) {
                            el.style.lineHeight = (lineHeight * scaleFactor) + 'px';
                        }
                        
                        // Scale padding
                        ['paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft'].forEach(prop => {
                            const value = parseFloat(style[prop]);
                            if (value && value > 0) {
                                el.style[prop] = (value * scaleFactor) + 'px';
                            }
                        });
                        
                        // Scale margins
                        ['marginTop', 'marginRight', 'marginBottom', 'marginLeft'].forEach(prop => {
                            const value = parseFloat(style[prop]);
                            if (value && value > 0) {
                                el.style[prop] = (value * scaleFactor) + 'px';
                            }
                        });
                        
                        // Scale border radius
                        const borderRadius = parseFloat(style.borderRadius);
                        if (borderRadius && borderRadius > 0) {
                            el.style.borderRadius = (borderRadius * scaleFactor) + 'px';
                        }
                        
                        // Scale border width
                        const borderWidth = parseFloat(style.borderWidth);
                        if (borderWidth && borderWidth > 0) {
                            el.style.borderWidth = (borderWidth * scaleFactor) + 'px';
                        }
                    });
                };

                scaleElements(clone, scale);
                tempContainer.appendChild(clone);

                // Wait a moment for rendering
                await new Promise(resolve => setTimeout(resolve, 100));

                // Generate canvas with optimal settings for JPG
                const canvas = await html2canvas(clone, {
                    backgroundColor: '#ffffff',
                    scale: 1,
                    useCORS: true,
                    allowTaint: false,
                    logging: false,
                    width: targetWidth,
                    height: targetHeight,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: targetWidth,
                    windowHeight: targetHeight,
                    removeContainer: false,
                    foreignObjectRendering: true,
                    imageTimeout: 5000
                });

                // Clean up
                document.body.removeChild(tempContainer);

                // Convert to high-quality JPG
                const link = document.createElement('a');
                link.download = filename;
                
                // Create JPG with maximum quality (0.95 for best balance of quality/size)
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess(`High-resolution JPG downloaded! (${targetWidth}x${targetHeight}px)`);
                
            } catch (error) {
                console.error('Download error:', error);
                showError("Download failed. Please check your browser settings and try again.");
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'TBD';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatTime(timeString) {
            if (!timeString) return 'TBD';
            const [hours, minutes] = timeString.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes));
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function formatSimplifiedDate(dateString) {
            if (!dateString) return 'TBD';
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function formatSimplifiedTime(startTime, endTime) {
            if (!startTime) return 'TBD';
            
            const formatTo12Hour = (timeString) => {
                const [hours, minutes] = timeString.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'pm' : 'am';
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                return minutes === '00' ? `${displayHour}${ampm}` : `${displayHour}:${minutes}${ampm}`;
            };

            const start = formatTo12Hour(startTime);
            if (!endTime) return start;
            
            const end = formatTo12Hour(endTime);
            return `${start}-${end}`;
        }

        function setLoading(loading) {
            isLoading = loading;
            const submitBtn = document.getElementById('submitBtn');
            const spinner = document.getElementById('submitSpinner');
            
            if (loading) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-75');
                spinner.classList.remove('hidden');
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75');
                spinner.classList.add('hidden');
            }
        }

        function updateDataCount() {
            document.getElementById('dataCount').textContent = currentData.length;
        }

        function renderEventsGallery() {
            const gallery = document.getElementById('eventsGallery');
            const emptyState = document.getElementById('emptyState');

            if (currentData.length === 0) {
                gallery.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            gallery.innerHTML = currentData.map(event => {
                const formattedDate = formatDate(event.event_date);
                const formattedTime = formatTime(event.event_time);
                
                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-200">
                        <div class="h-48 relative" style="background-color: ${event.background_color}">
                            <div class="absolute inset-0 p-4 text-white flex flex-col justify-center">
                                <h3 class="text-lg font-bold mb-2">${event.event_title}</h3>
                                <div class="space-y-1 text-sm opacity-90">
                                    <p>📅 ${formattedDate}</p>
                                    <p>🕐 ${formattedTime}</p>
                                    <p>📍 ${event.location}</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">${new Date(event.created_at).toLocaleDateString()}</span>
                                <div class="flex gap-2">
                                    <button onclick="viewEvent('${event.__backendId}')" class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                                        View
                                    </button>
                                    <button onclick="deleteEvent('${event.__backendId}')" class="text-red-500 hover:text-red-700 text-sm font-medium">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewEvent(backendId) {
            const event = currentData.find(e => e.__backendId === backendId);
            if (event) {
                updatePreviewElements(event);
                // Scroll to preview section
                document.querySelector('.preview-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function deleteEvent(backendId) {
            if (!window.dataSdk) return;

            const event = currentData.find(e => e.__backendId === backendId);
            if (!event) return;

            try {
                const result = await window.dataSdk.delete(event);
                if (result.isOk) {
                    showSuccess("Event deleted successfully!");
                } else {
                    showError("Failed to delete event.");
                }
            } catch (error) {
                showError("An error occurred while deleting.");
            }
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Drag and Drop functionality
        function makeDraggable() {
            const draggables = document.querySelectorAll('.draggable');
            
            draggables.forEach(element => {
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;
                
                element.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    const rect = element.getBoundingClientRect();
                    const parentRect = element.parentElement.getBoundingClientRect();
                    initialLeft = rect.left - parentRect.left;
                    initialTop = rect.top - parentRect.top;
                    
                    element.style.zIndex = '1000';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    const newLeft = Math.max(0, Math.min(initialLeft + deltaX, element.parentElement.offsetWidth - element.offsetWidth));
                    const newTop = Math.max(0, Math.min(initialTop + deltaY, element.parentElement.offsetHeight - element.offsetHeight));
                    
                    element.style.left = newLeft + 'px';
                    element.style.top = newTop + 'px';
                });
                
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        element.style.zIndex = 'auto';
                    }
                });
            });
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupRealTimePreview();
            // Add drag functionality after a short delay to ensure elements are rendered
            setTimeout(makeDraggable, 500);
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'994f9f05f7b62670',t:'MTc2MTU0MTEzNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
