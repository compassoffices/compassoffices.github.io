<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Poster Generator</title>
  <link rel="icon" type="image/png" href="https://www.compassoffices.com/wp-content/uploads/2025/09/compassoffices-logo-web-2025_icon-o-scaled.png">
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
        body {box-sizing:border-box;}
        .poster-template{
            width:595px;height:842px;position:relative;overflow:hidden;
            box-shadow:0 8px 32px rgba(0,0,0,0.1);background:white;
            transform:scale(0.85);transform-origin:top center;margin-bottom:-126px;
        }
        .email-banner{
            width:600px;height:200px;position:relative;overflow:visible;
            box-shadow:0 4px 16px rgba(0,0,0,0.1);background:white;
            transform:scale(1);transform-origin:top left;margin-bottom:0;
        }
        .loading-spinner{
            border:3px solid #f3f4f6;border-top:3px solid #3b82f6;
            border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;
        }
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .form-section{background:linear-gradient(135deg,#2d3748 0%,#1a202c 100%);}
        .preview-section{background:linear-gradient(135deg,#4a5568 0%,#2d3748 100%);}
        .download-btn{background:linear-gradient(45deg,#ff6600,#e55a00);}
        .download-btn:hover{background:linear-gradient(45deg,#e55a00,#cc4f00);}
        .smart-btn{background:linear-gradient(45deg,#10b981,#059669);}
        .smart-btn:hover{background:linear-gradient(45deg,#059669,#047857);}
        /* Rich Text */
        [contenteditable="true"]:empty:before{content:attr(data-placeholder);color:rgba(255,255,255,0.7);pointer-events:none;}
        [contenteditable="true"]:focus:before{display:none;}
        .rich-editor{outline:none;}
        .rich-editor strong{font-weight:bold;}
        .rich-editor em{font-style:italic;}
        .rich-editor ul{list-style-type:disc;margin-left:20px;margin:8px 0;}
        .rich-editor ol{list-style-type:decimal;margin-left:20px;margin:8px 0;}
        .rich-editor li{margin-bottom:4px;}
        .rich-editor p{margin-bottom:8px;}
        .rich-editor p:last-child{margin-bottom:0;}
        /* Drag handle */
        .drag-handle{
            position:absolute;top:-8px;right:-8px;width:20px;height:20px;
            background:#ff6600;border-radius:50%;cursor:move;display:none;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
        }
        .draggable:hover .drag-handle{display:block;}
        /* Resize handle */
        .resize-handle{
            position:absolute;bottom:-6px;right:-6px;width:16px;height:16px;
            background:#ff6600;border-radius:50%;cursor:nwse-resize;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
        }
        .resizable:hover .resize-handle{display:block;}
        /* Pixel indicator */
        .pixel-indicator{
            position:absolute;top:-30px;right:0;background:#000;color:#fff;
            font-size:11px;padding:2px 6px;border-radius:4px;opacity:0;
            transition:opacity 0.2s;z-index:1001;pointer-events:none;
        }
        /* Invisible 10px grid */
        .grid-overlay{
            position:absolute;top:0;left:0;width:100%;height:100%;
            background:repeating-linear-gradient(0deg,transparent,transparent 9px,#f0f0f0 10px),
                        repeating-linear-gradient(90deg,transparent,transparent 9px,#f0f0f0 10px);
            opacity:0.08;pointer-events:none;z-index:1;
            display:none;
        }
        .grid-enabled .grid-overlay{display:block;}
        /* Drop zones */
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.1);
        }
        .drop-zone:hover, .drop-zone.dragover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.8);
        }
        .drop-zone p { margin: 0; font-size: 14px; color: rgba(255,255,255,0.8); }
        .preview-img {
            max-height: 60px;
            max-width: 100%;
            object-fit: contain;
            border-radius: 4px;
        }
        .key-preview-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .key-preview-container {
            width: 120px;
            height: 120px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 8px;
            display: none;
        }
        /* Function Bar Icons */
        .func-bar {
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
            background: rgba(255,255,255,0.15); padding: 8px; border-radius: 8px;
            backdrop-filter: blur(4px);
        }
        .func-btn {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;
            transition: all 0.2s;
        }
        .func-btn:hover { background: rgba(255,255,255,0.3); }
        .func-btn svg { width: 16px; height: 16px; fill: white; }
    </style>
 </head>
 <body class="min-h-full bg-gray-100">
  <div class="min-h-full">
   <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4">
     <h1 id="main-title" class="text-3xl font-bold text-gray-900">Event Poster Generator</h1>
     <p class="text-gray-600 mt-2">Create stunning event posters and email banners with customizable layouts</p>
    </div>
   </header>
   <div class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
     <!-- ==== FORM ==== -->
     <div class="form-section rounded-2xl p-8 text-white lg:col-span-2">
      <h2 class="text-2xl font-bold mb-6">Create New Event</h2>
      <form id="eventForm" class="space-y-6">
       <!-- Title -->
       <div>
        <label class="block text-sm font-medium mb-2">Event Title</label>
        <div class="space-y-3">
         <div class="relative">
          <div id="titleEditor" contenteditable="true" class="rich-editor w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 resize-none min-h-[60px] max-h-[120px] overflow-y-auto" data-placeholder="Summer Music Festival"></div>
          <input type="hidden" id="event_title" name="event_title" required>
         </div>
         <div class="func-bar">
          <button type="button" id="titleBold" class="func-btn" title="Bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg></button>
          <button type="button" id="titleItalic" class="func-btn" title="Italic"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg></button>
          <button type="button" id="titleClear" class="func-btn" title="Clear"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
         </div>
         <div class="grid grid-cols-2 gap-3">
          <div>
           <label for="title_font_size" class="block text-xs font-medium mb-1 text-white/80">Font Size</label>
           <select id="title_font_size" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
            <option value="16">16px</option><option value="18">18px</option><option value="20">20px</option><option value="22">22px</option><option value="24">24px</option><option value="26">26px</option><option value="28">28px</option><option value="30">30px</option><option value="32" selected>32px</option><option value="34">34px</option><option value="36">36px</option><option value="38">38px</option><option value="40">40px</option><option value="42">42px</option><option value="44">44px</option><option value="46">46px</option><option value="48">48px</option><option value="50">50px</option><option value="52">52px</option><option value="54">54px</option><option value="56">56px</option><option value="58">58px</option><option value="60">60px</option>
           </select>
          </div>
          <div>
           <label for="title_line_height" class="block text-xs font-medium mb-1 text-white/80">Line Height</label>
           <select id="title_line_height" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
            <option value="1.0">1.0</option><option value="1.1">1.1</option><option value="1.2" selected>1.2</option><option value="1.3">1.3</option><option value="1.4">1.4</option><option value="1.5">1.5</option><option value="1.6">1.6</option><option value="1.8">1.8</option><option value="2.0">2.0</option>
           </select>
          </div>
         </div>
        </div>
       </div>

       <!-- Subtitle -->
       <div>
        <label class="block text-sm font-medium mb-2">Event Subtitle</label>
        <div class="space-y-3">
         <div class="relative">
          <div id="subtitleEditor" contenteditable="true" class="rich-editor w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 resize-none min-h-[60px] max-h-[120px] overflow-y-auto" data-placeholder="A Night of Music and Fun"></div>
          <input type="hidden" id="event_subtitle" name="event_subtitle">
         </div>
         <div class="func-bar">
          <button type="button" id="subtitleBold" class="func-btn" title="Bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg></button>
          <button type="button" id="subtitleItalic" class="func-btn" title="Italic"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg></button>
          <button type="button" id="subtitleClear" class="func-btn" title="Clear"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
         </div>
         <div>
          <label for="subtitle_font_size" class="block text-xs font-medium mb-1 text-white/80">Font Size</label>
          <select id="subtitle_font_size" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
           <option value="16">16px</option><option value="18">18px</option><option value="20">20px</option><option value="22">22px</option><option value="24" selected>24px</option><option value="26">26px</option><option value="28">28px</option><option value="30">30px</option><option value="32">32px</option><option value="34">34px</option><option value="36">36px</option>
          </select>
         </div>
        </div>
       </div>

       <!-- Header Text Background -->
       <div>
        <label class="block text-sm font-medium mb-2">Header Text Background</label>
        <div class="grid grid-cols-3 gap-2">
         <button type="button" id="headerBgWhite" class="px-3 py-2 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">White</button>
         <button type="button" id="headerBgGrey" class="px-3 py-2 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Light Grey</button>
         <button type="button" id="headerBgOrange" class="px-3 py-2 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Light Orange</button>
        </div>
       </div>

       <!-- LOGO UPLOAD & SIZE -->
       <div>
        <label class="block text-sm font-medium mb-2">Custom Logo</label>
        <div id="logoDropZone" class="drop-zone">
         <p>Drop logo or click</p>
         <input type="file" id="logoFileInput" accept="image/*" style="display:none;">
         <div id="logoPreview" class="mt-2 hidden">
          <img id="logoPreviewImg" class="preview-img" src="" alt="Logo">
         </div>
        </div>
        <div class="mt-3 space-y-2">
         <div class="grid grid-cols-2 gap-3">
          <div>
           <label for="logo_width" class="block text-xs font-medium mb-1 text-white/80">Width (px)</label>
           <input type="number" id="logo_width" value="120" min="50" max="300" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
          </div>
          <div>
           <label for="logo_height" class="block text-xs font-medium mb-1 text-white/80">Height (px)</label>
           <input type="number" id="logo_height" value="50" min="30" max="100" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
          </div>
         </div>
         <label class="flex items-center text-sm">
          <input type="radio" name="logoMode" value="both" id="logoBoth" class="mr-2" checked> Both
         </label>
         <label class="flex items-center text-sm">
          <input type="radio" name="logoMode" value="custom" id="logoCustom" class="mr-2"> Custom Only
         </label>
         <label class="flex items-center text-sm">
          <input type="radio" name="logoMode" value="none" id="logoNone" class="mr-2"> None
         </label>
        </div>
       </div>

       <!-- KEY IMAGE (300x300) -->
       <div>
        <label class="block text-sm font-medium mb-2">Key Image (300x300)</label>
        <div id="keyDropZone" class="drop-zone">
         <p>Drop or click</p>
         <input type="file" id="keyFileInput" accept="image/*" style="display:none;">
         <div id="keyPreviewContainer" class="key-preview-container">
          <img id="keyPreviewImg" class="key-preview-img" src="" alt="Key image">
         </div>
        </div>
        <div class="mt-2">
         <label for="key_image_url" class="block text-xs font-medium mb-1 text-white/80">Or enter URL</label>
         <input type="url" id="key_image_url" placeholder="https://example.com/image.jpg" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
        </div>
       </div>

       <!-- SECONDARY IMAGE -->
       <div>
        <label class="block text-sm font-medium mb-2">Secondary Image</label>
        <div id="secDropZone" class="drop-zone">
         <p>Drop or click</p>
         <input type="file" id="secFileInput" accept="image/*" style="display:none;">
         <div id="secPreviewContainer" class="key-preview-container">
          <img id="secPreviewImg" class="key-preview-img" src="" alt="Secondary image">
         </div>
        </div>
        <div class="mt-2">
         <label for="secondary_image_url" class="block text-xs font-medium mb-1 text-white/80">Or enter URL</label>
         <input type="url" id="secondary_image_url" placeholder="https://example.com/image.png" class="w-full px-3 py-2 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-sm">
        </div>
       </div>

       <!-- Event Details -->
       <div><label for="event_date" class="block text-sm font-medium mb-2">Date</label> <input type="date" id="event_date" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50"></div>
       <div class="grid grid-cols-2 gap-4">
        <div><label for="event_time" class="block text-sm font-medium mb-2">Start</label> <input type="time" id="event_time" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50"></div>
        <div><label for="end_time" class="block text-sm font-medium mb-2">End</label> <input type="time" id="end_time" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50"></div>
       </div>
       <div><label for="location" class="block text-sm font-medium mb-2">Location</label> <input type="text" id="location" required class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Central Park, New York"></div>

       <!-- Description -->
       <div>
        <label class="block text-sm font-medium mb-2">Description</label>
        <div class="space-y-3">
         <div id="descriptionEditor" contenteditable="true" class="rich-editor w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50 resize-none min-h-[80px] max-h-[200px] overflow-y-auto" data-placeholder="Join us for an amazing evening..."></div>
         <input type="hidden" id="description" name="description">
         <div class="func-bar">
          <button type="button" id="descBold" class="func-btn" title="Bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg></button>
          <button type="button" id="descItalic" class="func-btn" title="Italic"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg></button>
          <button type="button" id="descBullet" class="func-btn" title="Bullet List"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zM4 4.5c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm3 5.5h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V8H7z"/></svg></button>
          <button type="button" id="descNumber" class="func-btn" title="Number List"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 17h2v.5H3v1h1v.5H2v1h3v-4H2v1zm1-9h1V4H2v1h1v3zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2v1zm5-6v2h14V5H7zm0 14h14v-2H7v2zm0-6h14v-2H7v2z"/></svg></button>
          <button type="button" id="descClear" class="func-btn" title="Clear"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
         </div>
        </div>
       </div>

       <!-- QR Code -->
       <div>
        <label for="qr_code_url" class="block text-sm font-medium mb-2">QR Code URL</label>
        <input type="url" id="qr_code_url" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="https://example.com">
       </div>

       <!-- Content Background (Gradient Only) -->
       <div>
        <label class="block text-sm font-medium mb-2">Content Background (Gradient)</label>
        <div class="grid grid-cols-3 gap-2">
         <button type="button" id="gradient1" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Gradient 1</button>
         <button type="button" id="gradient2" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Gradient 2</button>
         <button type="button" id="gradient3" class="px-3 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">Gradient 3</button>
        </div>
       </div>

       <!-- Email Banner BG -->
       <div>
        <label class="block text-sm font-medium mb-2">Email Banner BG</label>
        <div class="flex gap-3">
         <label class="flex items-center text-sm">
          <input type="radio" name="banner_bg_mode" value="same" id="bannerBgSame" class="mr-2" checked> Same as Poster
         </label>
         <label class="flex items-center text-sm">
          <input type="radio" name="banner_bg_mode" value="solid" id="bannerBgSolid" class="mr-2"> Solid
         </label>
        </div>
        <div id="solidColorInput" class="mt-2 hidden">
         <input type="color" id="banner_solid_color" value="#ffffff" class="w-full h-10 rounded-lg border border-white/30 bg-white/20 cursor-pointer">
        </div>
       </div>

       <!-- Banner Text -->
       <div class="space-y-4">
        <h3 class="text-lg font-semibold">Email Banner Text</h3>
        <div><label for="banner_title" class="block text-sm font-medium mb-2">Title</label> <input type="text" id="banner_title" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Join us for an amazing event"></div>
        <div><label for="banner_subtitle" class="block text-sm font-medium mb-2">Subtitle</label> <input type="text" id="banner_subtitle" class="w-full px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Don't miss this incredible opportunity"></div>
       </div>

       <div class="mt-6">
        <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center">
         <span id="submitSpinner" class="loading-spinner hidden mr-2"></span>
         <span>Create Event</span>
        </button>
       </div>
      </form>
     </div>

     <!-- ==== PREVIEW ==== -->
     <div class="preview-section rounded-2xl p-8 text-white lg:col-span-3">
      <h2 class="text-2xl font-bold mb-6">Live Previews</h2>
      <div class="space-y-8">
       <div>
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-semibold">Event Poster (A4)</h3>
         <div class="flex gap-2">
          <button id="saveLayoutBtn" class="smart-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200">Save Layout</button>
          <button id="downloadPoster" class="download-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200">JPG (300 DPI)</button>
         </div>
        </div>
        <div class="flex justify-center relative">
         <div id="posterPreview" class="poster-template bg-blue-500 overflow-hidden grid-enabled"></div>
        </div>
       </div>
       <div>
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-semibold">Email Banner</h3>
         <button id="downloadBanner" class="download-btn text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-200">JPG</button>
        </div>
        <div class="flex justify-center">
         <div id="bannerPreview" class="email-banner bg-blue-500 overflow-hidden"></div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>

  <script>
    const svgIcons = {
        calendar: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`,
        clock: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
        location: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`
    };

    let logoUrl = '', keyImageUrl = '', secImageUrl = '', logoMode = 'both', headerBg = 'rgba(255,255,255,0.95)', bannerBgMode = 'same', bannerSolidColor = '#ffffff';

    async function initializeApp(){
        try{
            if(window.elementSdk) await window.elementSdk.init({ defaultConfig:{}, onConfigChange:c=>{}, mapToCapabilities:c=>({}), mapToEditPanelValues:c=>new Map() });
            if(window.dataSdk){ const r=await window.dataSdk.init({ onDataChanged(d){} }); if(!r.isOk) console.warn("Data storage not available");}
            initializePreview(); setupDownloadHandlers(); setupSaveLayout(); setupGradientButtons(); setupLogoUpload(); setupKeyImageUpload(); setupSecImageUpload(); setupHeaderBgButtons(); setupBannerBgMode(); setTimeout(updateLivePreview,200);
        }catch(e){ console.error(e); initializePreview(); setupDownloadHandlers(); setupSaveLayout(); setupGradientButtons(); setupLogoUpload(); setupKeyImageUpload(); setupSecImageUpload(); setupHeaderBgButtons(); setupBannerBgMode(); setTimeout(updateLivePreview,200);}
    }

    function initializePreview(){
        const sample={
            event_title:"Summer Music Festival",event_subtitle:"A Night of Music and Fun",event_date:"2025-07-15",event_time:"18:00",end_time:"22:00",location:"Lee Garden 1, 24/F, Central Park",
            description:"Join us for an amazing evening of music and entertainment under the stars. Experience live performances from top artists.",
            content_background_gradient:"linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%)",title_font_size:"32",title_line_height:"1.2",subtitle_font_size:"24",banner_title:"Join us for an amazing event",banner_subtitle:"Don't miss this incredible opportunity",
            image_url:"",qr_code_url:"",secondary_image_url:"",custom_logo_url:"",logo_width:"120",logo_height:"50"
        };
        updatePreviewElements(sample);
    }

    function setupRichTextEditors(){
        const editors = [
            { editor: 'titleEditor', hidden: 'event_title', bold: 'titleBold', italic: 'titleItalic', clear: 'titleClear' },
            { editor: 'subtitleEditor', hidden: 'event_subtitle', bold: 'subtitleBold', italic: 'subtitleItalic', clear: 'subtitleClear' },
            { editor: 'descriptionEditor', hidden: 'description', bold: 'descBold', italic: 'descItalic', bullet: 'descBullet', number: 'descNumber', clear: 'descClear' }
        ];
        editors.forEach(e => {
            const editor = document.getElementById(e.editor);
            const hidden = document.getElementById(e.hidden);
            editor.innerHTML = e.editor === 'titleEditor' ? 'Summer Music Festival' : e.editor === 'subtitleEditor' ? 'A Night of Music and Fun' : 'Join us for an amazing evening of music and entertainment';
            editor.addEventListener('input', () => { hidden.value = editor.innerHTML; updateLivePreview(); });
            if (e.bold) document.getElementById(e.bold).onclick = () => applyFormatting('bold', editor);
            if (e.italic) document.getElementById(e.italic).onclick = () => applyFormatting('italic', editor);
            if (e.bullet) document.getElementById(e.bullet).onclick = () => applyFormatting('insertUnorderedList', editor);
            if (e.number) document.getElementById(e.number).onclick = () => applyFormatting('insertOrderedList', editor);
            if (e.clear) document.getElementById(e.clear).onclick = () => { editor.innerHTML = ''; hidden.value = ''; updateLivePreview(); };
            hidden.value = editor.innerHTML;
        });
    }

    function applyFormatting(cmd, editor) {
        editor.focus();
        document.execCommand(cmd, false);
        const hidden = editor.id === 'titleEditor' ? document.getElementById('event_title') :
                       editor.id === 'subtitleEditor' ? document.getElementById('event_subtitle') :
                       document.getElementById('description');
        hidden.value = editor.innerHTML;
        updateLivePreview();
    }

    function processRichText(html){
        if (!html) return '';
        return html
            .replace(/<div>/g,'<p>').replace(/<\/div>/g,'</p>')
            .replace(/<p>/g,'<p style="margin:0 0 8px 0;line-height:1.6;">')
            .replace(/<strong>/g,'<strong style="font-weight:700;color:#2d3748;">')
            .replace(/<em>/g,'<em style="font-style:italic;color:#4a5568;">');
    }

    function updateLivePreview(){
        const eventData = {
            event_title: document.getElementById('titleEditor').innerHTML,
            event_subtitle: document.getElementById('subtitleEditor').innerHTML,
            event_date: document.getElementById('event_date').value || '2025-07-15',
            event_time: document.getElementById('event_time').value || '18:00',
            end_time: document.getElementById('end_time').value || '22:00',
            location: document.getElementById('location').value || 'Central Park, New York',
            description: document.getElementById('descriptionEditor').innerHTML,
            image_url: keyImageUrl || document.getElementById('key_image_url').value,
            qr_code_url: document.getElementById('qr_code_url').value,
            secondary_image_url: secImageUrl || document.getElementById('secondary_image_url').value,
            custom_logo_url: logoUrl,
            logo_mode: logoMode,
            logo_width: document.getElementById('logo_width').value + 'px',
            logo_height: document.getElementById('logo_height').value + 'px',
            content_background_gradient: document.getElementById('content_background_color')?.dataset.gradient || 'linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%)',
            title_font_size: document.getElementById('title_font_size').value,
            title_line_height: document.getElementById('title_line_height').value,
            subtitle_font_size: document.getElementById('subtitle_font_size').value,
            banner_title: document.getElementById('banner_title').value,
            banner_subtitle: document.getElementById('banner_subtitle').value,
            header_bg: headerBg,
            banner_bg_mode: bannerBgMode,
            banner_solid_color: bannerSolidColor
        };
        updatePreviewElements(eventData);
    }

    // === UPLOADS ===
    function setupLogoUpload() {
        const dropZone = document.getElementById('logoDropZone');
        const fileInput = document.getElementById('logoFileInput');
        const preview = document.getElementById('logoPreview');
        const previewImg = document.getElementById('logoPreviewImg');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0], url => { logoUrl = url; previewImg.src = url; preview.classList.remove('hidden'); updateLivePreview(); }); });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.add('dragover')));
        ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover')));
        dropZone.addEventListener('drop', e => { if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0], url => { logoUrl = url; previewImg.src = url; preview.classList.remove('hidden'); updateLivePreview(); }); });

        document.querySelectorAll('input[name="logoMode"]').forEach(r => r.addEventListener('change', () => { logoMode = r.value; updateLivePreview(); }));
        ['logo_width', 'logo_height'].forEach(id => document.getElementById(id).addEventListener('input', updateLivePreview));
    }

    function setupKeyImageUpload() {
        const dropZone = document.getElementById('keyDropZone');
        const fileInput = document.getElementById('keyFileInput');
        const preview = document.getElementById('keyPreviewContainer');
        const previewImg = document.getElementById('keyPreviewImg');
        const urlInput = document.getElementById('key_image_url');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0], url => { keyImageUrl = url; previewImg.src = url; preview.style.display = 'block'; updateLivePreview(); }); });
        urlInput.addEventListener('input', () => { keyImageUrl = ''; updateLivePreview(); });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.add('dragover')));
        ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover')));
        dropZone.addEventListener('drop', e => { if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0], url => { keyImageUrl = url; previewImg.src = url; preview.style.display = 'block'; updateLivePreview(); }); });
    }

    function setupSecImageUpload() {
        const dropZone = document.getElementById('secDropZone');
        const fileInput = document.getElementById('secFileInput');
        const preview = document.getElementById('secPreviewContainer');
        const previewImg = document.getElementById('secPreviewImg');
        const urlInput = document.getElementById('secondary_image_url');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0], url => { secImageUrl = url; previewImg.src = url; preview.style.display = 'block'; updateLivePreview(); }); });
        urlInput.addEventListener('input', () => { secImageUrl = ''; updateLivePreview(); });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.add('dragover')));
        ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover')));
        dropZone.addEventListener('drop', e => { if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0], url => { secImageUrl = url; previewImg.src = url; preview.style.display = 'block'; updateLivePreview(); }); });
    }

    function handleFile(file, callback) {
        if (!file.type.startsWith('image/')) return showError('Please upload an image.');
        const reader = new FileReader();
        reader.onload = e => callback(e.target.result);
        reader.readAsDataURL(file);
    }

    // === HEADER BG ===
    function setupHeaderBgButtons() {
        document.getElementById('headerBgWhite').onclick = () => { headerBg = 'rgba(255,255,255,0.95)'; updateLivePreview(); };
        document.getElementById('headerBgGrey').onclick = () => { headerBg = 'rgba(243,244,246,0.95)'; updateLivePreview(); };
        document.getElementById('headerBgOrange').onclick = () => { headerBg = '#fff8f0'; updateLivePreview(); };
    }

    // === BANNER BG MODE ===
    function setupBannerBgMode() {
        document.getElementById('bannerBgSame').onclick = () => { bannerBgMode = 'same'; document.getElementById('solidColorInput').classList.add('hidden'); updateLivePreview(); };
        document.getElementById('bannerBgSolid').onclick = () => { bannerBgMode = 'solid'; document.getElementById('solidColorInput').classList.remove('hidden'); updateLivePreview(); };
        document.getElementById('banner_solid_color').addEventListener('input', e => { bannerSolidColor = e.target.value; updateLivePreview(); });
    }

    // === GRADIENTS ===
    function setupGradientButtons() {
        document.getElementById('gradient1').onclick = () => { document.getElementById('content_background_color').dataset.gradient = 'linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%)'; updateLivePreview(); };
        document.getElementById('gradient2').onclick = () => { document.getElementById('content_background_color').dataset.gradient = 'linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%)'; updateLivePreview(); };
        document.getElementById('gradient3').onclick = () => { document.getElementById('content_background_color').dataset.gradient = 'linear-gradient(135deg, #fff3e0 0%, #ffccbc 100%)'; updateLivePreview(); };
    }

    // === POSTER HTML ===
    function generatePosterHTML(event){
        const titleFontSize = event.title_font_size || '32';
        const titleLineHeight = event.title_line_height || '1.2';
        const subtitleFontSize = event.subtitle_font_size || '24';
        const qrSrc = event.qr_code_url ? `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(event.qr_code_url)}` : '';
        const formattedDate = formatDate(event.event_date);
        const timeRange = event.end_time ? `${formatTime(event.event_time)} - ${formatTime(event.end_time)}` : formatTime(event.event_time);

        let logoHTML = '';
        const hasCustom = event.custom_logo_url;
        if (event.logo_mode === 'both' || (event.logo_mode === 'custom' && hasCustom)) {
            logoHTML += `<img src="${event.custom_logo_url}" crossorigin="anonymous" style="width:${event.logo_width};height:${event.logo_height};object-fit:contain;" onerror="this.style.display='none'">`;
        }
        if (event.logo_mode === 'both') {
            logoHTML += `<img src="https://www.compassoffices.com/wp-content/uploads/2025/10/x-compass-logo.png" crossorigin="anonymous" style="width:${event.logo_width};height:${event.logo_height};object-fit:contain;">`;
        }

        return `
            <div id="posterRoot" style="width:595px;height:843px;background:white;position:relative;overflow:visible;font-family:sans-serif;">
                <div class="grid-overlay"></div>
                <div style="width:595px;height:300px;background:linear-gradient(135deg,#ff6600 0%,#e55a00 100%);display:flex;">
                    <div style="width:297.5px;height:300px;display:flex;align-items:flex-start;justify-content:flex-start;background:${event.header_bg};flex-direction:column;padding:20px 20px 0 20px;">
                        <div style="font-size:${titleFontSize}px;line-height:${titleLineHeight};color:#2d3748;text-align:left;margin:0;word-wrap:break-word;font-weight:600;width:100%;">${processRichText(event.event_title)}</div>
                        <div style="font-size:${subtitleFontSize}px;line-height:1.2;color:#4a5568;text-align:left;margin-top:8px;word-wrap:break-word;font-weight:400;width:100%;">${processRichText(event.event_subtitle)}</div>
                        ${logoHTML ? `<div id="logoBox" class="draggable resizable logo-group" style="position:relative;top:12px;left:0;width:auto;height:${event.logo_height};margin-top:12px;display:flex;align-items:center;gap:12px;">
                            <div class="drag-handle"></div><div class="resize-handle"></div><div class="pixel-indicator"></div>${logoHTML}
                        </div>` : ''}
                    </div>
                    <div style="width:297.5px;height:300px;background:#f8f9fa;overflow:hidden;">
                        ${event.image_url ? `<img src="${event.image_url}" crossorigin="anonymous" style="width:100%;height:100%;object-fit:cover;object-position:center;" onerror="this.style.display='none'">` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;font-size:14px;">Key Image</div>`}
                    </div>
                </div>
                <div id="contentArea" style="width:595px;height:473px;background:${event.content_background_gradient};padding:25px;box-sizing:border-box;position:relative;">
                    <div id="descBox" class="draggable resizable" style="position:absolute;top:25px;left:25px;width:300px;height:150px;background:rgba(255,255,255,0.9);padding:16px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
                        <div class="drag-handle"></div><div class="resize-handle"></div><div class="pixel-indicator"></div>
                        <h2 style="font-size:22px;font-weight:bold;margin:0 0 12px;color:#2d3748;border-bottom:2px solid #ff6600;padding-bottom:8px;display:inline-block;">About This Event</h2>
                        <div style="font-size:15px;line-height:1.6;color:#4a5568;">${processRichText(event.description)||'Event description...'}</div>
                    </div>
                    <div id="infoBox" class="draggable resizable" style="position:absolute;top:195px;left:25px;width:300px;height:140px;">
                        <div class="drag-handle"></div><div class="resize-handle"></div><div class="pixel-indicator"></div>
                        <div style="background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);padding:16px;border-radius:12px;border:1px solid #dee2e6;box-shadow:0 4px 12px rgba(0,0,0,0.08);height:100%;display:flex;flex-direction:column;justify-content:space-between;">
                            <div style="display:flex;align-items:center;padding-bottom:8px;border-bottom:1px solid #dee2e6;margin-bottom:8px;"><div style="width:20px;height:20px;margin-right:10px;color:#ff6600;">${svgIcons.calendar}</div><div style="font-size:14px;color:#2d3748;font-weight:500;">${formattedDate}</div></div>
                            <div style="display:flex;align-items:center;padding-bottom:8px;border-bottom:1px solid #dee2e6;margin-bottom:8px;"><div style="width:20px;height:20px;margin-right:10px;color:#ff6600;">${svgIcons.clock}</div><div style="font-size:14px;color:#2d3748;font-weight:500;">${timeRange}</div></div>
                            <div style="display:flex;align-items:center;"><div style="width:20px;height:20px;margin-right:10px;color:#ff6600;">${svgIcons.location}</div><div style="font-size:14px;color:#2d3748;font-weight:500;line-height:1.4;">${event.location}</div></div>
                        </div>
                    </div>
                    ${qrSrc ? `<div class="draggable qr-box" style="position:absolute;top:308px;right:25px;width:140px;height:140px;">
                        <div class="drag-handle"></div><div class="pixel-indicator"></div>
                        <div style="background:white;padding:10px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:1px solid #dee2e6;">
                            <img src="${qrSrc}" crossorigin="anonymous" style="width:100%;height:100%;object-fit:contain;">
                        </div>
                    </div>` : ''}
                    ${event.secondary_image_url ? `<div class="draggable resizable sec-box" style="position:absolute;top:308px;right:175px;width:140px;height:140px;overflow:hidden;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                        <div class="drag-handle"></div><div class="resize-handle"></div><div class="pixel-indicator"></div>
                        <img src="${event.secondary_image_url}" crossorigin="anonymous" style="width:100%;height:100%;object-fit:contain;">
                    </div>` : ''}
                </div>
                <div style="position:absolute;bottom:0;left:0;width:595px;height:70px;background:white;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:0;">
                    <img src="https://www.compassoffices.com/wp-content/uploads/2025/10/poster-footer-1.jpg" crossorigin="anonymous" style="width:100%;height:auto;max-height:100%;object-fit:contain;">
                </div>
            </div>`;
    }

    function generateBannerHTML(event){
        const info = `${formatSimplifiedDate(event.event_date)} | ${formatSimplifiedTime(event.event_time, event.end_time)} | ${event.location.split(',')[0]}`;
        const bg = event.banner_bg_mode === 'same' ? event.content_background_gradient : event.banner_solid_color;
        return `
            <div style="width:600px;height:200px;background:${bg};color:#333;display:flex;align-items:center;padding:30px;box-sizing:border-box;position:relative;border:1px solid #dee2e6;font-family:Arial, sans-serif;">
                <div style="position:absolute;top:15px;left:30px;background:#2d3748;color:white;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:500;">${info}</div>
                <div style="flex:1;padding-right:30px;margin-top:20px;">
                    <div style="font-size:24px;margin-bottom:8px;line-height:1.2;font-weight:bold;color:#333;">${event.banner_title||event.event_title}</div>
                    <p style="font-size:16px;margin:0;line-height:1.4;color:#666;">${event.banner_subtitle||'Join us for an amazing event'}</p>
                </div>
                <div style="width:140px;height:140px;background:#f8f9fa;border-radius:8px;overflow:hidden;border:1px solid #dee2e6;">
                    ${event.image_url ? `<img src="${event.image_url}" crossorigin="anonymous" style="width:100%;height:100%;object-fit:cover;">` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">Image</div>`}
                </div>
            </div>`;
    }

    // === DRAG, RESIZE, SAVE, DOWNLOAD (FIXED IMAGE LOADING) ===
    const GRID_SIZE = 10;
    function snapToGrid(v) { return Math.round(v / GRID_SIZE) * GRID_SIZE; }
    function saveLayout() {
        const pos = {};
        ['descBox', 'infoBox', 'logoBox'].forEach(id => { const el = document.getElementById(id); if (el) pos[id] = { top: el.style.top, left: el.style.left, width: el.style.width, height: el.style.height }; });
        const qr = document.querySelector('.qr-box'); if (qr) pos.qrBox = { top: qr.style.top, right: qr.style.right };
        const sec = document.querySelector('.sec-box'); if (sec) pos.secBox = { top: sec.style.top, right: sec.style.right, width: sec.style.width, height: sec.style.height };
        localStorage.setItem('posterLayout', JSON.stringify(pos));
        showSuccess('Layout saved!');
    }
    function applySavedLayout() {
        const saved = localStorage.getItem('posterLayout');
        if (saved) { const p = JSON.parse(saved); Object.keys(p).forEach(k => { const el = k === 'qrBox' ? document.querySelector('.qr-box') : k === 'secBox' ? document.querySelector('.sec-box') : document.getElementById(k); if (el) { const pos = p[k]; if (pos.top) el.style.top = pos.top; if (pos.left) el.style.left = pos.left; if (pos.width) el.style.width = pos.width; if (pos.height) el.style.height = pos.height; if (pos.right) el.style.right = pos.right; } }); showSuccess('Layout applied!'); }
    }
    function setupSaveLayout() { document.getElementById('saveLayoutBtn').onclick = saveLayout; }

    function makeDraggableAndResizable(){
        document.querySelectorAll('.draggable').forEach(el => {
            let isDragging = false, startX, startY, initLeft, initTop;
            const handle = el.querySelector('.drag-handle') || el;
            const indicator = el.querySelector('.pixel-indicator') || el.appendChild(Object.assign(document.createElement('div'), {className: 'pixel-indicator'}));
            const startDrag = e => { isDragging = true; startX = e.clientX; startY = e.clientY; const r = el.getBoundingClientRect(); const p = el.parentElement.getBoundingClientRect(); initLeft = r.left - p.left; initTop = r.top - p.top; el.style.zIndex = '1000'; indicator.style.opacity = '1'; e.preventDefault(); };
            handle.addEventListener('mousedown', startDrag); el.addEventListener('mousedown', e => { if (e.target === el || e.target.closest('.drag-handle')) startDrag(e); });
            document.addEventListener('mousemove', e => { if (!isDragging) return; const dx = e.clientX - startX, dy = e.clientY - startY; const maxX = el.parentElement.offsetWidth - el.offsetWidth; const maxY = el.parentElement.offsetHeight - el.offsetHeight; const newL = snapToGrid(Math.max(0, Math.min(initLeft + dx, maxX))); const newT = snapToGrid(Math.max(0, Math.min(initTop + dy, maxY))); el.style.left = newL + 'px'; el.style.top = newT + 'px'; if (el.style.right) el.style.right = 'auto'; indicator.textContent = `X: ${newL}px | Y: ${newT}px`; });
            document.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; el.style.zIndex = 'auto'; setTimeout(() => indicator.style.opacity = '0', 500); } });
        });

        document.querySelectorAll('.resizable').forEach(box => {
            let isResizing = false, startX, startY, initW, initH;
            const resizeHandle = box.querySelector('.resize-handle');
            const indicator = box.querySelector('.pixel-indicator') || box.appendChild(Object.assign(document.createElement('div'), {className: 'pixel-indicator'}));
            if (!resizeHandle) return;
            resizeHandle.addEventListener('mousedown', e => { isResizing = true; startX = e.clientX; startY = e.clientY; initW = box.offsetWidth; initH = box.offsetHeight; indicator.style.opacity = '1'; e.preventDefault(); });
            document.addEventListener('mousemove', e => { if (!isResizing) return; const dx = e.clientX - startX, dy = e.clientY - startY; const minW = 200, minH = 80; const newW = snapToGrid(Math.max(minW, initW + dx)); const newH = snapToGrid(Math.max(minH, initH + dy)); const maxW = box.parentElement.offsetWidth - parseFloat(box.style.left || 0) - 50; const maxH = box.parentElement.offsetHeight - parseFloat(box.style.top || 0) - 50; box.style.width = Math.min(newW, maxW) + 'px'; box.style.height = Math.min(newH, maxH) + 'px'; indicator.textContent = `W: ${Math.round(box.offsetWidth)}px | H: ${Math.round(box.offsetHeight)}px`; });
            document.addEventListener('mouseup', () => { if (isResizing) { isResizing = false; setTimeout(() => indicator.style.opacity = '0', 500); } });
        });
    }

    function updatePreviewElements(eventData){
        document.getElementById('posterPreview').innerHTML = generatePosterHTML(eventData);
        document.getElementById('bannerPreview').innerHTML = generateBannerHTML(eventData);
        setTimeout(() => { makeDraggableAndResizable(); applySavedLayout(); }, 100);
    }

    // === FIXED: IMAGE LOADING FOR DOWNLOAD ===
    async function waitForImages(root) {
        const images = Array.from(root.querySelectorAll('img'));
        const promises = images.map(img => new Promise((resolve) => {
            if (img.complete && img.naturalWidth > 0) {
                resolve(true);
            } else {
                const timeout = setTimeout(() => {
                    console.warn('Image load timeout:', img.src);
                    resolve(false);
                }, 8000);

                img.onload = () => { clearTimeout(timeout); resolve(true); };
                img.onerror = () => { clearTimeout(timeout); resolve(false); };

                // Force reload data URLs
                if (img.src.startsWith('data:')) {
                    img.src = img.src; // Re-trigger load
                }
            }
        }));
        return Promise.all(promises);
    }

    async function captureElement(id, name, isPoster = false) {
        const btn = isPoster ? document.getElementById('downloadPoster') : document.getElementById('downloadBanner');
        const orig = btn.innerHTML;
        btn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Generating...'; btn.disabled = true;

        try {
            const el = document.getElementById(id);
            const clone = el.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.left = '-99999px';
            clone.style.top = '0';
            clone.style.transform = 'none';
            clone.style.margin = '0';
            clone.style.boxShadow = 'none';
            clone.querySelectorAll('.grid-overlay, .drag-handle, .resize-handle, .pixel-indicator').forEach(el => el.style.display = 'none');
            document.body.appendChild(clone);

            const root = clone.querySelector('#posterRoot') || clone;
            const width = isPoster ? 595 : 600;
            const height = isPoster ? 843 : 200;
            root.style.width = width + 'px';
            root.style.height = height + 'px';
            root.style.overflow = 'visible';

            // Critical: Re-inject data URLs to ensure rendering
            clone.querySelectorAll('img').forEach(img => {
                if (img.src.startsWith('data:')) {
                    img.src = img.src;
                }
                img.crossOrigin = 'anonymous';
            });

            // Wait for ALL images to load
            await waitForImages(root);

            const scale = isPoster ? (300 / 72) : 4;
            const canvas = await html2canvas(root, {
                scale,
                width,
                height,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                logging: false,
                imageTimeout: 15000,
                removeContainer: false
            });

            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = name; a.click();
                URL.revokeObjectURL(url);
                showSuccess('Downloaded!');
            }, 'image/jpeg', 0.98);

            document.body.removeChild(clone);
        } catch (err) {
            console.error('Capture failed:', err);
            showError('Download failed. Try using public image URLs.');
        } finally {
            btn.innerHTML = orig;
            btn.disabled = false;
        }
    }

    function setupDownloadHandlers(){
        document.getElementById('downloadPoster').onclick = () => captureElement('posterPreview', 'event-poster-a4-300dpi.jpg', true);
        document.getElementById('downloadBanner').onclick = () => captureElement('bannerPreview', 'event-banner-600x200.jpg', false);
    }

    function formatDate(d){if(!d)return'TBD';return new Date(d).toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'short',day:'numeric'});}
    function formatTime(t){if(!t)return'TBD';const[h,m]=t.split(':');const dt=new Date();dt.setHours(+h,+m);return dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});}
    function formatSimplifiedDate(d){if(!d)return'TBD';const dt=new Date(d);return `${dt.getDate()}.${dt.getMonth()+1}.${dt.getFullYear()}`;}
    function formatSimplifiedTime(s,e){if(!s)return'TBD';const f=t=>{const[h,m]=t.split(':');const hr=+h;const ampm=hr>=12?'pm':'am';const dh=hr===0?12:hr>12?hr-12:hr;return m==='00'?`${dh}${ampm}`:`${dh}:${m}${ampm}`;};return e?`${f(s)}-${f(e)}`:f(s);}
    function showSuccess(m){const d=document.createElement('div');d.className='fixed top-4 right-4 px-6 py-3 rounded-lg bg-green-500 text-white font-medium z-50';d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);}
    function showError(m){const d=document.createElement('div');d.className='fixed top-4 right-4 px-6 py-3 rounded-lg bg-red-500 text-white font-medium z-50';d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);}

    document.addEventListener('DOMContentLoaded',()=>{
        initializeApp();
        setupRichTextEditors();
        document.querySelectorAll('#eventForm input, #eventForm select').forEach(i=>{i.addEventListener('input',updateLivePreview);i.addEventListener('change',updateLivePreview);});
        setTimeout(makeDraggableAndResizable,500);
    });
  </script>
 </body>
</html>
