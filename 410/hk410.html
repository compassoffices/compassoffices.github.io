<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link href="https://fonts.cdnfonts.com/css/neue-haas-grotesk-display-pro" rel="stylesheet" />
  <title>Compass Events</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: clamp(11px, 2.8vw, 15px); }
    body {
      width: 100vw;
      min-height: 100vh;
      background-color: #000;
      color: #fff;
      font-family: 'Neue Haas Grotesk Display Pro', sans-serif;
      display: flex;
      flex-direction: column;
      padding: 0 clamp(0.6rem, 4vw, 1.8rem);
      overflow: hidden;
      position: relative;
    }

    .header {
      margin: clamp(1rem, 4vw, 2rem) 0;
      font-size: clamp(3.4rem, 10.5vw, 5.8rem);
      line-height: 1;
      font-weight: 700;
    }
    .header-upcoming { font-weight: 400; }

    .event-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      position: relative;
    }

    .event-card, .slideshow-card {
      width: 100%;
      min-height: clamp(380px, 70vh, 600px);
      background: #fff;
      color: #000;
      border-radius: clamp(1.4rem, 5.5vw, 3rem);
      overflow: hidden;
      box-shadow: 0 16px 60px rgba(255,255,255,0.09);
      display: flex;
      flex-direction: column;
    }

    .img-container {
      position: relative;
      height: clamp(170px, 36vh, 290px);
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      overflow: hidden;
      border-radius: clamp(1.4rem, 5.5vw, 3rem) clamp(1.4rem, 5.5vw, 3rem) 0 0;
    }
    .img-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* BIGGER BOX-SHAPED DATE */
    .date {
      position: absolute;
      top: clamp(1.2rem, 4vw, 2rem);
      right: clamp(1.2rem, 4vw, 2rem);
      width: clamp(9rem, 28vw, 13rem);
      height: clamp(9rem, 28vw, 13rem);
      background: linear-gradient(to bottom right, rgba(255,102,0,0.85), rgba(255,140,0,0.6));
      color: #fff;
      font-size: clamp(2.8rem, 9vw, 4.8rem);
      font-weight: 700;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: clamp(1rem, 3vw, 1.6rem);
      border: 3px solid rgba(255,255,255,0.25);
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      line-height: 1.1;
      text-align: center;
    }

    .event-title {
      padding: clamp(1.6rem, 5.5vw, 2.6rem);
      font-size: clamp(2.3rem, 7vw, 3.8rem);
      line-height: 1.18;
      font-weight: 700;
      flex-grow: 1;
      display: -webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .event-details {
      padding: 0 clamp(1.4rem, 5vw, 2.4rem) clamp(1.6rem, 5.5vw, 2.6rem);
    }

    /* ICON-ONLY + NOT BOLD */
    .event-time,
    .event-location,
    .event-client {
      font-size: clamp(1.8rem, 5.4vw, 2.9rem);
      line-height: 1.4;
      margin-bottom: clamp(0.8rem, 2.5vw, 1.3rem);
      display: flex;
      align-items: center;
      font-weight: 500; /* NOT bold */
    }
    .event-time span,
    .event-location span,
    .event-client span {
      margin-right: clamp(1rem, 3.5vw, 1.6rem);
      font-size: clamp(2rem, 6vw, 3rem);
    }

    /* SLIDESHOW */
    .slideshow-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .slideshow-card {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }
    .slideshow-card.active { opacity: 1; }

    .bottom-section {
      position: absolute;
      bottom: clamp(0.8rem, 3vw, 1.6rem);
      left: clamp(0.8rem, 3vw, 1.6rem);
      right: clamp(0.8rem, 3vw, 1.6rem);
      background: rgba(0,0,0,0.96);
      padding: clamp(1.4rem, 5.5vw, 2.6rem);
      border-top: 1.5px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: clamp(80px, 15vh, 140px);
    }
    .follow {
      font-size: clamp(2.6rem, 9vw, 5.2rem);
      line-height: 1.1;
      font-weight: 500;
    }
    .qr-code img {
      width: clamp(80px, 28vw, 150px);
      height: clamp(80px, 28vw, 150px);
    }

    .loading, .error-message {
      font-size: clamp(1.8rem, 5.5vw, 2.8rem);
      text-align: center;
      padding: 2rem;
    }
    .error-message {
      background: #300;
      color: #ff4d4d;
      border-radius: 1.4rem;
      padding: 1.8rem;
    }

    @media (max-width: 500px) {
      .header { font-size: clamp(3rem, 9.5vw, 4.8rem); }
      .date { width: clamp(8rem, 26vw, 11rem); height: clamp(8rem, 26vw, 11rem); }
    }
  </style>
</head>
<body>
  <div class="header">
    <span id="header-upcoming" class="header-upcoming">Loading </span>
    <span id="header-events" class="header-events">Event</span>
  </div>

  <div id="eventContainer" class="event-container">
    <div class="loading">Loading events...</div>
  </div>

  <div class="bottom-section">
    <div class="follow">Follow Us for<br />more updates</div>
    <div class="qr-code">
      <img src="https://cdn.glitch.global/d3825f09-16b9-42c5-aed8-ef674a7a82c1/linkedtre-qr.png?v=1747650115477" alt="QR Code" />
    </div>
  </div>

  <script>
    const spreadsheetId = '1vTazGFKOEPVQu77BpCHV9rTo8odUfVeH7_k0xLjio7V4bUXw__hk14JMBJu0iDC3MewNy8Hw3kowOJt';
    const gid = '1632866699';
    const csvUrlDirect = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
    const csvUrlPublished = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTazGFKOEPVQu77BpCHV9rTo8odUfVeH7_k0xLjio7V4bUXw__hk14JMBJu0iDC3MewNy8Hw3kowOJt/pub?gid=1632866699&single=true&output=csv';
    const imageCsvUrlPublished = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIVKI_E2fEjdS6XT0GjkgvwqU2UBTIjVXBy8zUMWplk4984UFbXULf0bSZK2vhkkeG6k4LFimALywt/pub?gid=0&single=true&output=csv';

    const sampleData = [
      { Time: '12:00–17:00', Date: '16/10/2025', 'Client-Name': 'PURE Fitness', Region: 'Hong Kong', 'Event-Name': 'Wellness Booth Event', Location: 'China Building, 18 & 19F' },
      { Time: '14:00–18:00', Date: '17/10/2025', 'Client-Name': 'Tech Corp', Region: 'Hong Kong', 'Event-Name': 'Innovation Summit', Location: 'Convention Centre, Hall 3' }
    ];

    let imageData = [];

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"' && inQuotes && line[i+1] === '"') { current += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }
        if (c === ',' && !inQuotes) { result.push(current.trim()); current = ''; continue; }
        current += c;
      }
      if (current) result.push(current.trim());
      return result;
    }
    function parseCSV(text) {
      const lines = text.split('\n');
      const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g,''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const vals = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((h, idx) => row[h] = vals[idx] ? vals[idx].trim() : '');
          data.push(row);
        }
      }
      return data;
    }

    function parseDate(str) {
      if (!str) return null;
      const m = str.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
      if (m) return new Date(m[3], m[2]-1, m[1]);
      const d = new Date(str);
      return isNaN(d) ? null : d;
    }
    function formatDateToBox(d) {
      const day = ('0'+d.getDate()).slice(-2);
      const month = d.toLocaleString('en-GB', {month:'short'});
      return day + '<br>' + month.toUpperCase();
    }
    function isToday(d) {
      const t = new Date(); t.setHours(0,0,0,0);
      const e = new Date(d); e.setHours(0,0,0,0);
      return e.getTime() === t.getTime();
    }
    function getRandomGradient() {
      const g = [
        'linear-gradient(45deg, #ff6b6b, #4ecdc4)',
        'linear-gradient(45deg, #1e90ff, #ff6347)',
        'linear-gradient(45deg, #ffcc00, #ff69b4)',
        'linear-gradient(45deg, #32cd32, #00ced1)',
        'linear-gradient(45deg, #9370db, #ffb6c1)'
      ];
      return g[Math.floor(Math.random()*g.length)];
    }

    async function loadImageData() {
      try {
        const r = await fetch(imageCsvUrlPublished, {mode:'cors'});
        if (r.ok) imageData = parseCSV(await r.text());
      } catch(e) { imageData = []; }
    }

    function createCard(event) {
      const card = document.createElement('div');
      card.className = 'event-card';

      const imgCont = document.createElement('div');
      imgCont.className = 'img-container';

      const match = imageData.find(i =>
        i['Event name']?.toLowerCase() === event['Event-Name']?.toLowerCase() &&
        i['Client Name']?.toLowerCase() === event['Client-Name']?.toLowerCase() &&
        i['Date'] === event.Date
      );
      if (match && match['image url']) {
        const img = document.createElement('img');
        img.src = match['image url'];
        img.alt = event['Event-Name'];
        img.onerror = () => imgCont.style.background = getRandomGradient();
        imgCont.appendChild(img);
      } else {
        imgCont.style.background = getRandomGradient();
      }

      const dateBox = document.createElement('div');
      dateBox.className = 'date';
      dateBox.innerHTML = formatDateToBox(event.parsedDate);
      imgCont.appendChild(dateBox);

      const title = document.createElement('div');
      title.className = 'event-title';
      title.textContent = event['Event-Name'] || 'Untitled Event';

      const details = document.createElement('div');
      details.className = 'event-details';
      details.innerHTML = `
        <div class="event-time"><span>Time</span>${event.Time || 'TBD'}</div>
        <div class="event-client"><span>Client</span>${event['Client-Name'] || '—'}</div>
        <div class="event-location"><span>Location</span>${event.Location || 'TBD'}</div>
      `;

      card.append(imgCont, title, details);
      return card;
    }

    async function loadEvents() {
      let data = sampleData;
      try {
        let r = await fetch(csvUrlDirect, {mode:'cors'});
        if (!r.ok) r = await fetch(csvUrlPublished, {mode:'cors'});
        if (r.ok) data = parseCSV(await r.text());
      } catch(e) {
        document.getElementById('eventContainer').innerHTML = '<div class="error-message">Using sample data</div>';
      }

      await loadImageData();

      const today = new Date(); today.setHours(0,0,0,0);
      const events = data
        .map(e => ({...e, parsedDate: parseDate(e.Date)}))
        .filter(e => e.parsedDate && e.Region?.toLowerCase().includes('hong kong') && e.parsedDate >= today)
        .sort((a,b) => a.parsedDate - b.parsedDate);

      const c = document.getElementById('eventContainer');
      const hUp = document.getElementById('header-upcoming');
      const hEv = document.getElementById('header-events');

      if (events.length === 0) {
        c.innerHTML = '<div class="loading">No upcoming events in Hong Kong.</div>';
        hUp.textContent = 'No ';
        return;
      }

      const firstDate = events[0].parsedDate;
      const sameDay = events.filter(e => e.parsedDate.getTime() === firstDate.getTime());
      const todayEv = isToday(firstDate);

      hUp.textContent = todayEv ? 'Today ' : 'Upcoming ';
      hEv.textContent = sameDay.length > 1 ? 'Events' : 'Event';

      c.innerHTML = '';

      if (sameDay.length === 1) {
        c.appendChild(createCard(sameDay[0]));
      } else {
        const slide = document.createElement('div');
        slide.className = 'slideshow-container';
        sameDay.forEach((ev, i) => {
          const card = createCard(ev);
          card.classList.add('slideshow-card');
          if (i===0) card.classList.add('active');
          slide.appendChild(card);
        });
        c.appendChild(slide);

        let i = 0;
        setInterval(() => {
          document.querySelectorAll('.slideshow-card').forEach(x => x.classList.remove('active'));
          i = (i + 1) % sameDay.length;
          document.querySelectorAll('.slideshow-card')[i].classList.add('active');
        }, 5000);
      }
    }

    document.addEventListener('DOMContentLoaded', loadEvents);
  </script>
</body>
</html>
