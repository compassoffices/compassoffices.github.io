<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event Display</title>
  <link href="https://fonts.cdnfonts.com/css/neue-haas-grotesk-display-pro" rel="stylesheet" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html,body { width:1280px; height:800px; overflow:hidden; font-family:'Neue Haas Grotesk Display Pro',sans-serif; }
    
    /* Full-screen event image — SHARP, NO BLUR, NO DARKENING */
    body {
      background:#000 url('') center center / cover no-repeat;
      position:relative;
      color:white;
      transition:background 0.8s ease-in-out;
    }

    /* Text boxes with glass effect (blur behind text only) */
    .top-left {
      position:absolute; top:2rem; left:2rem; z-index:10;
      background:rgba(0,0,0,0.6); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
      padding:1.5rem 2rem; border-radius:1rem; max-width:500px;
      box-shadow:0 4px 20px rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.2);
    }
    .location { font-size:2.6rem; font-weight:600; margin-bottom:1rem; }
    .time     { font-size:2.2rem; font-weight:400; }

    .top-right-wrapper {
      position:absolute; top:2rem; right:2rem; z-index:10;
      display:flex; align-items:flex-start; gap:0.5rem;
    }
    .qr-box {
      background:rgba(0,0,0,0.6); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
      padding:1rem; border-radius:1rem; width:140px; height:180px;
      display:flex; flex-direction:column; align-items:center; justify-content:space-between;
      border:1px solid rgba(255,255,255,0.2); box-shadow:0 4px 20px rgba(0,0,0,0.4);
      animation:float 3s ease-in-out infinite;
    }
    .qr-box img { width:100px; height:100px; border-radius:0.5rem; object-fit:cover; }
    .qr-label { font-size:0.9rem; text-align:center; color:#fff; line-height:1rem; }

    .date-box {
      width:12rem; height:12rem;
      background:linear-gradient(to right,rgba(255,102,0,0.6),rgba(255,140,0,0.3));
      backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
      border-radius:1rem; border:1px solid rgba(255,255,255,0.2);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.3);
      font-size:4rem; font-weight:700; line-height:4.2rem; color:white;
    }

    @keyframes float { 0%{transform:translateY(0)} 50%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
  </style>
</head>
<body>

  <!-- Top Left: Location & Time (no labels) -->
  <div class="top-left">
    <div class="location" id="event-location">Loading...</div>
    <div class="time"     id="event-time">Loading...</div>
  </div>

  <!-- Top Right: QR + Date -->
  <div class="top-right-wrapper">
    <div class="qr-box">
      <img src="https://cdn.glitch.global/d3825f09-16b9-42c5-aed8-ef674a7a82c1/linkedtre-qr.png?v=1747650115477" alt="QR Code" />
      <div class="qr-label">Scan to follow<br>Compass Offices</div>
    </div>
    <div class="date-box" id="event-date">--</div>
  </div>

  <script>
    // --------------------------------------------------------------
    // 1. CSV parser
    // --------------------------------------------------------------
    function parseCSV(str) {
      const rows = [];
      let row = [], field = '', inQuotes = false;
      for (let i = 0; i < str.length; i++) {
        const c = str[i], next = str[i+1];
        if (c === '"' && !inQuotes) { inQuotes = true; continue; }
        if (c === '"' && inQuotes && next === '"') { field += '"'; i++; continue; }
        if (c === '"' && inQuotes) { inQuotes = false; continue; }
        if (c === ',' && !inQuotes) { row.push(field.trim()); field = ''; }
        else if ((c === '\r' || c === '\n') && !inQuotes) {
          if (field !== '' || row.length) { row.push(field.trim()); rows.push(row); row = []; field = ''; }
          if (c === '\r' && next === '\n') i++;
        } else field += c;
      }
      if (field !== '' || row.length) { row.push(field.trim()); rows.push(row); }
      return rows;
    }

    // --------------------------------------------------------------
    // 2. Format DD-MM → 12 NOV
    // --------------------------------------------------------------
    const monthNames = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    function formatDateParts(dateStr) {
      const [d, m] = dateStr.split('-').map(Number);
      return { day: String(d).padStart(2,'0'), monthText: monthNames[m-1] };
    }

    // --------------------------------------------------------------
    // 3. Find next upcoming event (date >= today)
    // --------------------------------------------------------------
    function findNextEvent(rows) {
      if (rows.length < 2) return null;
      const headers = rows[0].map(h => h.trim().toLowerCase());
      const idx = {
        loc:   headers.indexOf('location'),
        date:  headers.indexOf('date'),
        time:  headers.indexOf('time'),
        image: headers.indexOf('image')
      };
      if (idx.loc === -1 || idx.date === -1 || idx.time === -1) return null;

      const today = new Date();
      today.setHours(0,0,0,0);

      let next = null, nextDiff = Infinity;

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        if (r.length < 4) continue;
        const rawDate = r[idx.date].trim();
        const [d,m] = rawDate.split('-').map(Number);
        if (!d || !m) continue;
        const evDate = new Date(today.getFullYear(), m-1, d);
        const diff = evDate - today;
        if (diff >= 0 && diff < nextDiff) {
          nextDiff = diff;
          next = {
            location: r[idx.loc].trim(),
            time:     r[idx.time].trim(),
            image:    (idx.image !== -1 ? r[idx.image].trim() : ''),
            dateParts: formatDateParts(rawDate)
          };
        }
      }
      return next;
    }

    // --------------------------------------------------------------
    // 4. Render (no labels, no blur, no dark overlay)
    // --------------------------------------------------------------
    function render(event) {
      const locEl  = document.getElementById('event-location');
      const timeEl = document.getElementById('event-time');
      const dateEl = document.getElementById('event-date');

      if (!event) {
        locEl.textContent  = 'No upcoming event';
        timeEl.textContent = '—';
        dateEl.innerHTML   = '--';
        document.body.style.backgroundImage = 'url("")';
        return;
      }

      locEl.textContent  = event.location;
      timeEl.textContent = event.time;
      dateEl.innerHTML   = `${event.dateParts.day}<br>${event.dateParts.monthText}`;

      // Set full-screen background — SHARP & BRIGHT
      if (event.image) {
        document.body.style.backgroundImage = `url('${event.image}')`;
      } else {
        document.body.style.backgroundImage = 'url("")';
      }
    }

    // --------------------------------------------------------------
    // 5. Load CSV (public link)
    // --------------------------------------------------------------
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQipx6p43dqkFXUkcT8O6YGAiqs_dlSJUvBZ5538JjEA0PFg47z1Tw0GVqn3apA2cp-LI54XO2sNaqZ/pub?gid=0&single=true&output=csv";

    fetch(csvUrl, { cache: "no-store" })
      .then(r => { if (!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(csv => render(findNextEvent(parseCSV(csv))))
      .catch(err => {
        console.error('Load error:', err);
        document.getElementById('event-location').textContent = 'Error loading data';
        document.getElementById('event-time').textContent     = '—';
        document.getElementById('event-date').innerHTML       = '--';
        document.body.style.backgroundImage = 'url("")';
      });
  </script>
</body>
</html>
