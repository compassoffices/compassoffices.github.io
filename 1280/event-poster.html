<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event Display - Compass Offices</title>
  <link href="https://fonts.cdnfonts.com/css/neue-haas-grotesk-display-pro" rel="stylesheet" />
  <style>
    /* FORCE EXACT 1280x800 - NO SCROLL, NO ZOOM, NO RESIZE */
    html, body {
      margin:0; padding:0; overflow:hidden;
      width:1280px !important; height:800px !important;
      font-family:'Neue Haas Grotesk Display Pro',sans-serif;
      background:#000; color:#fff;
    }
    body {
      position:fixed; top:0; left:0;
      transform-origin:0 0;
    }

    /* Full-screen sharp background */
    #bg {
      position:fixed; top:0; left:0; width:1280px; height:800px;
      background:#000 center center / cover no-repeat;
      z-index:1; transition:background 0.8s ease-in-out;
    }

    /* Glass boxes - solid fallback for old browsers */
    .box {
      background:rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:1rem; box-shadow:0 4px 20px rgba(0,0,0,0.4);
      padding:1.5rem 2rem; backdrop-filter:blur(6px);
    }
    .top-left {
      position:absolute; top:32px; left:32px; z-index:10; max-width:500px;
    }
    .location { font-size:2.6rem; font-weight:600; margin-bottom:1rem; }
    .time { font-size:2.2rem; font-weight:400; }

    .top-right {
      position:absolute; top:32px; right:32px; z-index:10;
    }
    .qr-box {
      background:rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.2);
      border-radius:1rem; padding:1rem; width:140px; height:180px;
      text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.4);
      animation:float 3s ease-in-out infinite; margin-bottom:16px;
    }
    .qr-box img { width:100px; height:100px; border-radius:8px; }
    .qr-label { font-size:0.9rem; line-height:1; margin-top:8px; display:block; }

    .date-box {
      width:192px; height:192px;
      background:linear-gradient(to right,rgba(255,102,0,0.6),rgba(255,140,0,0.3));
      border:1px solid rgba(255,255,255,0.2); border-radius:1rem;
      display:table-cell; vertical-align:middle; text-align:center;
      font-size:4rem; font-weight:700; line-height:1;
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    .date-inner { display:table; width:100%; height:100%; }
    .date-inner span { display:table-cell; vertical-align:middle; }

    @keyframes float {
      0%,100% { transform:translateY(0); }
      50% { transform:translateY(-8px); }
    }

    /* Table layout for old browsers */
    .top-right table { border-spacing:16px 0; }
  </style>
</head>
<body>

  <div id="bg"></div>

  <!-- TOP LEFT: Location & Time -->
  <div class="top-left box">
    <div class="location" id="loc">Loading...</div>
    <div class="time" id="time">Loading...</div>
  </div>

  <!-- TOP RIGHT: QR + Date -->
  <div class="top-right">
    <table><tr>
      <td>
        <div class="qr-box">
          <img src="https://cdn.glitch.global/d3825f09-16b9-42c5-aed8-ef674a7a82c1/linkedtre-qr.png?v=1747650115477" alt="QR" />
          <span class="qr-label">Scan to follow<br>Compass Offices</span>
        </div>
      </td>
      <td>
        <div class="date-box">
          <div class="date-inner"><span id="date">--<br>--</span></div>
        </div>
      </td>
    </tr></table>
  </div>

  <script>
    // CSV Parser - works in IE9+
    function parseCSV(t) {
      var rows=[],row=[],f='',q=0,i,c,n;
      for(i=0;i<t.length;i++){
        c=t[i];n=t[i+1];
        if(c==='"'&&q===0)q=1;
        else if(c==='"'&&q===1&&n==='"'){f+='"';i++;continue;}
        else if(c==='"'&&q===1)q=0;
        else if(c===','&&q===0){row.push(f.trim());f='';}
        else if((c==='\r'||c==='\n')&&q===0){
          if(f||row.length)row.push(f.trim());
          if(row.length)rows.push(row);
          row=[];f='';
          if(c==='\r'&&n==='\n')i++;
        }else f+=c;
      }
      if(f||row.length){row.push(f.trim());rows.push(row);}
      return rows;
    }

    // Format DD-MM → 09 NOV
    var months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    function fmt(d){
      var p=d.split('-');
      return {day:p[0],month:months[parseInt(p[1])-1]};
    }

    // Find next event
    function nextEvent(rows){
      if(rows.length<2)return null;
      var h=rows[0],i;
      for(i=0;i<h.length;i++)h[i]=h[i].trim().toLowerCase();
      var col={loc:h.indexOf('location'),date:h.indexOf('date'),time:h.indexOf('time'),img:h.indexOf('image')};
      if(col.loc<0||col.date<0||col.time<0)return null;

      var today=new Date(), now=today.getTime();
      today.setHours(0,0,0,0);
      var best=null, diff=1e15;

      for(i=1;i<rows.length;i++){
        var r=rows[i];
        if(r.length<3)continue;
        var ds=r[col.date].trim();
        var dp=ds.split('-');
        var ed=new Date(today.getFullYear(),parseInt(dp[1])-1,parseInt(dp[0]));
        var d=ed-today;
        if(d>=0 && d<diff){
          diff=d;
          best={
            loc:r[col.loc].trim(),
            time:r[col.time].trim(),
            img:(col.img>=0?r[col.img].trim():''),
            date:fmt(ds)
          };
        }
      }
      return best;
    }

    // Render
    function show(e){
      document.getElementById('loc').innerHTML = e?e.loc:'No upcoming event';
      document.getElementById('time').innerHTML = e?e.time:'—';
      document.getElementById('date').innerHTML = e?(e.date.day+'<br>'+e.date.month):'--';
      document.getElementById('bg').style.backgroundImage = e&&e.img?'url("'+e.img+'")':'url("")';
    }

    // Load CSV (IE11+ compatible)
    function load(){
      var url="https://docs.google.com/spreadsheets/d/e/2PACX-1vQipx6p43dqkFXUkcT8O6YGAiqs_dlSJUvBZ5538JjEA0PFg47z1Tw0GVqn3apA2cp-LI54XO2sNaqZ/pub?gid=0&single=true&output=csv";
      var x=new XMLHttpRequest();
      x.onreadystatechange=function(){
        if(x.readyState===4){
          if(x.status===200){
            var ev=nextEvent(parseCSV(x.responseText));
            show(ev);
          }else{
            document.getElementById('loc').innerHTML='Error loading events';
          }
        }
      };
      x.open('GET',url+'&t='+new Date().getTime(),true);
      x.send();
    }

    // Start + Auto-refresh every 5 minutes
    load();
    setInterval(load,300000);
  </script>
</body>
</html>
